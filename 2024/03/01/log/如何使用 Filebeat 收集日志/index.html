<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"eleven26.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Filebeat 是一款功能强大的日志传送器，旨在简化从不同来源收集、处理和转发日志到不同目的地的过程。Filebeat 在开发时充分考虑了效率，可确保日志管理无缝且可靠。它的轻量级特性和处理大量数据的能力使其成为开发人员和系统管理员的首选。 在本综合指南中，您将深入探索 Filebeat 的功能。从基础知识开始，您将设置 Filebeat 以从各种来源收集日志。然后，您将深入研究高效处理这些日志">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用 Filebeat 收集日志">
<meta property="og:url" content="https://eleven26.github.io/2024/03/01/log/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20Filebeat%20%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/index.html">
<meta property="og:site_name" content="eleven26">
<meta property="og:description" content="Filebeat 是一款功能强大的日志传送器，旨在简化从不同来源收集、处理和转发日志到不同目的地的过程。Filebeat 在开发时充分考虑了效率，可确保日志管理无缝且可靠。它的轻量级特性和处理大量数据的能力使其成为开发人员和系统管理员的首选。 在本综合指南中，您将深入探索 Filebeat 的功能。从基础知识开始，您将设置 Filebeat 以从各种来源收集日志。然后，您将深入研究高效处理这些日志">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://eleven26.github.io/images/filebeat/filebeatvslogstash-min.png">
<meta property="og:image" content="https://eleven26.github.io/images/filebeat/1-min.png">
<meta property="article:published_time" content="2024-03-01T13:28:30.000Z">
<meta property="article:modified_time" content="2024-03-02T02:49:22.000Z">
<meta property="article:author" content="eleven26">
<meta property="article:tag" content="Filebeat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eleven26.github.io/images/filebeat/filebeatvslogstash-min.png">


<link rel="canonical" href="https://eleven26.github.io/2024/03/01/log/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20Filebeat%20%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://eleven26.github.io/2024/03/01/log/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20Filebeat%20%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/","path":"2024/03/01/log/如何使用 Filebeat 收集日志/","title":"如何使用 Filebeat 收集日志"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>如何使用 Filebeat 收集日志 | eleven26</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">eleven26</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">100</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">346</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">2.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E6%BC%94%E7%A4%BA%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">3.</span> <span class="nav-text">开发演示日志记录应用程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-filebeat"><span class="nav-number">4.</span> <span class="nav-text">安装 Filebeat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">Filebeat 的工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat-%E8%BE%93%E5%85%A5%E6%8F%92%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text">Filebeat 输入插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat-%E8%BE%93%E5%87%BA%E6%8F%92%E4%BB%B6"><span class="nav-number">7.</span> <span class="nav-text">Filebeat 输出插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat-%E6%A8%A1%E5%9D%97%E6%8F%92%E4%BB%B6"><span class="nav-number">8.</span> <span class="nav-text">Filebeat 模块插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat-%E5%85%A5%E9%97%A8"><span class="nav-number">9.</span> <span class="nav-text">Filebeat 入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-filebeat-%E8%BD%AC%E6%8D%A2%E6%97%A5%E5%BF%97"><span class="nav-number">10.</span> <span class="nav-text">使用 Filebeat 转换日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-filebeat-%E8%A7%A3%E6%9E%90-json-%E6%97%A5%E5%BF%97"><span class="nav-number">11.</span> <span class="nav-text">使用 Filebeat 解析 JSON 日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-filebeat-%E6%B7%BB%E5%8A%A0%E5%92%8C%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5"><span class="nav-number">12.</span> <span class="nav-text">使用 Filebeat 添加和删除字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8-filebeat-%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5"><span class="nav-number">13.</span> <span class="nav-text">在 Filebeat 中使用条件语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-filebeat-%E7%BC%96%E8%BE%91%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE"><span class="nav-number">14.</span> <span class="nav-text">使用 Filebeat 编辑敏感数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">15.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">eleven26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eleven26" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eleven26" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/03/01/log/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20Filebeat%20%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="如何使用 Filebeat 收集日志 | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          如何使用 Filebeat 收集日志
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-01 21:28:30" itemprop="dateCreated datePublished" datetime="2024-03-01T21:28:30+08:00">2024-03-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Filebeat
是一款功能强大的日志传送器，旨在简化从不同来源收集、处理和转发日志到不同目的地的过程。Filebeat
在开发时充分考虑了效率，可确保日志管理无缝且可靠。它的轻量级特性和处理大量数据的能力使其成为开发人员和系统管理员的首选。</p>
<p>在本综合指南中，您将深入探索 Filebeat
的功能。从基础知识开始，您将设置 Filebeat
以从各种来源收集日志。然后，您将深入研究高效处理这些日志的复杂性，从
Docker 容器收集日志并将其转发到不同的目标进行分析和监视。</p>
<h2 id="前言">前言</h2>
<p>在上一篇文章<a
target="_blank" rel="noopener" href="https://blog.baiguiren.com/2024/03/01/log/Filebeat%20vs%20Logstash:%20%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%B7%A5%E5%85%B7%E5%AF%B9%E6%AF%94/">《Filebeat
vs Logstash：日志采集工具对比》</a>中，我们对比了 Filebeat 和 Logstash
的一些优缺点，下面是一份简介版的总结：</p>
<p><img src="/images/filebeat/filebeatvslogstash-min.png" /></p>
<p>我们可以看到，<strong>我们选择 Filebeat
一方面是因为它占用资源少，另外一方面是我们不需要对日志做复杂的处理，同时也不需要将日志发送到多个目的地。</strong></p>
<h2 id="环境准备">环境准备</h2>
<p>创建用以测试的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir log-processing-stack</span><br><span class="line">cd log-processing-stack</span><br></pre></td></tr></table></figure>
<p>为演示应用程序创建一个子目录并移动到该目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir logify &amp;&amp; cd logify</span><br></pre></td></tr></table></figure>
<p>完成这些步骤后，您可以在下一节中创建演示日志记录应用程序。</p>
<h2 id="开发演示日志记录应用程序">开发演示日志记录应用程序</h2>
<p>在本节中，你将使用 Bash
脚本语言构建一个基本的日志记录应用程序。应用程序将定期生成日志，模拟应用程序生成日志数据的真实场景。</p>
<p>在 <code>logify</code> 目录中，创建一个名为 <code>logify.sh</code>
的文件，并将以下内容添加到文件中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">filepath=&quot;/var/log/logify/app.log&quot;</span><br><span class="line"></span><br><span class="line">create_log_entry() &#123;</span><br><span class="line">    local info_messages=(&quot;Connected to database&quot; &quot;Task completed successfully&quot; &quot;Operation finished&quot; &quot;Initialized application&quot;)</span><br><span class="line">    local random_message=$&#123;info_messages[$RANDOM % $&#123;#info_messages[@]&#125;]&#125;</span><br><span class="line">    local http_status_code=200</span><br><span class="line">    local ip_address=&quot;127.0.0.1&quot;</span><br><span class="line">    local emailAddress=&quot;user@mail.com&quot;</span><br><span class="line">    local level=30</span><br><span class="line">    local pid=$$</span><br><span class="line">    local time=$(date +%s)</span><br><span class="line">    local log=&#x27;&#123;&quot;status&quot;: &#x27;$http_status_code&#x27;, &quot;ip&quot;: &quot;&#x27;$ip_address&#x27;&quot;, &quot;level&quot;: &#x27;$level&#x27;, &quot;emailAddress&quot;: &quot;&#x27;$emailAddress&#x27;&quot;, &quot;msg&quot;: &quot;&#x27;$random_message&#x27;&quot;, &quot;pid&quot;: &#x27;$pid&#x27;, &quot;timestamp&quot;: &#x27;$time&#x27;&#125;&#x27;</span><br><span class="line">    echo &quot;$log&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while true; do</span><br><span class="line">    log_record=$(create_log_entry)</span><br><span class="line">    echo &quot;$&#123;log_record&#125;&quot; &gt;&gt; &quot;$&#123;filepath&#125;&quot;</span><br><span class="line">    sleep 3</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p><code>create_log_entry()</code> 函数以 JSON
格式生成日志记录，包含严重性级别、消息、HTTP
状态代码和其他关键字段等基本详细信息。此外，它还包括敏感字段，例如电子邮件地址、和
IP 地址，这些字段是特意包含的，以展示 Filebeat
屏蔽字段中敏感数据的能力。</p>
<p>接下来，程序进入无限循环，重复调用 <code>create_log_entry()</code>
函数并将日志写入 <code>/var/log/logify</code> 目录中的指定文件。</p>
<p>添加完代码后，保存更改并使脚本可执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x logify.sh</span><br></pre></td></tr></table></figure>
<p>然后，创建 <code>/var/log/logify</code>
用于存储应用程序日志的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /var/log/logify</span><br></pre></td></tr></table></figure>
<p>接下来，使用 <code>$USER</code> 环境变量将
<code>/var/log/logify</code> 目录的所有权分配给当前登录的用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $USER:$USER /var/log/logify/</span><br></pre></td></tr></table></figure>
<p>在后台运行 <code>logify.sh</code> 脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./logify.sh &amp;</span><br></pre></td></tr></table></figure>
<p>命令末尾的 <code>&amp;</code>
符号指示脚本在后台运行，允许您在日志记录应用程序独立运行时继续使用终端执行其他任务。</p>
<p>当程序启动时，它将显示如下所示的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1] 91773</span><br></pre></td></tr></table></figure>
<p>此处表示 <code>91773</code> 进程 ID，如果需要，该 ID
可用于稍后终止脚本。</p>
<p>若要查看 <code>app.log</code> 文件的内容，可以使用以下
<code>tail</code> 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -n 4 /var/log/logify/app.log</span><br></pre></td></tr></table></figure>
<p>此命令以 JSON 格式显示 <code>app.log</code> 文件中的最后 4
个日志条目：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connected to database&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286422</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286425</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286428</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Operation finished&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286431</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>现在，您已成功创建用于生成示例日志条目的日志记录应用程序。</p>
<h2 id="安装-filebeat">安装 Filebeat</h2>
<p>我的系统是 MacOS，所以执行下面的命令即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.12.2-darwin-x86_64.tar.gz</span><br><span class="line">tar xzvf filebeat-8.12.2-darwin-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
<p>最后，进入 <code>filebeat</code> 目录下去执行 <code>filebeat</code>
命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd filebeat-8.12.2-darwin-x86_64</span><br><span class="line">./filebeat version</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebeat version 8.12.2 (amd64), libbeat 8.12.2 [0b71acf2d6b4cb6617bff980ed6caf0477905efa built 2024-02-15 13:39:16 +0000 UTC]</span><br></pre></td></tr></table></figure>
<h2 id="filebeat-的工作原理">Filebeat 的工作原理</h2>
<p>在开始使用 Filebeat
之前，了解其工作原理至关重要。在本节中，我们将探讨其基本组件和流程，确保您在深入研究实际使用之前有一个坚实的基础：</p>
<p><img src="/images/filebeat/1-min.png" /></p>
<p>要了解 Filebeat 的工作原理，主要需要熟悉以下组件：</p>
<ul>
<li><strong>收割机(Harvesters)</strong>，收割机负责逐行读取文件的内容。当
Filebeat
配置为监控特定日志文件时，会为每个文件启动一个收集器。这些收割机不仅可以读取日志数据，还可以管理打开和关闭文件。通过逐行增量读取文件，收集器可确保有效地收集新附加的日志数据并转发以进行处理。</li>
<li><strong>输入(Inputs)</strong>：输入充当收割机和数据源之间的桥梁。他们负责管理收割机并找到
Filebeat
需要从中读取日志数据的所有来源。可以为各种源（例如日志文件、容器或系统日志）配置输入。用户可以通过定义输入来指定
Filebeat 应监控的文件或位置。</li>
</ul>
<p>Filebeat
读取日志数据后，日志事件将进行转换或使用数据进行扩充。最后发送到指定的目的地。</p>
<p>可以在 <code>filebeat.yml</code> 配置文件中指定以下行为：</p>
<blockquote>
<p>我们可以在下载的目录中看到有一个 <code>filebeat.yml</code>
的配置文件。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line">  <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="attr">output.plugin_name:</span></span><br><span class="line">   <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br></pre></td></tr></table></figure>
<p>现在让我们详细研究每个部分：</p>
<ul>
<li><code>filebeat.inputs</code>：Filebeat 实例应监控的输入源。</li>
<li><code>processors</code>：在将数据发送到输出之前对其进行扩充、修改或筛选。</li>
<li><code>output.plugin_name</code>：Filebeat
应转发日志数据的输出目标。</li>
</ul>
<p>这些指令中的每一个都要求您指定一个执行其相应任务的插件。</p>
<p>现在，让我们来探讨一些可以与 Filebeat
一起使用的输入、处理器和输出。</p>
<h2 id="filebeat-输入插件">Filebeat 输入插件</h2>
<p>Filebeat
提供了一系列输入插件，每个插件都经过定制，用于从特定来源收集日志数据：</p>
<ul>
<li><code>container</code>：收集容器日志。</li>
<li><code>filestream</code>：主动从日志文件中读取行。</li>
<li><code>syslog</code>：从 Syslog 中获取日志条目。</li>
<li><code>httpjson</code>：从 RESTful API 读取日志消息。</li>
</ul>
<h2 id="filebeat-输出插件">Filebeat 输出插件</h2>
<p>Filebeat
提供了多种输出插件，使您能够将收集的日志数据发送到不同的目的地：</p>
<ul>
<li><code>File</code>：将日志事件写入文件。</li>
<li><code>Elasticsearch</code>：使 Filebeat 能够使用其 HTTP API
将日志转发到 Elasticsearch。</li>
<li><code>Kafka</code>：将日志记录下发给 Apache Kafka。</li>
<li><code>Logstash</code>：直接向 Logstash 发送日志。</li>
</ul>
<h2 id="filebeat-模块插件">Filebeat 模块插件</h2>
<p>Filebeat
通过其模块简化日志处理，提供专为特定日志格式设计的预配置设置。这些模块使您能够毫不费力地引入、解析和丰富日志数据，而无需进行大量手动配置。以下是一些可以显著简化日志处理工作流程的可用模块：</p>
<ul>
<li>Logstash</li>
<li>AWS</li>
<li>PostgreSQL</li>
<li>Nginx</li>
<li>RabbitMQ</li>
<li>HAproxy</li>
</ul>
<h2 id="filebeat-入门">Filebeat 入门</h2>
<p>现在您已经了解了 Filebeat
的工作原理，让我们将其配置为从文件中读取日志条目并将其显示在控制台上。</p>
<p>首先，打开位于解压目录的 Filebeat 配置文件
<code>filebeat.yml</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>接下来，清除文件的现有内容，并将其替换为以下代码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/logify/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在本节 <code>filebeat.inputs</code> 中，您指定 Filebeat 应使用
<code>logs</code> 插件从文件中读取日志。<code>paths</code> 参数指示
Filebeat 将监控的日志文件的路径，此处设置为
<code>/var/log/logify/app.log</code>。</p>
<p><code>output.console</code>
部分将收集到的日志数据发送到控制台。<code>pretty: true</code>
参数可确保日志条目在控制台上显示时以可读且结构良好的格式显示。</p>
<p>添加这些配置后，保存文件。</p>
<p>在执行 Filebeat 之前，必须验证配置文件语法以识别和纠正任何错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml test config</span><br></pre></td></tr></table></figure>
<p>如果配置文件正确，则应看到以下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Config OK</span><br></pre></td></tr></table></figure>
<p>现在，继续运行 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>当 Filebeat 开始运行时，它将显示类似于以下内容的日志条目：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:35:34.696Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2875279</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;status\&quot;: 200, \&quot;ip\&quot;: \&quot;127.0.0.1\&quot;, \&quot;level\&quot;: 30, \&quot;emailAddress\&quot;: \&quot;user@mail.com\&quot;, \&quot;msg\&quot;: \&quot;Task completed successfully\&quot;, \&quot;pid\&quot;: 6512, \&quot;timestamp\&quot;: 1709343333&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;310a7b92-f2fb-42ca-b3d8-e32e348c7a57&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Filebeat 现在在控制台中显示日志消息。Bash 脚本中的日志事件位于
<code>message</code> 字段下，Filebeat
添加了其他字段以提供上下文。您现在可以通过按 <code>CTRL + C</code> 停止
Filebeat。</p>
<p>成功配置 Filebeat
以读取日志并将其转发到控制台后，下一节将重点介绍数据转换。</p>
<h2 id="使用-filebeat-转换日志">使用 Filebeat 转换日志</h2>
<p>当 Filebeat
收集数据时，您可以在将其发送到输出之前对其进行处理。您可以使用新字段来丰富它，解析数据，以及删除或编辑敏感字段以确保数据隐私。</p>
<p>在本部分中，你将通过以下方式转换日志：</p>
<ul>
<li>解析 JSON 日志。</li>
<li>删除不需要的字段。</li>
<li>添加新字段。</li>
<li>屏蔽敏感数据。</li>
</ul>
<h2 id="使用-filebeat-解析-json-日志">使用 Filebeat 解析 JSON 日志</h2>
<p>由于演示日志记录应用程序以 JSON
格式生成日志，因此必须正确解析它们以进行结构化分析。</p>
<p>让我们检查上一节中的示例日志事件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  &quot;message&quot;: &quot;&#123;\&quot;status\&quot;: 200, \&quot;ip\&quot;: \&quot;127.0.0.1\&quot;, \&quot;level\&quot;: 30, \&quot;emailAddress\&quot;: \&quot;user@mail.com\&quot;, \&quot;msg\&quot;: \&quot;Task completed successfully\&quot;, \&quot;pid\&quot;: 6512, \&quot;timestamp\&quot;: 1709343333&#125;&quot;,</span><br><span class="line">  &quot;input&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;log&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>要将日志事件解析为有效的 JSON，请打开 Filebeat 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>然后，使用以下代码行更新文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/logify/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码片段中，您将处理器配置为 <code>decode_json_fields</code>
解码每个日志条目 <code>message</code> 字段中的 JSON
编码数据，并将其附加到日志事件。</p>
<p>保存并退出文件。使用以下命令重新运行 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>如果配置文件正确，则应看到以下输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:43:07.367Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;status\&quot;: 200, \&quot;ip\&quot;: \&quot;127.0.0.1\&quot;, \&quot;level\&quot;: 30, \&quot;emailAddress\&quot;: \&quot;user@mail.com\&quot;, \&quot;msg\&quot;: \&quot;Initialized application\&quot;, \&quot;pid\&quot;: 6512, \&quot;timestamp\&quot;: 1709343785&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f33a1fc6-e8f1-4dde-8740-5f85a1e8bcfd&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709343785</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2898143</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在输出中，您将看到 <code>message</code> 字段中的所有属性（如
<code>msg</code>、 <code>ip</code> 等）都已添加到日志事件中。</p>
<p>现在，您可以解析 JSON 日志，您将修改日志事件的属性。</p>
<h2 id="使用-filebeat-添加和删除字段">使用 Filebeat 添加和删除字段</h2>
<p>日志事件包含需要保护的敏感 <code>emailAddress</code>
字段。在本部分中，你将删除该 <code>emailAddress</code>
字段，并向日志事件添加一个新字段，以提供更多上下文。</p>
<p>打开 Filebeat 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>添加以下行以修改日志事件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/logify/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;emailAddress&quot;</span>, <span class="string">&quot;message&quot;</span>]  </span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">&quot;environment&quot;</span>  <span class="comment"># Add a new &#x27;env&#x27; field set to &quot;development&quot;</span></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>若要修改日志事件，请添加 <code>drop_fields</code>
处理器，该处理器具有一个 <code>field</code>
选项，用于获取要删除的字段列表，包括敏感 <code>EmailAddress</code>
字段和 <code>message</code> 字段。删除 <code>message</code>
字段是因为在分析数据后，<code>message</code>
字段的属性已合并到日志事件中，从而使原始 <code>message</code>
字段过时。</p>
<p>编写代码后，保存并退出文件。然后，重新启动 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>运行 Filebeat 时，您会注意到该 <code>emailAddress</code>
字段已被成功删除，并且已将一个新 <code>env</code>
字段添加到日志事件中：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:47:33.907Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2911714</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Operation finished&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709344053</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;environment&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;607c49c8-9339-4851-b8e6-caab3bf6138b&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>现在，您可以扩充和删除不需要的字段，接下来将编写条件语句。</p>
<h2 id="在-filebeat-中使用条件语句">在 Filebeat 中使用条件语句</h2>
<p>Filebeat 允许您检查条件，并在条件计算结果为 <code>true</code>
时添加字段。在本节中，您将检查该 <code>status</code> 值是否等于
<code>true</code> ，如果满足条件，您将向日志事件添加一个
<code>is_successful</code> 字段。</p>
<p>为此，请打开配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>之后，添加突出显示的行以根据指定条件添加 <code>is_successful</code>
字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;emailAddress&quot;</span>]  <span class="comment"># Remove the &#x27;emailAddress&#x27; field</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">&quot;environment&quot;</span>  <span class="comment"># Add a new &#x27;env&#x27; field set to &quot;development&quot;</span></span><br><span class="line">  <span class="comment"># 如果 status 字段的值为 200，则添加 is_successful 字段</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="attr">equals:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">is_successful:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>该 <code>when</code> 选项检查 <code>status</code> 字段值是否等于
<code>200</code>。如果为 <code>true</code>，则将该
<code>is_successful</code> 字段添加到日志事件中。</p>
<p>保存新更改后，启动 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>Filebeat 将生成与此内容密切相关的输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:50:31.697Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;environment&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20cca3c1-6ba3-4a78-8e0e-cb07bdb885f1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_successful&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Task completed successfully&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2920724</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709344231</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在输出中，该 <code>is_successful</code> 字段已添加到日志条目中，HTTP
状态代码为 <code>200</code>。</p>
<p>这负责根据条件添加新字段。</p>
<h2 id="使用-filebeat-编辑敏感数据">使用 Filebeat 编辑敏感数据</h2>
<p>在本文前面，您删除了 <code>emailAddress</code>
字段以确保数据隐私。但是，IP
地址敏感字段仍保留在日志事件中。此外，组织内的其他开发人员可能会无意中将敏感数据添加到日志事件中。通过编辑与特定模式匹配的数据，您可以屏蔽任何敏感信息，而无需删除整个字段，从而确保保留消息的重要性。</p>
<p>在文本编辑器中，打开 Filebeat 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>添加以下代码以编辑 IP 地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">script:</span></span><br><span class="line">      <span class="attr">lang:</span> <span class="string">javascript</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">redact-sensitive-info</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        function process(event) &#123;</span></span><br><span class="line"><span class="string">            // Redact IP addresses (e.g., 192.168.1.1) from the &quot;message&quot; field</span></span><br><span class="line"><span class="string">            event.Put(&quot;message&quot;, event.Get(&quot;message&quot;).replace(/\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b/g, &quot;[REDACTED-IP]&quot;));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;emailAddress&quot;</span>]  <span class="comment"># Remove the &#x27;emailAddress&#x27; field</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">&quot;environment&quot;</span>  <span class="comment"># Add a new &#x27;env&#x27; field set to &quot;development&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="attr">equals:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="string">is_successful</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>在添加的代码中，您将定义一个用 JavaScript
编写的脚本，用于编辑日志事件中的敏感信息。该脚本使用正则表达式来标识 IP
地址，并分别将它替换为 <code>[REDACTED-IP]</code>。</p>
<p>添加代码后，运行 Filebeat：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./filebeat</span> <span class="string">-c</span> <span class="string">./filebeat.yml</span></span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:53:50.792Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2930777</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;environment&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_successful&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8bf595e9-0376-42ec-be51-42a104527449&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709344429</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[REDACTED-IP]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>输出中的日志事件现在将 IP 地址替换为 <code>[REDACTED-IP]</code>。</p>
<blockquote>
<p>注意：上面的脚本会将 <code>message</code> 中的所有 IP
地址都替换。</p>
</blockquote>
<p>您现在可以停止 Filebeat 和 <code>logify.sh</code> 程序。</p>
<p>若要停止 bash 脚本，请获取进程 ID：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jobs -l | grep &quot;logify&quot;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1]  + 6512 running    ./logify.sh</span><br></pre></td></tr></table></figure>
<p>替换 <code>kill</code> 命令中的进程 ID：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 &lt;6512&gt;</span><br></pre></td></tr></table></figure>
<p>成功编辑敏感字段后，您现在可以使用 Filebeat 从 Docker
容器收集日志，并将它们集中起来以进行进一步的分析和监控。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了 Filebeat
的基本概念和工作原理。我们还演示了如何配置 Filebeat
以收集日志，并使用处理器对日志事件进行转换。我们还讨论了 Filebeat
的输入、输出和模块插件，以及如何使用条件语句和脚本处理器来编辑日志事件。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Filebeat/" rel="tag"><i class="fa fa-tag"></i> Filebeat</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/03/01/log/Filebeat_vs_Logstash%20%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%B7%A5%E5%85%B7%E5%AF%B9%E6%AF%94/" rel="prev" title="Filebeat vs Logstash：日志采集工具对比">
                  <i class="fa fa-angle-left"></i> Filebeat vs Logstash：日志采集工具对比
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/03/28/gitlab/gitlab%2015.9%20%E5%8D%87%E7%BA%A7%E5%88%B0%2016.10/" rel="next" title="gitlab 15.9 升级到 16.10">
                  gitlab 15.9 升级到 16.10 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">eleven26</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/eleven26" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
