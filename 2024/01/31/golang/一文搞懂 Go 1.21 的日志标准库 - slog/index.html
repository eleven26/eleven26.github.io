<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"eleven26.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="在过去多年里，我们在 Go 中写日志的时候，通常都是使用 Zerolog 或者 Zap 这两个包， 在本文中，我们将重点探讨 Go 最近引入的 log&#x2F;slog 包，该包旨在将高性能、结构化和分级日志记录引入 Go 标准库。 该软件包起源于某位用户在 GitHub 上发起的讨论：structured, leveled logging，后来演变为描述软件包设计的提案。经最终确定，该软件包在 Go 1">
<meta property="og:type" content="article">
<meta property="og:title" content="一文搞懂 Go 1.21 的日志标准库 - slog">
<meta property="og:url" content="https://eleven26.github.io/2024/01/31/golang/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%20Go%201.21%20%E7%9A%84%E6%97%A5%E5%BF%97%E6%A0%87%E5%87%86%E5%BA%93%20-%20slog/index.html">
<meta property="og:site_name" content="eleven26">
<meta property="og:description" content="在过去多年里，我们在 Go 中写日志的时候，通常都是使用 Zerolog 或者 Zap 这两个包， 在本文中，我们将重点探讨 Go 最近引入的 log&#x2F;slog 包，该包旨在将高性能、结构化和分级日志记录引入 Go 标准库。 该软件包起源于某位用户在 GitHub 上发起的讨论：structured, leveled logging，后来演变为描述软件包设计的提案。经最终确定，该软件包在 Go 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://eleven26.github.io/images/go/logging/slog_1.png">
<meta property="article:published_time" content="2024-01-31T12:28:30.000Z">
<meta property="article:modified_time" content="2024-01-30T05:49:53.000Z">
<meta property="article:author" content="eleven26">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eleven26.github.io/images/go/logging/slog_1.png">


<link rel="canonical" href="https://eleven26.github.io/2024/01/31/golang/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%20Go%201.21%20%E7%9A%84%E6%97%A5%E5%BF%97%E6%A0%87%E5%87%86%E5%BA%93%20-%20slog/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://eleven26.github.io/2024/01/31/golang/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%20Go%201.21%20%E7%9A%84%E6%97%A5%E5%BF%97%E6%A0%87%E5%87%86%E5%BA%93%20-%20slog/","path":"2024/01/31/golang/一文搞懂 Go 1.21 的日志标准库 - slog/","title":"一文搞懂 Go 1.21 的日志标准库 - slog"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>一文搞懂 Go 1.21 的日志标准库 - slog | eleven26</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">eleven26</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">100</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">346</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8-slog"><span class="nav-number">1.</span> <span class="nav-text">开始使用 Slog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E8%AE%B0%E5%BD%95%E5%99%A8"><span class="nav-number">2.</span> <span class="nav-text">自定义默认记录器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B1%9E%E6%80%A7%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="nav-number">3.</span> <span class="nav-text">将上下文属性添加到日志记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E7%BB%84%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B1%9E%E6%80%A7"><span class="nav-number">4.</span> <span class="nav-text">分组上下文属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E5%AD%90%E8%AE%B0%E5%BD%95%E5%99%A8"><span class="nav-number">5.</span> <span class="nav-text">创建和使用子记录器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-slog-%E7%BA%A7%E5%88%AB"><span class="nav-number">6.</span> <span class="nav-text">自定义 Slog 级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="nav-number">7.</span> <span class="nav-text">创建自定义日志级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-slog-%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8Fhandler"><span class="nav-number">8.</span> <span class="nav-text">自定义 Slog
处理程序（Handler）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-number">8.1.</span> <span class="nav-text">创建自定义处理程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-slog-%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8C%85"><span class="nav-number">9.</span> <span class="nav-text">使用 Slog 的上下文包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-slog-%E8%BF%9B%E8%A1%8C%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="nav-number">10.</span> <span class="nav-text">使用 Slog 进行错误日志记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-logvaluer-%E6%8E%A5%E5%8F%A3%E9%9A%90%E8%97%8F%E6%95%8F%E6%84%9F%E5%AD%97%E6%AE%B5"><span class="nav-number">11.</span> <span class="nav-text">使用 LogValuer
接口隐藏敏感字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-slog-%E4%B8%8E%E7%AC%AC%E4%B8%89%E6%96%B9%E6%97%A5%E5%BF%97%E5%90%8E%E7%AB%AF"><span class="nav-number">12.</span> <span class="nav-text">使用 Slog 与第三方日志后端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E5%92%8C%E5%AD%98%E5%82%A8-go-%E6%97%A5%E5%BF%97%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">13.</span> <span class="nav-text">编写和存储 Go 日志的最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E5%8C%96%E6%82%A8%E7%9A%84%E6%97%A5%E5%BF%97%E6%8E%A5%E5%8F%A3"><span class="nav-number">13.1.</span> <span class="nav-text">1. 标准化您的日志接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%A0%86%E6%A0%88%E8%B7%9F%E8%B8%AA"><span class="nav-number">13.2.</span> <span class="nav-text">2. 在错误日志中添加堆栈跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%82%A8%E7%9A%84-slog-%E8%AF%AD%E5%8F%A5%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5%E4%BB%A5%E7%A1%AE%E4%BF%9D%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">13.3.</span> <span class="nav-text">3. 对您的 Slog
语句进行检查，以确保一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E6%97%A5%E5%BF%97%E4%BD%86%E9%A6%96%E5%85%88%E5%B0%86%E5%AE%83%E4%BB%AC%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.</span> <span class="nav-text">4.
集中管理日志，但首先将它们持久化到本地文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%87%E6%A0%B7%E4%BD%A0%E7%9A%84%E6%97%A5%E5%BF%97"><span class="nav-number">13.5.</span> <span class="nav-text">5. 采样你的日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="nav-number">13.6.</span> <span class="nav-text">6. 使用日志管理服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">14.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">eleven26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eleven26" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eleven26" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/01/31/golang/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%20Go%201.21%20%E7%9A%84%E6%97%A5%E5%BF%97%E6%A0%87%E5%87%86%E5%BA%93%20-%20slog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="一文搞懂 Go 1.21 的日志标准库 - slog | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          一文搞懂 Go 1.21 的日志标准库 - slog
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-31 20:28:30" itemprop="dateCreated datePublished" datetime="2024-01-31T20:28:30+08:00">2024-01-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>在过去多年里，我们在 Go 中写日志的时候，通常都是使用
<code>Zerolog</code> 或者 <code>Zap</code> 这两个包，</p>
<p>在本文中，我们将重点探讨 Go 最近引入的 <code>log/slog</code>
包，该包旨在将高性能、结构化和分级日志记录引入 Go 标准库。</p>
<p>该软件包起源于某位用户在 GitHub 上发起的讨论：<a
target="_blank" rel="noopener" href="https://github.com/golang/go/discussions/54763">structured,
leveled logging</a>，后来演变为描述软件包设计的<a
target="_blank" rel="noopener" href="https://github.com/golang/go/issues/56345">提案</a>。经最终确定，该软件包在
<code>Go 1.21</code> 中发布，也就是现在的 <code>log/slog</code>。</p>
<p><code>slog</code> 旨在提供一个简单的
API，用于记录结构化的、分级的日志。它也可以很容易地与现有的日志记录库集成，例如
<code>Zerolog</code> 和
<code>Zap</code>，这样你就可以在不改变太多现有代码的情况下，使用
<code>slog</code> 来记录日志。（这种情况下，<code>slog</code>
只是作为日志记录库的一个 “前端”。）</p>
<p>在接下来的章节中，我将详细介绍 <code>Slog</code>
提供的内容，并附上示例。</p>
<h2 id="开始使用-slog">开始使用 Slog</h2>
<p>让我们通过对其设计和架构的讲解来开始探索 <code>log/slog</code>
包。它提供了三种主要类型，你应该熟悉：</p>
<ul>
<li><code>Logger</code>：记录 “前端”，提供诸如（<code>Info()</code> 和
<code>Error()</code>）的级别方法，用于记录感兴趣的事件。</li>
<li><code>Record</code>：由 <code>Logger</code>
创建的每个独立的日志对象的表示。</li>
<li><code>Handler</code>: 一种接口，一旦实现，就确定了每个
<code>Record</code> 的格式和目的地。 <code>log/slog</code>
包中包含两个内置处理程序： <code>TextHandler</code> 和
<code>JSONHandler</code> 分别用于 <code>key=value</code> 和
<code>JSON</code> 输出。</li>
</ul>
<p>与大多数 Go 日志库一样， <code>slog</code> 包公开了一个默认的
<code>Logger</code>
，可以通过顶层函数访问。这个记录器产生的输出几乎与旧的
<code>log.Printf()</code> 方法完全相同，只是包含了日志级别：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    log.Print(<span class="string">&quot;Info message&quot;</span>)</span><br><span class="line">    slog.Info(<span class="string">&quot;Info message&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2024/01/03 10:24:22 Info message</span><br><span class="line">2024/01/03 10:24:22 INFO Info message</span><br></pre></td></tr></table></figure>
<p>这是一个有点奇怪的默认设置，因为 <code>Slog</code>
的主要目的是将结构化日志记录引入标准库。</p>
<p>通过使用 <code>slog.New()</code> 方法创建自定义 <code>Logger</code>
实例来纠正这个问题是相当容易的。它接受 <code>Handler</code>
接口的实现，该接口确定日志的格式和写入位置。</p>
<p>这是一个使用内置 <code>JSONHandler</code> 类型将 JSON 日志输出到
<code>stdout</code> 的示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>))</span><br><span class="line">    logger.Debug(<span class="string">&quot;Debug message&quot;</span>)</span><br><span class="line">    logger.Info(<span class="string">&quot;Info message&quot;</span>)</span><br><span class="line">    logger.Warn(<span class="string">&quot;Warning message&quot;</span>)</span><br><span class="line">    logger.Error(<span class="string">&quot;Error message&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-03-15T12:59:22.227408691+01:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;Info message&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-03-15T12:59:22.227468972+01:00&quot;,&quot;level&quot;:&quot;WARN&quot;,&quot;msg&quot;:&quot;Warning message&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-03-15T12:59:22.227472149+01:00&quot;,&quot;level&quot;:&quot;ERROR&quot;,&quot;msg&quot;:&quot;Error message&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>当使用 <code>TextHandler</code> 类型时，每个日志记录将按照
<code>Logfmt</code> 标准进行格式化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger := slog.New(slog.NewTextHandler(os.Stdout, <span class="literal">nil</span>))</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time=2023-03-15T13:00:11.333+01:00 level=INFO msg=&quot;Info message&quot;</span><br><span class="line">time=2023-03-15T13:00:11.333+01:00 level=WARN msg=&quot;Warning message&quot;</span><br><span class="line">time=2023-03-15T13:00:11.333+01:00 level=ERROR msg=&quot;Error message&quot;</span><br></pre></td></tr></table></figure>
<p>所有 <code>Logger</code> 实例默认记录在 <code>INFO</code>
级别，这会导致 <code>DEBUG</code>
条目被抑制，但您可以根据需要轻松更新。</p>
<h2 id="自定义默认记录器">自定义默认记录器</h2>
<p>定制默认 <code>Logger</code> 最直接的方法是利用
<code>slog.SetDefault()</code>
方法，允许您用自定义的日志记录器替换默认的日志记录器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">    slog.SetDefault(logger)</span><br><span class="line"></span><br><span class="line">    slog.Info(<span class="string">&quot;Info message&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您现在会注意到，软件包的顶层日志记录方法现在会生成如下所示的 JSON
输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-03-15T13:02:22.227408691+01:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;Info message&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>SetDefault()</code> 方法还会改变 <code>log</code>
包使用的默认 <code>log.Logger</code>。这种行为允许利用旧
<code>log</code> 包的现有应用程序无缝过渡到结构化日志记录：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">    slog.SetDefault(logger)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// elsewhere in the application</span></span><br><span class="line">    log.Println(<span class="string">&quot;Hello from old logger&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-03-15T13:03:22.227408691+01:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;Hello from old logger&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>当您需要使用需要后者（例如 <code>http.Server.ErrorLog</code>）的 API
时，也可以使用 <code>slog.NewLogLogger()</code> 方法将
<code>slog.Logger</code> 转换为 <code>log.Logger</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    handler := slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    logger := slog.NewLogLogger(handler, slog.LevelError)</span><br><span class="line"></span><br><span class="line">    _ = http.Server&#123;</span><br><span class="line">        <span class="comment">// this API only accepts `log.Logger`</span></span><br><span class="line">        ErrorLog: logger,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="将上下文属性添加到日志记录">将上下文属性添加到日志记录</h2>
<p>结构化日志比非结构化格式的一个重要优势是能够在日志记录中添加任意属性作为键值对。</p>
<p>这些属性提供了有关已记录事件的额外上下文，这对于诸如故障排除、生成指标、审计和其他各种目的非常有价值。</p>
<p>这里有一个示例，说明了它在 <code>Slog</code> 中是如何工作的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">logger.Info(</span><br><span class="line">  <span class="string">&quot;incoming request&quot;</span>,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  <span class="string">&quot;time_taken_ms&quot;</span>, <span class="number">158</span>,</span><br><span class="line">  <span class="string">&quot;path&quot;</span>, <span class="string">&quot;/hello/world?q=search&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>, <span class="number">200</span>,</span><br><span class="line">  <span class="string">&quot;user_agent&quot;</span>, <span class="string">&quot;Googlebot/2.1 (+http://www.google.com/bot.html)&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;:&quot;2023-02-24T11:52:49.554074496+01:00&quot;,</span><br><span class="line">  &quot;level&quot;:&quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;:&quot;incoming request&quot;,</span><br><span class="line">  &quot;method&quot;:&quot;GET&quot;,</span><br><span class="line">  &quot;time_taken_ms&quot;:158,</span><br><span class="line">  &quot;path&quot;:&quot;/hello/world?q=search&quot;,</span><br><span class="line">  &quot;status&quot;:200,</span><br><span class="line">  &quot;user_agent&quot;:&quot;Googlebot/2.1 (+http://www.google.com/bot.html)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有级别方法（<code>Info()</code>，<code>Debug()</code>
等）都接受日志消息作为它们的第一个参数，以及之后无限数量的松散类型的键/值对。</p>
<p>这个 API 类似于 <code>Zap</code> 中的
<code>SugaredLogger API</code>（特别是它的以 <code>w</code>
结尾的级别方法），因为它在追求简洁的同时牺牲了额外的内存分配。</p>
<p>但要小心，因为这种方法可能会导致意想不到的问题。具体来说，不平衡的键/值对可能会导致问题输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logger.Info(</span><br><span class="line">  &quot;incoming request&quot;,</span><br><span class="line">  &quot;method&quot;, &quot;GET&quot;,</span><br><span class="line">  &quot;time_taken_ms&quot;, // the value for this key is missing</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>由于 <code>time_taken_ms</code> 键没有对应的值，它将被视为具有键
<code>!BADKEY</code>
的值。这并不好，因为属性不对齐可能会产生错误的条目，直到您需要使用日志时才会知道。</p>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-03-15T13:15:29.956566795+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;incoming request&quot;,</span><br><span class="line">  &quot;method&quot;: &quot;GET&quot;,</span><br><span class="line">  &quot;!BADKEY&quot;: &quot;time_taken_ms&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了防止这样的问题，您可以运行 vet
命令或使用一个代码检查工具来自动报告这些问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go vet .</span><br><span class="line">./main.go:11:2: call to slog.Info missing a final value</span><br></pre></td></tr></table></figure>
<p>另一种防止这种错误的方法是使用如下所示的强类型上下文属性：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logger.Info(</span><br><span class="line">  <span class="string">&quot;incoming request&quot;</span>,</span><br><span class="line">  slog.String(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>),</span><br><span class="line">  slog.Int(<span class="string">&quot;time_taken_ms&quot;</span>, <span class="number">158</span>),</span><br><span class="line">  slog.String(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;/hello/world?q=search&quot;</span>),</span><br><span class="line">  slog.Int(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>),</span><br><span class="line">  slog.String(</span><br><span class="line">    <span class="string">&quot;user_agent&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Googlebot/2.1 (+http://www.google.com/bot.html)&quot;</span>,</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>虽然这是一种更好的上下文日志记录方法，但它并非百分之百可靠，因为没有阻止你像这样混合使用强类型和弱类型的键值对：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logger.Info(</span><br><span class="line">  <span class="string">&quot;incoming request&quot;</span>,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  slog.Int(<span class="string">&quot;time_taken_ms&quot;</span>, <span class="number">158</span>),</span><br><span class="line">  slog.String(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;/hello/world?q=search&quot;</span>),</span><br><span class="line">  <span class="string">&quot;status&quot;</span>, <span class="number">200</span>,</span><br><span class="line">  slog.String(</span><br><span class="line">    <span class="string">&quot;user_agent&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Googlebot/2.1 (+http://www.google.com/bot.html)&quot;</span>,</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>为了确保在向记录添加上下文属性时的类型安全性，您必须像这样使用
<code>LogAttrs()</code> 方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">logger.LogAttrs(</span><br><span class="line">  context.Background(),</span><br><span class="line">  slog.LevelInfo,</span><br><span class="line">  <span class="string">&quot;incoming request&quot;</span>,</span><br><span class="line">  slog.String(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>),</span><br><span class="line">  slog.Int(<span class="string">&quot;time_taken_ms&quot;</span>, <span class="number">158</span>),</span><br><span class="line">  slog.String(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;/hello/world?q=search&quot;</span>),</span><br><span class="line">  slog.Int(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>),</span><br><span class="line">  slog.String(</span><br><span class="line">    <span class="string">&quot;user_agent&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Googlebot/2.1 (+http://www.google.com/bot.html)&quot;</span>,</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>该方法只接受自定义属性的 <code>slog.Attr</code>
类型，因此不可能存在不平衡的键/值对。然而，它的 API
更加复杂，因为您总是需要传递上下文（或 <code>nil</code>
）和日志级别到该方法，除了日志消息和自定义属性。</p>
<h2 id="分组上下文属性">分组上下文属性</h2>
<p><code>Slog</code>
还允许将多个属性分组在一个名称下，但输出取决于使用的
<code>Handler</code> 。例如，使用 <code>JSONHandler</code>
，每个组都嵌套在 JSON 对象中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logger.LogAttrs(</span><br><span class="line">  context.Background(),</span><br><span class="line">  slog.LevelInfo,</span><br><span class="line">  <span class="string">&quot;image uploaded&quot;</span>,</span><br><span class="line">  slog.Int(<span class="string">&quot;id&quot;</span>, <span class="number">23123</span>),</span><br><span class="line">  slog.Group(<span class="string">&quot;properties&quot;</span>,</span><br><span class="line">    slog.Int(<span class="string">&quot;width&quot;</span>, <span class="number">4000</span>),</span><br><span class="line">    slog.Int(<span class="string">&quot;height&quot;</span>, <span class="number">3000</span>),</span><br><span class="line">    slog.String(<span class="string">&quot;format&quot;</span>, <span class="string">&quot;jpeg&quot;</span>),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;:&quot;2023-02-24T12:03:12.175582603+01:00&quot;,</span><br><span class="line">  &quot;level&quot;:&quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;:&quot;image uploaded&quot;,</span><br><span class="line">  &quot;id&quot;:23123,</span><br><span class="line">  &quot;properties&quot;:&#123;</span><br><span class="line">    &quot;width&quot;:4000,</span><br><span class="line">    &quot;height&quot;:3000,</span><br><span class="line">    &quot;format&quot;:&quot;jpeg&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在使用 <code>TextHandler</code>
时，组中的每个键都将以组名作为前缀，就像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time=2023-02-24T12:06:20.249+01:00 level=INFO msg=&quot;image uploaded&quot; id=23123</span><br><span class="line">  properties.width=4000 properties.height=3000 properties.format=jpeg</span><br></pre></td></tr></table></figure>
<h2 id="创建和使用子记录器">创建和使用子记录器</h2>
<p>在特定范围内的所有记录中包含相同的属性可能有益，可以确保它们的存在，而无需重复的记录语句。</p>
<p>这就是孩子记录器可以发挥作用的地方，因为它们创建了一个新的日志上下文，继承自其父级，同时允许包含额外的字段。</p>
<p>在 <code>Slog</code> 中，使用 <code>Logger.With()</code>
方法可以创建子记录器。它接受一个或多个键/值对，并返回一个包含指定属性的新
<code>Logger</code> 。</p>
<p>考虑以下代码片段，它将程序的进程ID和用于编译的 Go
版本添加到每个日志记录中，并将它们存储在一个 <code>program_info</code>
属性中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    handler := slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>)</span><br><span class="line">    buildInfo, _ := debug.ReadBuildInfo()</span><br><span class="line"></span><br><span class="line">    logger := slog.New(handler)</span><br><span class="line"></span><br><span class="line">    child := logger.With(</span><br><span class="line">        slog.Group(<span class="string">&quot;program_info&quot;</span>,</span><br><span class="line">            slog.Int(<span class="string">&quot;pid&quot;</span>, os.Getpid()),</span><br><span class="line">            slog.String(<span class="string">&quot;go_version&quot;</span>, buildInfo.GoVersion),</span><br><span class="line">        ),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// . . .</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了这个配置，<code>child</code>
记录器创建的所有记录都将包含指定属性在 <code>program_info</code>
属性下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// . . .</span></span><br><span class="line"></span><br><span class="line">    child.Info(<span class="string">&quot;image upload successful&quot;</span>, slog.String(<span class="string">&quot;image_id&quot;</span>, <span class="string">&quot;39ud88&quot;</span>))</span><br><span class="line">    child.Warn(</span><br><span class="line">        <span class="string">&quot;storage is 90% full&quot;</span>,</span><br><span class="line">        slog.String(<span class="string">&quot;available_space&quot;</span>, <span class="string">&quot;900.1 mb&quot;</span>),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-02-26T19:26:46.046793623+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;image upload successful&quot;,</span><br><span class="line">  &quot;program_info&quot;: &#123;</span><br><span class="line">    &quot;pid&quot;: 229108,</span><br><span class="line">    &quot;go_version&quot;: &quot;go1.20&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;image_id&quot;: &quot;39ud88&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-02-26T19:26:46.046847902+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;WARN&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;storage is 90% full&quot;,</span><br><span class="line">  &quot;program_info&quot;: &#123;</span><br><span class="line">    &quot;pid&quot;: 229108,</span><br><span class="line">    &quot;go_version&quot;: &quot;go1.20&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;available_space&quot;: &quot;900.1 MB&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您还可以使用 <code>WithGroup()</code>
方法创建一个子记录器，以便启动一个组，使所有添加到记录器的属性（包括在日志点添加的属性）都嵌套在组名称下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">handler := slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>)</span><br><span class="line">buildInfo, _ := debug.ReadBuildInfo()</span><br><span class="line">logger := slog.New(handler).WithGroup(<span class="string">&quot;program_info&quot;</span>)</span><br><span class="line"></span><br><span class="line">child := logger.With(</span><br><span class="line">  slog.Int(<span class="string">&quot;pid&quot;</span>, os.Getpid()),</span><br><span class="line">  slog.String(<span class="string">&quot;go_version&quot;</span>, buildInfo.GoVersion),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">child.Warn(</span><br><span class="line">  <span class="string">&quot;storage is 90% full&quot;</span>,</span><br><span class="line">  slog.String(<span class="string">&quot;available_space&quot;</span>, <span class="string">&quot;900.1 MB&quot;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-05-24T19:00:18.384136084+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;WARN&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;storage is 90% full&quot;,</span><br><span class="line">  &quot;program_info&quot;: &#123;</span><br><span class="line">    &quot;pid&quot;: 1971993,</span><br><span class="line">    &quot;go_version&quot;: &quot;go1.20.2&quot;,</span><br><span class="line">    &quot;available_space&quot;: &quot;900.1 mb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义-slog-级别">自定义 Slog 级别</h2>
<p><code>log/slog</code>
包默认提供了四个日志级别，每个级别都与一个整数值相关联：<code>DEBUG(-4)</code>、<code>INFO(0)</code>、<code>WARN(4)</code>
和 <code>ERROR(8)</code>。</p>
<p>每个级别之间的间隔为
4，这是一个经过深思熟虑的设计决定，以适应具有自定义级别的日志方案。例如，您可以在
<code>INFO</code> 和 <code>WARN</code>
之间创建一个自定义级别，其值为1、2或3。</p>
<p>我们先前观察到，默认情况下，所有记录器都配置为以 <code>INFO</code>
级别记录日志，这会导致记录在更低严重性（如 DEBUG
）的事件被抑制。您可以通过以下 <code>HandlerOptions</code>
类型自定义此行为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    opts := &amp;slog.HandlerOptions&#123;</span><br><span class="line">        Level: slog.LevelDebug,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handler := slog.NewJSONHandler(os.Stdout, opts)</span><br><span class="line"></span><br><span class="line">    logger := slog.New(handler)</span><br><span class="line">    logger.Debug(<span class="string">&quot;Debug message&quot;</span>)</span><br><span class="line">    logger.Info(<span class="string">&quot;Info message&quot;</span>)</span><br><span class="line">    logger.Warn(<span class="string">&quot;Warning message&quot;</span>)</span><br><span class="line">    logger.Error(<span class="string">&quot;Error message&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-05-24T19:03:10.70311982+01:00&quot;,&quot;level&quot;:&quot;DEBUG&quot;,&quot;msg&quot;:&quot;Debug message&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-05-24T19:03:10.703187713+01:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;Info message&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-05-24T19:03:10.703190419+01:00&quot;,&quot;level&quot;:&quot;WARN&quot;,&quot;msg&quot;:&quot;Warning message&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-05-24T19:03:10.703192892+01:00&quot;,&quot;level&quot;:&quot;ERROR&quot;,&quot;msg&quot;:&quot;Error message&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>这种设置级别的方法会在整个生命周期中固定级别。如果需要动态变化的最小级别，必须使用下面所示的类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logLevel := &amp;slog.LevelVar&#123;&#125; <span class="comment">// INFO</span></span><br><span class="line"></span><br><span class="line">    opts := &amp;slog.HandlerOptions&#123;</span><br><span class="line">        Level: logLevel,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handler := slog.NewJSONHandler(os.Stdout, opts)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// . . .</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您随时可以使用以下方法更新日志级别:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logLevel.Set(slog.LevelDebug)</span><br></pre></td></tr></table></figure>
<h2 id="创建自定义日志级别">创建自定义日志级别</h2>
<p>如果您需要超出 <code>Slog</code>
默认提供的自定义级别，可以通过实现以下签名的 <code>Leveler</code>
接口来创建它们：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Leveler <span class="keyword">interface</span> &#123;</span><br><span class="line">    Level() Level</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过下面显示的类型很容易实现这个接口（因为 <code>Level</code>
本身实现了 <code>Leveler</code>）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    LevelTrace  = slog.Level(<span class="number">-8</span>)</span><br><span class="line">    LevelFatal  = slog.Level(<span class="number">12</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>一旦您按上述方式定义了自定义级别，您只能通过 <code>Log()</code> 或
<code>LogAttrs()</code> 方法使用它们：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">opts := &amp;slog.HandlerOptions&#123;</span><br><span class="line">    Level: LevelTrace,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logger := slog.New(slog.NewJSONHandler(os.Stdout, opts))</span><br><span class="line"></span><br><span class="line">ctx := context.Background()</span><br><span class="line">logger.Log(ctx, LevelTrace, <span class="string">&quot;Trace message&quot;</span>)</span><br><span class="line">logger.Log(ctx, LevelFatal, <span class="string">&quot;Fatal level&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-02-24T09:26:41.666493901+01:00&quot;,&quot;level&quot;:&quot;DEBUG-4&quot;,&quot;msg&quot;:&quot;Trace level&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-02-24T09:26:41.666602404+01:00&quot;,&quot;level&quot;:&quot;ERROR+4&quot;,&quot;msg&quot;:&quot;Fatal level&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>注意自定义级别是如何以默认级别标记的。这绝对不是你想要的，所以你应该通过
<code>HandlerOptions</code> 类型自定义级别名称，就像这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">. . .</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> LevelNames = <span class="keyword">map</span>[slog.Leveler]<span class="type">string</span>&#123;</span><br><span class="line">    LevelTrace:      <span class="string">&quot;TRACE&quot;</span>,</span><br><span class="line">    LevelFatal:      <span class="string">&quot;FATAL&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    opts := slog.HandlerOptions&#123;</span><br><span class="line">        Level: LevelTrace,</span><br><span class="line">        ReplaceAttr: <span class="function"><span class="keyword">func</span><span class="params">(groups []<span class="type">string</span>, a slog.Attr)</span></span> slog.Attr &#123;</span><br><span class="line">            <span class="keyword">if</span> a.Key == slog.LevelKey &#123;</span><br><span class="line">                level := a.Value.Any().(slog.Level)</span><br><span class="line">                levelLabel, exists := LevelNames[level]</span><br><span class="line">                <span class="keyword">if</span> !exists &#123;</span><br><span class="line">                    levelLabel = level.String()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                a.Value = slog.StringValue(levelLabel)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> a</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    . . .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该 <code>ReplaceAttr()</code> 函数用于自定义 <code>Handler</code>
处理 <code>Record</code>
中每个键值对的方式。它可以用于自定义键名，或以某种方式处理值。</p>
<p>在上面的示例中，它将自定义日志级别映射到它们各自的标签，分别生成
<code>TRACE</code> 和 <code>FATAL</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-02-24T09:27:51.747625912+01:00&quot;,&quot;level&quot;:&quot;TRACE&quot;,&quot;msg&quot;:&quot;Trace level&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-02-24T09:27:51.747737319+01:00&quot;,&quot;level&quot;:&quot;FATAL&quot;,&quot;msg&quot;:&quot;Fatal level&quot;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义-slog-处理程序handler">自定义 Slog
处理程序（Handler）</h2>
<p>如前所述，<code>TextHandler</code> 和 <code>JSONHandler</code>
都可以使用 <code>HandlerOptions</code>
类型进行自定义。您已经看到了如何调整最小级别并修改属性以记录它们。</p>
<p>如果需要，可以通过包括日志来源来实现另一种定制化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">opts := &amp;slog.HandlerOptions&#123;</span><br><span class="line">    AddSource: <span class="literal">true</span>,</span><br><span class="line">    Level:     slog.LevelDebug,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2024-01-03T11:06:50.971029852+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;DEBUG&quot;,</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;function&quot;: &quot;main.main&quot;,</span><br><span class="line">    &quot;file&quot;: &quot;/home/ayo/dev/betterstack/demo/slog/main.go&quot;,</span><br><span class="line">    &quot;line&quot;: 17</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;msg&quot;: &quot;Debug message&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据应用环境轻松切换足够的处理程序也很容易。例如，您可能更喜欢在开发日志中使用
<code>TextHandler</code> ，因为它更容易阅读，然后在生产环境中切换到
<code>JSONHandler</code> ，以获得更灵活性和与各种日志工具的兼容性。</p>
<p>这种行为可以通过环境变量轻松实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> appEnv = os.Getenv(<span class="string">&quot;APP_ENV&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    opts := &amp;slog.HandlerOptions&#123;</span><br><span class="line">        Level: slog.LevelDebug,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> handler slog.Handler = slog.NewTextHandler(os.Stdout, opts)</span><br><span class="line">    <span class="keyword">if</span> appEnv == <span class="string">&quot;production&quot;</span> &#123;</span><br><span class="line">        handler = slog.NewJSONHandler(os.Stdout, opts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger := slog.New(handler)</span><br><span class="line"></span><br><span class="line">    logger.Info(<span class="string">&quot;Info message&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time=2023-02-24T10:36:39.697+01:00 level=INFO msg=&quot;Info message&quot;</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=production go run main.go</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-02-24T10:35:16.964821548+01:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;Info message&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建自定义处理程序">创建自定义处理程序</h3>
<p>由于 <code>Handler</code>
是一个接口，可以创建自定义处理程序，以不同的格式格式化日志或将其写入其他目的地。</p>
<p>它的签名如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">    Enabled(context.Context, Level) <span class="type">bool</span></span><br><span class="line">    Handle(context.Context, r Record) <span class="type">error</span></span><br><span class="line">    WithAttrs(attrs []Attr) Handler</span><br><span class="line">    WithGroup(name <span class="type">string</span>) Handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是每种方法的作用：</p>
<ul>
<li><code>Enabled</code>:
根据其级别确定是否处理或丢弃日志记录。也可以使用 context 做出决定。</li>
<li><code>Handle</code>: 处理每个发送到处理程序的日志记录。仅在
Enabled() 返回 true 时调用。</li>
<li><code>WithAttrs</code>:
从现有的处理程序创建一个新的处理程序，并将指定的属性添加到其中。</li>
<li><code>WithGroup</code>:
从现有的处理程序创建一个新的处理程序，并将指定的组名添加到其中，以便该名称限定后续的属性。</li>
</ul>
<p>这是一个使用 <code>log</code>、<code>json</code> 和
<code>color</code> 包来实现日志记录的美化开发输出的示例:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：下面代码没有经过完整测试，只是为了说明可能的用法</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/fatih/color&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PrettyHandlerOptions <span class="keyword">struct</span> &#123;</span><br><span class="line">    SlogOpts slog.HandlerOptions</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PrettyHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">    slog.Handler</span><br><span class="line">    l *log.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *PrettyHandler)</span></span> Handle(ctx context.Context, r slog.Record) <span class="type">error</span> &#123;</span><br><span class="line">    level := r.Level.String() + <span class="string">&quot;:&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> r.Level &#123;</span><br><span class="line">    <span class="keyword">case</span> slog.LevelDebug:</span><br><span class="line">        level = color.MagentaString(level)</span><br><span class="line">    <span class="keyword">case</span> slog.LevelInfo:</span><br><span class="line">        level = color.BlueString(level)</span><br><span class="line">    <span class="keyword">case</span> slog.LevelWarn:</span><br><span class="line">        level = color.YellowString(level)</span><br><span class="line">    <span class="keyword">case</span> slog.LevelError:</span><br><span class="line">        level = color.RedString(level)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fields := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, r.NumAttrs())</span><br><span class="line">    r.Attrs(<span class="function"><span class="keyword">func</span><span class="params">(a slog.Attr)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        fields[a.Key] = a.Value.Any()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    b, err := json.MarshalIndent(fields, <span class="string">&quot;&quot;</span>, <span class="string">&quot;  &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timeStr := r.Time.Format(<span class="string">&quot;[15:05:05.000]&quot;</span>)</span><br><span class="line">    msg := color.CyanString(r.Message)</span><br><span class="line"></span><br><span class="line">    h.l.Println(timeStr, level, msg, color.WhiteString(<span class="type">string</span>(b)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPrettyHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    out io.Writer,</span></span></span><br><span class="line"><span class="params"><span class="function">    opts PrettyHandlerOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> *PrettyHandler &#123;</span><br><span class="line">    h := &amp;PrettyHandler&#123;</span><br><span class="line">        Handler: slog.NewJSONHandler(out, &amp;opts.SlogOpts),</span><br><span class="line">        l:       log.New(out, <span class="string">&quot;&quot;</span>, <span class="number">0</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当你在代码中像这样使用 <code>PrettyHandler</code> 时：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    opts := PrettyHandlerOptions&#123;</span><br><span class="line">        SlogOpts: slog.HandlerOptions&#123;</span><br><span class="line">            Level: slog.LevelDebug,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    handler := NewPrettyHandler(os.Stdout, opts)</span><br><span class="line">    logger := slog.New(handler)</span><br><span class="line">    logger.Debug(</span><br><span class="line">        <span class="string">&quot;executing database query&quot;</span>,</span><br><span class="line">        slog.String(<span class="string">&quot;query&quot;</span>, <span class="string">&quot;SELECT * FROM users&quot;</span>),</span><br><span class="line">    )</span><br><span class="line">    logger.Info(<span class="string">&quot;image upload successful&quot;</span>, slog.String(<span class="string">&quot;image_id&quot;</span>, <span class="string">&quot;39ud88&quot;</span>))</span><br><span class="line">    logger.Warn(</span><br><span class="line">        <span class="string">&quot;storage is 90% full&quot;</span>,</span><br><span class="line">        slog.String(<span class="string">&quot;available_space&quot;</span>, <span class="string">&quot;900.1 MB&quot;</span>),</span><br><span class="line">    )</span><br><span class="line">    logger.Error(</span><br><span class="line">        <span class="string">&quot;An error occurred while processing the request&quot;</span>,</span><br><span class="line">        slog.String(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;https://example.com&quot;</span>),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当您执行该程序时，您将观察到以下着色的输出：</p>
<p><img src="/images/go/logging/slog_1.png" /></p>
<h2 id="使用-slog-的上下文包">使用 Slog 的上下文包</h2>
<p>到目前为止，我们主要使用了级别方法的标准变体，比如
<code>Info()</code>，<code>Debug()</code> 等，但 Slog 还提供了接受
<code>context.Context</code>
值作为其第一个参数的上下文感知变体。以下是每个方法的签名：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx context.Context, msg <span class="type">string</span>, args ...any)</span></span></span><br></pre></td></tr></table></figure>
<p>通过这种方法，您可以通过将上下文属性存储在 <code>Context</code>
中，在函数之间传播它们，这样当找到这些值时，它们会被添加到任何生成的记录中。</p>
<p>请考虑以下程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">    ctx := context.WithValue(context.Background(), <span class="string">&quot;request_id&quot;</span>, <span class="string">&quot;req-123&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.InfoContext(ctx, <span class="string">&quot;image uploaded&quot;</span>, slog.String(<span class="string">&quot;image_id&quot;</span>, <span class="string">&quot;img-998&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>request_id</code> 添加到 <code>ctx</code> 变量，并传递给
<code>InfoContext</code> 方法。然而，当程序运行时，
<code>request_id</code> 字段不会出现在日志中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2024-01-02T11:04:28.590527494+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;image uploaded&quot;,</span><br><span class="line">  &quot;image_id&quot;: &quot;img-998&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要使其正常工作，您需要创建一个自定义处理程序，并按照下面所示重新实现
<code>Handle</code> 方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ctxKey <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    slogFields ctxKey = <span class="string">&quot;slog_fields&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ContextHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">    slog.Handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加上下文属性到 Record 中，然后调用底层的 handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h ContextHandler)</span></span> Handle(ctx context.Context, r slog.Record) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> attrs, ok := ctx.Value(slogFields).([]slog.Attr); ok &#123;</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> attrs &#123;</span><br><span class="line">            r.AddAttrs(v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h.Handler.Handle(ctx, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AppendCtx 将 slog 属性添加到提供的上下文中，</span></span><br><span class="line"><span class="comment">// 以便在使用此类上下文创建的任何 Record 中都会包含该属性</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AppendCtx</span><span class="params">(parent context.Context, attr slog.Attr)</span></span> context.Context &#123;</span><br><span class="line">    <span class="keyword">if</span> parent == <span class="literal">nil</span> &#123;</span><br><span class="line">        parent = context.Background()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v, ok := parent.Value(slogFields).([]slog.Attr); ok &#123;</span><br><span class="line">        v = <span class="built_in">append</span>(v, attr)</span><br><span class="line">        <span class="keyword">return</span> context.WithValue(parent, slogFields, v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v := []slog.Attr&#123;&#125;</span><br><span class="line">    v = <span class="built_in">append</span>(v, attr)</span><br><span class="line">    <span class="keyword">return</span> context.WithValue(parent, slogFields, v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该 <code>ContextHandler</code> 结构嵌入了 <code>slog.Handler</code>
接口，并实现了 <code>Handle</code> 方法，以提取存储在提供的上下文中的
<code>Slog</code> 属性。如果找到，它们将被添加到 <code>Record</code>
中，然后调用底层的 <code>Handler</code> 来格式化和输出记录。</p>
<p>另一方面， <code>AppendCtx</code> 函数使用 <code>slogFields</code>
键向 <code>context.Context</code> 添加 <code>Slog</code> 属性，以便
<code>ContextHandler</code> 可访问。</p>
<p>这是如何同时使用它们的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    h := &amp;ContextHandler&#123;slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>)&#125;</span><br><span class="line"></span><br><span class="line">    logger := slog.New(h)</span><br><span class="line"></span><br><span class="line">    ctx := AppendCtx(context.Background(), slog.String(<span class="string">&quot;request_id&quot;</span>, <span class="string">&quot;req-123&quot;</span>))</span><br><span class="line"></span><br><span class="line">    logger.InfoContext(ctx, <span class="string">&quot;image uploaded&quot;</span>, slog.String(<span class="string">&quot;image_id&quot;</span>, <span class="string">&quot;img-998&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您现在将会观察到，<code>request_id</code> 将包含在使用
<code>ctx</code> 参数创建的任何记录中：</p>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2024-01-02T11:29:15.229984723+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;image uploaded&quot;,</span><br><span class="line">  &quot;image_id&quot;: &quot;img-998&quot;,</span><br><span class="line">  &quot;request_id&quot;: &quot;req-123&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用-slog-进行错误日志记录">使用 Slog 进行错误日志记录</h2>
<p>在记录错误时，大多数框架都没有为 <code>error</code>
类型提供辅助程序，因此您必须像这样使用 <code>slog.Any()</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">err := errors.New(<span class="string">&quot;something happened&quot;</span>)</span><br><span class="line"></span><br><span class="line">logger.ErrorContext(ctx, <span class="string">&quot;upload failed&quot;</span>, slog.Any(<span class="string">&quot;error&quot;</span>, err))</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2024-01-02T14:13:44.41886393+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;ERROR&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;upload failed&quot;,</span><br><span class="line">  &quot;error&quot;: &quot;something happened&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要获取和记录错误堆栈跟踪，您可以使用类似 <code>xerrors</code>
的库来创建带有堆栈跟踪的错误：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">err := xerrors.New(<span class="string">&quot;something happened&quot;</span>)</span><br><span class="line"></span><br><span class="line">logger.ErrorContext(ctx, <span class="string">&quot;upload failed&quot;</span>, slog.Any(<span class="string">&quot;error&quot;</span>, err))</span><br></pre></td></tr></table></figure>
<p>在你能够观察错误日志中的堆栈跟踪之前，你还需要提取、格式化并通过之前演示的
<code>ReplaceAttr()</code> 函数将其添加到相应的 <code>Record</code>
中。</p>
<p>这是一个例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/mdobak/go-xerrors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> stackFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">    Func   <span class="type">string</span> <span class="string">`json:&quot;func&quot;`</span></span><br><span class="line">    Source <span class="type">string</span> <span class="string">`json:&quot;source&quot;`</span></span><br><span class="line">    Line   <span class="type">int</span>    <span class="string">`json:&quot;line&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">replaceAttr</span><span class="params">(_ []<span class="type">string</span>, a slog.Attr)</span></span> slog.Attr &#123;</span><br><span class="line">    <span class="keyword">switch</span> a.Value.Kind() &#123;</span><br><span class="line">    <span class="keyword">case</span> slog.KindAny:</span><br><span class="line">        <span class="keyword">switch</span> v := a.Value.Any().(<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">error</span>:</span><br><span class="line">            a.Value = fmtErr(v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// marshalStack 从错误中提取堆栈帧</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">marshalStack</span><span class="params">(err <span class="type">error</span>)</span></span> []stackFrame &#123;</span><br><span class="line">    trace := xerrors.StackTrace(err)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(trace) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frames := trace.Frames()</span><br><span class="line"></span><br><span class="line">    s := <span class="built_in">make</span>([]stackFrame, <span class="built_in">len</span>(frames))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, v := <span class="keyword">range</span> frames &#123;</span><br><span class="line">        f := stackFrame&#123;</span><br><span class="line">            Source: filepath.Join(</span><br><span class="line">                filepath.Base(filepath.Dir(v.File)),</span><br><span class="line">                filepath.Base(v.File),</span><br><span class="line">            ),</span><br><span class="line">            Func: filepath.Base(v.Function),</span><br><span class="line">            Line: v.Line,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s[i] = f</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fmtErr 返回一个 slog.Value，其中包含键 `msg` 和 `trace`。如果错误没有实现</span></span><br><span class="line"><span class="comment">// interface &#123; StackTrace() errors.StackTrace &#125;，则省略 `trace` 键。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fmtErr</span><span class="params">(err <span class="type">error</span>)</span></span> slog.Value &#123;</span><br><span class="line">    <span class="keyword">var</span> groupValues []slog.Attr</span><br><span class="line"></span><br><span class="line">    groupValues = <span class="built_in">append</span>(groupValues, slog.String(<span class="string">&quot;msg&quot;</span>, err.Error()))</span><br><span class="line"></span><br><span class="line">    frames := marshalStack(err)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> frames != <span class="literal">nil</span> &#123;</span><br><span class="line">        groupValues = <span class="built_in">append</span>(groupValues,</span><br><span class="line">            slog.Any(<span class="string">&quot;trace&quot;</span>, frames),</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> slog.GroupValue(groupValues...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    h := slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">        ReplaceAttr: replaceAttr,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    logger := slog.New(h)</span><br><span class="line"></span><br><span class="line">    ctx := context.Background()</span><br><span class="line">    err := xerrors.New(<span class="string">&quot;something happened&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.ErrorContext(ctx, <span class="string">&quot;image uploaded&quot;</span>, slog.Any(<span class="string">&quot;error&quot;</span>, err))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了这个设置，使用 <code>xerrors.New()</code>
创建的任何错误都将被记录为格式良好的堆栈跟踪，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2024-01-03T07:09:31.013954119+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;ERROR&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;image uploaded&quot;,</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;something happened&quot;,</span><br><span class="line">    &quot;trace&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;func&quot;: &quot;main.main&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;slog/main.go&quot;,</span><br><span class="line">        &quot;line&quot;: 82</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;func&quot;: &quot;runtime.main&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;runtime/proc.go&quot;,</span><br><span class="line">        &quot;line&quot;: 267</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;func&quot;: &quot;runtime.goexit&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;runtime/asm_amd64.s&quot;,</span><br><span class="line">        &quot;line&quot;: 1650</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在您可以轻松追踪导致应用程序中任何意外错误的执行路径。</p>
<h2 id="使用-logvaluer-接口隐藏敏感字段">使用 LogValuer
接口隐藏敏感字段</h2>
<p>该接口允许您通过指定自定义类型的日志记录方式来标准化日志输出。以下是其签名：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LogValuer <span class="keyword">interface</span> &#123;</span><br><span class="line">    LogValue() Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现此接口的主要用例是隐藏自定义类型中的敏感字段。例如，这是一个未实现该接口的类型。注意当实例被记录时，敏感细节是如何暴露的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 没有实现 `LogValuer` 接口</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="type">string</span> <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">    FirstName <span class="type">string</span> <span class="string">`json:&quot;first_name&quot;`</span></span><br><span class="line">    LastName  <span class="type">string</span> <span class="string">`json:&quot;last_name&quot;`</span></span><br><span class="line">    Email     <span class="type">string</span> <span class="string">`json:&quot;email&quot;`</span></span><br><span class="line">    Password  <span class="type">string</span> <span class="string">`json:&quot;password&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    handler := slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>)</span><br><span class="line">    logger := slog.New(handler)</span><br><span class="line"></span><br><span class="line">    u := &amp;User&#123;</span><br><span class="line">        ID:        <span class="string">&quot;user-12234&quot;</span>,</span><br><span class="line">        FirstName: <span class="string">&quot;Jan&quot;</span>,</span><br><span class="line">        LastName:  <span class="string">&quot;Doe&quot;</span>,</span><br><span class="line">        Email:     <span class="string">&quot;jan@example.com&quot;</span>,</span><br><span class="line">        Password:  <span class="string">&quot;pass-12334&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.Info(<span class="string">&quot;info&quot;</span>, <span class="string">&quot;user&quot;</span>, u)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-02-26T22:11:30.080656774+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;info&quot;,</span><br><span class="line">  &quot;user&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;user-12234&quot;,</span><br><span class="line">    &quot;first_name&quot;: &quot;Jan&quot;,</span><br><span class="line">    &quot;last_name&quot;: &quot;Doe&quot;,</span><br><span class="line">    &quot;email&quot;: &quot;jan@example.com&quot;,</span><br><span class="line">    &quot;password&quot;: &quot;pass-12334&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是有问题的，因为该类型包含不应出现在日志中的秘密字段（如电子邮件和密码），还会使您的日志变得不必要地冗长。</p>
<p>您可以通过指定日志中要表示的类型来解决此问题。例如，您可以指定仅将
<code>ID</code> 字段记录如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 实现 LogValuer 接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> LogValue() slog.Value &#123;</span><br><span class="line">    <span class="keyword">return</span> slog.StringValue(u.ID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您现在将观察到以下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-02-26T22:43:28.184363059+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;info&quot;,</span><br><span class="line">  &quot;user&quot;: &quot;user-12234&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您也可以像这样对多个属性进行分组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> LogValue() slog.Value &#123;</span><br><span class="line">    <span class="keyword">return</span> slog.GroupValue(</span><br><span class="line">        slog.String(<span class="string">&quot;id&quot;</span>, u.ID),</span><br><span class="line">        slog.String(<span class="string">&quot;name&quot;</span>, u.FirstName+<span class="string">&quot; &quot;</span>+u.LastName),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;time&quot;: &quot;2023-03-15T14:44:24.223381036+01:00&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;msg&quot;: &quot;info&quot;,</span><br><span class="line">  &quot;user&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;user-12234&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;Jan Doe&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用-slog-与第三方日志后端">使用 Slog 与第三方日志后端</h2>
<p><code>Slog</code> 的主要设计目标之一是为 Go
应用程序提供统一的日志前端（<code>slog.Logger</code>），而后端（<code>slog.Handler</code>）可以根据程序的不同进行定制。</p>
<p>这样一来，即使后端不同，日志记录 API
在所有依赖项中保持一致。这也避免了将日志记录实现与特定包耦合，因为在项目中要求更改时，可以轻松切换到不同的后端。</p>
<p>这是一个使用 <code>Slog</code> 前端和 <code>Zap</code>
后端的示例，可能会提供两全其美的效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get go.uber.org/zap</span><br><span class="line">go get go.uber.org/zap/exp/zapslog</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">    <span class="string">&quot;go.uber.org/zap/exp/zapslog&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    zapL := zap.Must(zap.NewProduction())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> zapL.Sync()</span><br><span class="line"></span><br><span class="line">    logger := slog.New(zapslog.NewHandler(zapL.Core(), <span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">    logger.Info(</span><br><span class="line">        <span class="string">&quot;incoming request&quot;</span>,</span><br><span class="line">        slog.String(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>),</span><br><span class="line">        slog.String(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;/api/user&quot;</span>),</span><br><span class="line">        slog.Int(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码创建了一个新的 <code>Zap</code> 生产日志记录器，随后被用作
<code>Slog</code> 包的处理程序。有了这个，你只需要使用
<code>slog.Logger</code>
上提供的方法来编写日志，但生成的记录将根据提供的 <code>zapL</code>
配置进行处理。</p>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1697453912.4535635,&quot;msg&quot;:&quot;incoming request&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;/api/user&quot;,&quot;status&quot;:200&#125;</span><br></pre></td></tr></table></figure>
<p>切换到不同的日志记录非常简单，因为日志记录是根据
<code>slog.Logger</code> 完成的。例如，您可以像这样从 <code>Zap</code>
切换到 <code>Zerolog</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/rs/zerolog</span><br><span class="line">go get github.com/samber/slog-zerolog</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/rs/zerolog&quot;</span></span><br><span class="line">    slogzerolog <span class="string">&quot;github.com/samber/slog-zerolog&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    zerologL := zerolog.New(os.Stdout).Level(zerolog.InfoLevel)</span><br><span class="line"></span><br><span class="line">    logger := slog.New(</span><br><span class="line">        slogzerolog.Option&#123;Logger: &amp;zerologL&#125;.NewZerologHandler(),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logger.Info(</span><br><span class="line">        <span class="string">&quot;incoming request&quot;</span>,</span><br><span class="line">        slog.String(<span class="string">&quot;method&quot;</span>, <span class="string">&quot;GET&quot;</span>),</span><br><span class="line">        slog.String(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;/api/user&quot;</span>),</span><br><span class="line">        slog.Int(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;time&quot;:&quot;2023-10-16T13:22:33+02:00&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;/api/user&quot;,&quot;status&quot;:200,&quot;message&quot;:&quot;incoming request&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码片段中，<code>Zap</code> 处理程序已被自定义的
<code>Zerolog</code> 处理程序替换。由于日志记录不是使用任何库的自定义
API 进行的，迁移过程只需要几分钟，而不是在整个应用程序中切换一个日志记录
API 到另一个的情况。</p>
<h2 id="编写和存储-go-日志的最佳实践">编写和存储 Go 日志的最佳实践</h2>
<p>一旦您配置了 <code>Slog</code> 或您偏爱的第三方 Go
日志框架，就有必要采用以下最佳实践，以确保您充分利用应用程序日志：</p>
<h3 id="标准化您的日志接口">1. 标准化您的日志接口</h3>
<p>实现 <code>LogValuer</code>
接口可以使您标准化应用程序中各种类型的日志记录，确保它们在日志中的表示在整个应用程序中保持一致。这也是一种有效的策略，可以确保敏感字段不会出现在应用程序日志中，正如我们在本文中之前所探讨的那样。</p>
<h3 id="在错误日志中添加堆栈跟踪">2. 在错误日志中添加堆栈跟踪</h3>
<p>为了提高您在生产环境中调试意外问题的能力，您应该在错误日志中添加堆栈跟踪。这样，就能更容易地确定错误在代码库中的起源位置以及导致问题的程序流程。</p>
<p><code>Slog</code>
目前没有内置的方法来向错误添加堆栈跟踪，但正如我们之前所演示的，可以使用
<code>pkgerrors</code> 或 <code>go-xerrors</code>
等包以及一些辅助函数来实现这个功能。</p>
<h3 id="对您的-slog-语句进行检查以确保一致性">3. 对您的 Slog
语句进行检查，以确保一致性</h3>
<p><code>Slog</code> API
的主要缺点之一是它允许两种不同类型的参数，这可能导致代码库中的不一致性。除此之外，您还希望强制执行一致的键名约定（<code>snake_case</code>、<code>camelCase</code>
等），或者确定日志调用是否应始终包括上下文参数。</p>
<p>像 <code>sloglint</code> 这样的 <code>linter</code>
可以帮助您根据您喜欢的代码风格强制执行 <code>Slog</code>
的各种规则。以下是在通过 <code>golangci-lint</code>
使用时的示例配置：</p>
<p><code>.golangci.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">linters-settings:</span></span><br><span class="line">  <span class="attr">sloglint:</span></span><br><span class="line">    <span class="comment"># Enforce not mixing key-value pairs and attributes.</span></span><br><span class="line">    <span class="comment"># Default: true</span></span><br><span class="line">    <span class="attr">no-mixed-args:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Enforce using key-value pairs only (overrides no-mixed-args, incompatible with attr-only).</span></span><br><span class="line">    <span class="comment"># Default: false</span></span><br><span class="line">    <span class="attr">kv-only:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Enforce using attributes only (overrides no-mixed-args, incompatible with kv-only).</span></span><br><span class="line">    <span class="comment"># Default: false</span></span><br><span class="line">    <span class="attr">attr-only:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Enforce using methods that accept a context.</span></span><br><span class="line">    <span class="comment"># Default: false</span></span><br><span class="line">    <span class="attr">context-only:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Enforce using static values for log messages.</span></span><br><span class="line">    <span class="comment"># Default: false</span></span><br><span class="line">    <span class="attr">static-msg:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Enforce using constants instead of raw keys.</span></span><br><span class="line">    <span class="comment"># Default: false</span></span><br><span class="line">    <span class="attr">no-raw-keys:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Enforce a single key naming convention.</span></span><br><span class="line">    <span class="comment"># Values: snake, kebab, camel, pascal</span></span><br><span class="line">    <span class="comment"># Default: &quot;&quot;</span></span><br><span class="line">    <span class="attr">key-naming-case:</span> <span class="string">snake</span></span><br><span class="line">    <span class="comment"># Enforce putting arguments on separate lines.</span></span><br><span class="line">    <span class="comment"># Default: false</span></span><br><span class="line">    <span class="attr">args-on-sep-lines:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="集中管理日志但首先将它们持久化到本地文件">4.
集中管理日志，但首先将它们持久化到本地文件</h3>
<p>通常最好将编写日志的任务与将其发送到集中式日志管理系统分离。首先将日志写入本地文件可确保在日志管理系统或网络出现问题时备份，防止关键数据的潜在丢失。比如存储到本地，然后通过阿里云的日志客户端上传到阿里云、又或者通过
<code>Logstash</code> 上传到 <code>Elasticsearch</code>。</p>
<p>此外，在发送日志之前将其存储在本地有助于缓冲日志，从而实现批量传输，有助于优化网络带宽使用，并最大程度减少对应用程序性能的影响。</p>
<p>本地日志存储还提供了更大的灵活性，因此，如果需要转换到不同的日志管理系统，只需要在传输方法中进行修改，而不是整个应用程序日志记录机制。</p>
<h3 id="采样你的日志">5. 采样你的日志</h3>
<p>日志抽样是仅记录日志条目的代表性子集的做法，而不是每个日志事件都记录。这种技术在高流量环境中非常有益，因为系统会产生大量的日志数据，处理每个条目可能会非常昂贵，因为集中式日志记录解决方案通常根据数据流入速度或存储数据量收费。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    slogmulti <span class="string">&quot;github.com/samber/slog-multi&quot;</span></span><br><span class="line">    slogsampling <span class="string">&quot;github.com/samber/slog-sampling&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Will print 20% of entries.</span></span><br><span class="line">    option := slogsampling.UniformSamplingOption&#123;</span><br><span class="line">        Rate: <span class="number">0.2</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger := slog.New(</span><br><span class="line">        slogmulti.</span><br><span class="line">            Pipe(option.NewMiddleware()).</span><br><span class="line">            Handler(slog.NewJSONHandler(os.Stdout, <span class="literal">nil</span>)),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">        logger.Info(fmt.Sprintf(<span class="string">&quot;a message from the gods: %d&quot;</span>, i))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;time&quot;:&quot;2023-10-18T19:14:09.820090798+02:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;a message from the gods: 4&quot;&#125;</span><br><span class="line">&#123;&quot;time&quot;:&quot;2023-10-18T19:14:09.820117844+02:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;msg&quot;:&quot;a message from the gods: 5&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用日志管理服务">6. 使用日志管理服务</h3>
<p>将日志集中在日志管理系统中，可以轻松搜索、分析和监控应用程序在多个服务器和环境中的行为。所有日志都集中在一个地方，您可以更快速地识别和诊断问题，不再需要在不同服务器之间跳转以收集有关您的服务的信息。</p>
<p>目前我们使用的是阿里云的日志，但是它的前端性能很差，所以用起来体验较差，优点是部署简单，功能较全。你也可以使用
ElasticSearch 和 <code>Kiabana</code>
来搭建自己的日志系统，但是这个需要自己搭建，成本较高。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们探讨了 Go 语言中日志记录的最佳实践，以及如何使用
<code>Slog</code> 包来实现它们。我们还讨论了如何使用 <code>Slog</code>
与第三方日志后端，以及如何使用 <code>LogValuer</code>
接口标准化日志输出。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"><i class="fa fa-tag"></i> Go</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/01/29/golang/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%20Golang%20%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A5%E5%BF%97%E5%BA%93%20-%20zap/" rel="prev" title="一文搞懂 Golang 高性能日志库 - Zap">
                  <i class="fa fa-angle-left"></i> 一文搞懂 Golang 高性能日志库 - Zap
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/02/01/golang/%E5%A6%82%E4%BD%95%E5%9C%A8%20Go%20%E4%B8%AD%E6%89%A7%E8%A1%8C%20shell%20%E5%91%BD%E4%BB%A4/" rel="next" title="如何在 Go 中执行 shell 命令">
                  如何在 Go 中执行 shell 命令 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">eleven26</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/eleven26" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
