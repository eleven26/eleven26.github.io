<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"eleven26.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="gitlab 可能大家很常用，CI、CD 也应该早有耳闻，但是可能还没有去真正地了解过，这篇文章就是我对 gitlab CI、CD 的一些理解，以及踩过的一些坑，希望能帮助到大家。 什么是 CI、CD CI（Continuous Integration）持续集成，CD（Continuous Deployment）持续部署（也包含了持续交付的意思）。 CI 指的是一种开发过程的的自动化流程，在我们提">
<meta property="og:type" content="article">
<meta property="og:title" content="gitlab ci cd 不完全指南">
<meta property="og:url" content="https://eleven26.github.io/2023/04/16/gitlab/gitlab%20ci%20cd%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="eleven26">
<meta property="og:description" content="gitlab 可能大家很常用，CI、CD 也应该早有耳闻，但是可能还没有去真正地了解过，这篇文章就是我对 gitlab CI、CD 的一些理解，以及踩过的一些坑，希望能帮助到大家。 什么是 CI、CD CI（Continuous Integration）持续集成，CD（Continuous Deployment）持续部署（也包含了持续交付的意思）。 CI 指的是一种开发过程的的自动化流程，在我们提">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://eleven26.github.io/images/gitlab/gitlab_1.png">
<meta property="og:image" content="https://eleven26.github.io/images/gitlab/gitlab_2.png">
<meta property="og:image" content="https://eleven26.github.io/images/gitlab/gitlab_3.png">
<meta property="article:published_time" content="2023-04-16T02:01:00.000Z">
<meta property="article:modified_time" content="2023-04-19T02:26:49.000Z">
<meta property="article:author" content="eleven26">
<meta property="article:tag" content="gitlab">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eleven26.github.io/images/gitlab/gitlab_1.png">


<link rel="canonical" href="https://eleven26.github.io/2023/04/16/gitlab/gitlab%20ci%20cd%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://eleven26.github.io/2023/04/16/gitlab/gitlab%20ci%20cd%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/","path":"2023/04/16/gitlab/gitlab ci cd 不完全指南/","title":"gitlab ci cd 不完全指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>gitlab ci cd 不完全指南 | eleven26</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">eleven26</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">100</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">346</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-cicd"><span class="nav-number">1.</span> <span class="nav-text">什么是 CI、CD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8-cicd"><span class="nav-number">2.</span> <span class="nav-text">为什么要使用 CI、CD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gitlab-cicd"><span class="nav-number">3.</span> <span class="nav-text">gitlab CI、CD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gitlab-cicd-%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">4.</span> <span class="nav-text">gitlab CI、CD
中的一些基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cicd-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.</span> <span class="nav-text">CI、CD 的工作模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gitlab-runner-%E5%92%8C-executor"><span class="nav-number">6.</span> <span class="nav-text">gitlab runner 和 executor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%B8%80%E4%BA%9B%E5%9C%A8%E4%B8%AA%E4%BA%BA%E5%AE%9E%E8%B7%B5%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C"><span class="nav-number">7.</span> <span class="nav-text">其他一些在个人实践中的一些经验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E7%89%B9%E5%AE%9A%E5%88%86%E6%94%AF%E6%89%8D%E4%BC%9A%E6%89%A7%E8%A1%8C%E7%9A%84-job"><span class="nav-number">7.1.</span> <span class="nav-text">指定特定分支才会执行的 job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C-job-%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="nav-number">7.2.</span> <span class="nav-text">不同 job 之间的依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E6%89%A7%E8%A1%8C-job-%E7%9A%84-runner"><span class="nav-number">7.3.</span> <span class="nav-text">指定执行 job 的 runner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A-job-%E7%9A%84-docker-image"><span class="nav-number">7.4.</span> <span class="nav-text">指定 job 的 docker image</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E6%88%91%E4%BB%AC%E7%9A%84%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA-service"><span class="nav-number">7.5.</span> <span class="nav-text">为我们的集成测试指定一个
service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E7%94%A8-yaml-%E9%85%8D%E7%BD%AE%E7%89%87%E6%AE%B5"><span class="nav-number">7.6.</span> <span class="nav-text">复用 yaml 配置片段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cache-vs-artifacts"><span class="nav-number">7.7.</span> <span class="nav-text">cache vs artifacts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A-artifacts-%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="nav-number">7.8.</span> <span class="nav-text">指定 artifacts 的过期时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cache-%E5%8F%AA-pull-%E4%B8%8D-push"><span class="nav-number">7.9.</span> <span class="nav-text">cache 只 pull 不 push</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cache-%E7%9A%84-key-%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6"><span class="nav-number">7.10.</span> <span class="nav-text">cache 的 key 使用文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#script-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-number">7.11.</span> <span class="nav-text">script 中使用多行命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cd---%E5%A6%82%E4%BD%95%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">8.</span> <span class="nav-text">CD - 如何同步代码到服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#error-job-failed-exit-code-xx-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">9.</span> <span class="nav-text">ERROR: Job failed: exit
code xx 解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#job-script-%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">9.1.</span> <span class="nav-text">job script 的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">9.2.</span> <span class="nav-text">解决方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="nav-number">9.3.</span> <span class="nav-text">一个实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">10.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">eleven26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eleven26" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eleven26" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2023/04/16/gitlab/gitlab%20ci%20cd%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="gitlab ci cd 不完全指南 | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          gitlab ci cd 不完全指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-16 10:01:00" itemprop="dateCreated datePublished" datetime="2023-04-16T10:01:00+08:00">2023-04-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>gitlab 可能大家很常用，CI、CD
也应该早有耳闻，但是可能还没有去真正地了解过，这篇文章就是我对 gitlab
CI、CD 的一些理解，以及踩过的一些坑，希望能帮助到大家。</p>
<h2 id="什么是-cicd">什么是 CI、CD</h2>
<p>CI（<em>Continuous Integration</em>）持续集成，CD（<em>Continuous
Deployment</em>）持续部署（也包含了持续交付的意思）。</p>
<p>CI
指的是一种开发过程的的自动化流程，在我们提交代码的时候，一般会做以下操作：</p>
<ul>
<li><code>lint</code> 检查，检查代码是否符合规范</li>
<li>自动运行测试，检查代码是否能通过测试</li>
</ul>
<p>这个过程我们可以称之为
CI，也就是持续集成，这个过程是自动化的，也就是说我们不需要手动去执行这些操作，只需要提交代码，这些操作就会自动执行。</p>
<p>CD 指的是在我们 CI
流程通过之后，将代码自动发布到服务器的过程，这个过程也是自动化的。
在有了前面 CI
的一些操作之后，说明我们的代码是可以安全发布到服务器的，所以就可以进行发布的操作。</p>
<h2 id="为什么要使用-cicd">为什么要使用 CI、CD</h2>
<p>实际上，就算没有 CI、CD
的这些花里胡哨的概念，对于一些重复的操作，我们也会尽量想办法会让它们可以自动化实现的，只不过可能效率上没有这么高，但是也是可以的。</p>
<p>CI、CD 相比其他方式的优势在于：</p>
<ul>
<li>一次配置，多次使用：我们需要做的所有操作都通过配置固定下来了，每次提交代码我们都可以执行相同的操作。</li>
<li>可观测性：我们可以通过 CI、CD
的日志来查看每次操作的执行情况，而且每一次的 CI、CD
执行的日志都会保留下来，这样我们就可以很方便地查看每一次操作的执行情况。</li>
<li>自动化：我们不需要手动去执行 CI、CD 的操作，只需要提交代码，CI、CD
就会自动执行。</li>
<li>少量配置：一般的代码托管平台都会提供 CI、CD
的功能，我们只需要简单的配置一下就可以使用了。同时其实不同平台的 CI、CD
配置也是有很多相似之处的，所以我们只需要学习一种配置方式，就可以在不同平台上使用了。</li>
</ul>
<h2 id="gitlab-cicd">gitlab CI、CD</h2>
<p>在开始之前，我们可以通过下图来了解一下 CI、CD 的整体流程：</p>
<figure>
<img src="/images/gitlab/gitlab_1.png" alt="gitlab_1" />
<figcaption aria-hidden="true">gitlab_1</figcaption>
</figure>
<ol type="1">
<li>在开发人员提交代码之后，会触发 gitlab 的 CI 流水线。也就是上图的
<code>CI PIPELINE</code>，也就是中间的部分。</li>
<li>在 CI 流水线中，我们可以配置多个任务。比如上图的
<code>build</code>、<code>unit test</code>、<code>integration tests</code>
等，也就是构建、单元测试、集成测试等。</li>
<li>在 CI 流水线都通过之后，会触发 CD 流水线。也就是上图的
<code>CD PIPELINE</code>，也就是右边的部分。</li>
<li>在 CD 流水线中，我们可以配置多个任务。比如上图的
<code>staging</code>、<code>production</code>
等，也就是部署到测试环境、部署到生产环境等。</li>
</ol>
<p>在 CD 流程结束之后，我们就可以在服务器上看到我们的代码了。</p>
<h2 id="gitlab-cicd-中的一些基本概念">gitlab CI、CD
中的一些基本概念</h2>
<p>在开始之前，我们先来了解一下 gitlab CI、CD 中的一些基本概念：</p>
<ul>
<li><code>pipeline</code>：流水线，也就是 CI、CD 的整个流程，包含了多个
<code>stage</code>，每个 <code>stage</code> 又包含了多个
<code>job</code>。</li>
<li><code>stage</code>:
一个阶段，一个阶段中可以包含多个任务（<code>job</code>），这些任务会并行执行，但是下一个
<code>stage</code> 的 <code>job</code> 只有在上一个 <code>stage</code>
的 <code>job</code> 执行通过之后才会执行。</li>
<li><code>job</code>：一个任务，这是 CI、CD
中最基本的概念，也是最小的执行单元。一个 <code>stage</code>
中可以包含多个 <code>job</code>，同时这些 <code>job</code>
会并行执行。</li>
<li><code>runner</code>：执行器，也就是执行 <code>job</code>
的机器，<code>runner</code> 跟 gitlab 是分离的，<code>runner</code>
需要我们自己去安装，然后注册到 gitlab 上（不需要跟 gitlab
在同一个服务器上，这样有个好处就是可以很方便实现多个机器来同时处理
gitlab 的 CI、CD 的任务）。</li>
<li><code>tag</code>: <code>runner</code> 和 <code>job</code>
都需要指定标签，<code>job</code> 可以指定一个或多个标签（必须指定，否则
<code>job</code> 不会被执行），这样 <code>job</code> 就只会在指定标签的
<code>runner</code> 上执行。</li>
<li><code>cache</code>:
缓存，可以缓存一些文件，这样下次<strong>流水线</strong>执行的时候就不需要重新下载了，可以提高执行效率。</li>
<li><code>artifacts</code>:
这代表这构建过程中所产生的一些文件，比如打包好的文件，这些文件可以在下一个
<code>stage</code> 中使用，也可以在 <code>pipeline</code>
执行结束之后下载下来。</li>
<li><code>variables</code>：变量，可以在 <code>pipeline</code>
中定义一些变量，这些变量可以在 <code>pipeline</code> 的所有
<code>stage</code> 和 <code>job</code> 中使用。</li>
<li><code>services</code>：服务，可以在 <code>pipeline</code>
中启动一些服务，比如 <code>mysql</code>、<code>redis</code>
等，这样我们就可以在 <code>pipeline</code>
中使用这些服务了（常常用在测试的时候模拟一个服务）。</li>
<li><code>script</code>: 脚本，可以在 <code>job</code>
中定义一些脚本，这些脚本会在 <code>job</code> 执行的时候执行。</li>
</ul>
<h2 id="cicd-的工作模型">CI、CD 的工作模型</h2>
<p>我们以下面的配置为例子，简单说明一下
<code>pipeline</code>、<code>stage</code>、<code>job</code>
的工作模型，以及 <code>cache</code> 和 <code>artifacts</code>
的作用：</p>
<p><code>ci</code> 配置文件（也就是一个 <code>pipeline</code>
的所有任务）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个 pipeline 的所有阶段，一个 pipeline 可以包含多个 stage，每个 stage 又包含多个 job。</span></span><br><span class="line"><span class="comment"># stage 的顺序是按照数组的顺序来执行的，也就是说 stage1 会先执行，然后才会执行 stage2。</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">stage1</span> <span class="comment"># stage 的名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">stage2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个 job，一个 job 就是一个任务，也是最小的执行单元。</span></span><br><span class="line"><span class="attr">job1:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">stage1</span> <span class="comment"># 指定这个 job 所属的 stage，这个 job 只会在 stage1 执行。</span></span><br><span class="line">  <span class="attr">script:</span> <span class="comment"># 指定这个 job 的脚本，这个脚本会在 job 执行的时候执行。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;hello world&quot;</span> <span class="string">&gt;</span> <span class="string">&quot;test.txt&quot;</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="comment"># 指定这个 job 所属的 runner 的标签，这个 job 只会在标签为 tag1 的 runner 上执行。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tag1</span></span><br><span class="line">  <span class="comment"># cache 可以在当前 pipeline 后续的 job 中使用，也可以在后续的 pipeline 中使用。</span></span><br><span class="line">  <span class="attr">cache:</span> <span class="comment"># 指定这个 job 的缓存，这个缓存会在 job 执行结束之后保存起来，下次执行的时候会先从缓存中读取，如果没有缓存，就会重新下载。</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">$CI_COMMIT_REF_SLUG</span> <span class="comment"># 缓存的 key（也可以是文件名列表，那样对应的）</span></span><br><span class="line">    <span class="attr">paths:</span> <span class="comment"># 缓存的路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node_modules/</span></span><br><span class="line">  <span class="attr">artifacts:</span> <span class="comment"># 指定这个 job 的构建产物，这个构建产物会在 job 执行结束之后保存起来。可以在下一个 stage 中使用，也可以在 pipeline 执行结束之后下载下来。</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">test.txt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">job2:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">stage1</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span> <span class="string">test.txt</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tag1</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">$CI_COMMIT_REF_SLUG</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node_modules/</span></span><br><span class="line">    <span class="comment"># 指定这个 job 的缓存策略，只会读取缓存，不会写入缓存。默认是既读取又写入，在 job 开始的时候读取，在 job 结束的时候写入。</span></span><br><span class="line">    <span class="comment"># 但是实际上，只有在安装依赖的时候是需要写入缓存的，其他 job 都使用 pull 即可。</span></span><br><span class="line">    <span class="attr">policy:</span> <span class="string">pull</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># job3 和 job4 都属于 stage2，所以 job3 和 job4 会并行执行。</span></span><br><span class="line"><span class="comment"># job3 和 job4 都指定了 tag2 标签，所以 job3 和 job4 只会在标签为 tag2 的 runner 上执行。</span></span><br><span class="line"><span class="comment"># 同时，在 job1 中，我们指定了 test.txt 作为构建产物，所以 job3 和 job4 都可以使用 test.txt 这个文件。</span></span><br><span class="line"><span class="attr">job3:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">stage2</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span> <span class="string">test.txt</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tag1</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">$CI_COMMIT_REF_SLUG</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node_modules/</span></span><br><span class="line">    <span class="attr">policy:</span> <span class="string">pull</span></span><br><span class="line"></span><br><span class="line"><span class="attr">job4:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">stage2</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span> <span class="string">test.txt</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tag1</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">$CI_COMMIT_REF_SLUG</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node_modules/</span></span><br><span class="line">    <span class="attr">policy:</span> <span class="string">pull</span></span><br></pre></td></tr></table></figure>
<p>上面的配置文件的 <code>pipeline</code>
执行过程可以用下面的图来表示：</p>
<figure>
<img src="/images/gitlab/gitlab_2.png" alt="gitlab_2" />
<figcaption aria-hidden="true">gitlab_2</figcaption>
</figure>
<p>说明：</p>
<ol type="1">
<li>上面的图有两个 <code>pipeline</code> 被执行了，但是
<code>pipeline2</code> 没有全部画出来</li>
<li>其中，在 <code>pipeline 1</code> 中，<code>stage1</code> 中的
<code>job</code> 会先被执行，然后才会执行 <code>stage2</code> 中的
<code>job</code>。</li>
<li><code>stage1</code> 中的 <code>job1</code> 和 <code>job2</code>
是可以<strong>并行</strong>执行的，这也就是 <code>stage</code>
的本质上的含义，表示了一个阶段中不同的任务，比如我们做测试的时候，可以同时对不同模块做测试。</li>
<li><code>job1</code> 和 <code>job2</code> 都指定了 <code>tag1</code>
标签，所以 <code>job1</code> 和 <code>job2</code> 只会在标签为
<code>tag1</code> 的 <code>runner</code> 上执行。</li>
<li><code>job1</code> 中，我们创建了一个 <code>test.txt</code>
文件，这个文件会作为 <code>stage1</code> 的构建产物，它可以在
<code>stage2</code> 中被使用，也就是 <code>job3</code> 和
<code>job4</code>
都可以读取到这个文件。<strong>一种实际的场景是，前端部署的时候，build
之后会生成可以部署的静态文件，这些静态文件就会被保留到部署相关的 stage
中</strong>。需要注意的是，<code>artifacts</code> 只会在当前
<code>pipeline</code> 后续的 <code>stage</code> 中共享，不会在
<code>pipeline</code> 之间共享。</li>
<li>同时，在 <code>job1</code> 中，我们也指定了 <code>cache</code>，这个
<code>cache</code> 会在 <code>job1</code> 执行结束之后保存起来，不同于
<code>artifacts</code>，<code>cache</code> 是可以在不同的
<code>pipeline</code>
之间共享的。一种很常见的使用场景就是我们代码的依赖，比如
<code>node_modules</code> 文件夹，它可以加快后续 <code>pipeline</code>
的执行流程，因为避免了重复的依赖安装。</li>
</ol>
<blockquote>
<p>需要特别注意的是：<code>cache</code> 是跨流水线共享的，而
<code>artifacts</code> 只会在当前流水线的后续 stage 共享。</p>
</blockquote>
<h2 id="gitlab-runner-和-executor">gitlab runner 和 executor</h2>
<p>gitlab <code>runner</code> 在 CI/CD
中是一个非常重要的东西，因为我们写的 CI/CD 的配置就是在
<code>runner</code> 上运行的，如果我们想要执行 CI/CD
任务，我们必须先安装配置 <code>gitlab-runner</code>。</p>
<p>其中 <code>runner</code> 是一台执行 CI/CD 脚本的机器（也就是安装了
<code>gitlab-runner</code> 的机器）。这个机器可以部署在 gitlab
服务器以外的任意一台电脑上，当然也可以跟 gitlab 在同一台服务器。</p>
<p>而每一个 <code>runner</code> 会对应一种特定的
<code>executor</code>，<code>executor</code> 就是我们执行 CI/CD 里面
<code>script</code> 的环境。比如如果我们指定了 <code>executor</code>
类型为 <code>docker</code>，那么我们 CI/CD 脚本里面的
<code>script</code> 将会在一个独立的 docker 容器中执行。</p>
<p>简单来说，<strong><code>runner</code> 是执行 CI/CD
脚本的机器，这个机器上有不同类型的 <code>executor</code>，一个
<code>executor</code> 代表着一个不同类型的命令行终端，最常见的是
<code>shell</code>、<code>docker</code>，当然也支持 widnows 的
<code>powershell</code></strong>。</p>
<p>我们可以通过下图来了解一下 gitlab 是怎么跟 <code>runner</code>
配合的：</p>
<blockquote>
<p>gitlab 是通过 <code>tags</code> 来找到运行脚本的 <code>runner</code>
的，如果 <code>job</code> 的 <code>tags</code> 跟 <code>runner</code> 的
<code>tags</code> 匹配了，就可以将那个 <code>job</code> 放到
<code>runner</code> 上处理。</p>
</blockquote>
<figure>
<img src="/images/gitlab/gitlab_3.png" alt="gitlab_3" />
<figcaption aria-hidden="true">gitlab_3</figcaption>
</figure>
<p>说明：</p>
<ul>
<li>我们在两台机器上安装了 <code>gitlab-runner</code>，它们的 IP 是
<code>192.168.2.123</code> 和 <code>192.168.2.234</code>。</li>
<li><code>test-job</code> 的 <code>tags</code> 中包含了 <code>api</code>
这个 <code>tag</code>，而 <code>runner1</code> 的 <code>tags</code>
也包含了 <code>api</code> 这个 <code>tag</code>，因此
<code>test-job</code> 会被 <code>runner1</code> 执行。</li>
<li>同理，<code>npm-install</code> 这个 <code>job</code> 会被
<code>runner3</code> 处理。</li>
</ul>
<blockquote>
<p>从上图我们可以看到，其实不同的 <code>runner</code>
是有可能位于不同的机器上的。</p>
</blockquote>
<h2
id="其他一些在个人实践中的一些经验">其他一些在个人实践中的一些经验</h2>
<p>gitlab 的 CI、CD
是一个很庞大的话题，同时很多内容可能比较少用，所以本文只是介绍个人在实践中用到的一些内容，其他的东西如果有需要，可以自行查阅官方文档。</p>
<h3 id="指定特定分支才会执行的-job">指定特定分支才会执行的 job</h3>
<p>这个算是基本操作了，我们可以通过 <code>only</code>
来指定特定分支才会执行的 <code>job</code>，也有其他方法可以实现，比如
<code>rules</code>，具体请参考官方文档。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy-job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="comment"># 当前的这个 job 只会在 master 分支代码更新的时候会执行</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;master&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="不同-job-之间的依赖">不同 job 之间的依赖</h3>
<p>这个也是基本操作，我们可以通过 <code>needs</code> 来指定不同
<code>job</code> 之间的依赖关系，比如 <code>job1</code> 依赖
<code>job2</code>，那么 <code>job1</code> 就会在 <code>job2</code>
执行完毕之后才会执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job1:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">needs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">job2</span></span><br></pre></td></tr></table></figure>
<h3 id="指定执行-job-的-runner">指定执行 job 的 runner</h3>
<p>我们可以通过 <code>tags</code> 来指定 <code>job</code> 执行的
<code>runner</code>，比如我们可以指定 <code>job</code> 只能在
<code>api</code> 标签的 <code>runner</code> 上执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build-job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果我们没有标签为 <code>api</code> 的 <code>runner</code>，那么这个
<code>job</code> 就会一直不会被执行，所以需要确保我们配置的
<code>tag</code> 有对应的 <code>runner</code>。</p>
</blockquote>
<h3 id="指定-job-的-docker-image">指定 job 的 docker image</h3>
<blockquote>
<p>注意：这个只在我们的 <code>runner</code> 的 <code>executor</code> 为
<code>docker</code> 的时候才会生效。也就是我们的 <code>runner</code>
是一个 <code>docker</code> 容器。</p>
</blockquote>
<p>有时候，我们需要执行一些特定命令，但是我们全局的 <code>docker</code>
镜像里面没有，可能只需要一个特定的 <code>docker</code>
镜像，这个时候我们可以通过 <code>image</code> 来指定 <code>job</code> 的
<code>docker</code> 镜像。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy-job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="comment"># 指定 runner 的 docker image</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="comment"># 下面这个命令只在上面指定的 docker 镜像中存在</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">.</span> <span class="string">root@example.com:/home/www/foo</span></span><br></pre></td></tr></table></figure>
<h3 id="为我们的集成测试指定一个-service">为我们的集成测试指定一个
service</h3>
<p>在我们的 CI
流程中，可能会有一些集成测试需要使用到一些服务，比如我们的
<code>mysql</code>，这个时候我们可以通过 <code>services</code>
来指定我们需要的服务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">test_rabbitmq:</span></span><br><span class="line">  <span class="comment"># 这会启动一个 rabbitmq 3.8 的 docker 容器，我们的 job 就可以使用这个容器了。</span></span><br><span class="line">  <span class="comment"># 我们的 job 可以连接到一个 rabbitmq 的服务，然后进行测试。</span></span><br><span class="line">  <span class="comment"># 需要注意的是，这个容器只会在当前 job 执行的时候存在，执行完毕之后就会被删除。所以产生的数据不会被保留。</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rabbitmq:3.8</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">go</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="comment"># 下面的测试命令会连接到上面启动的 rabbitmq 服务</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;go test -v -cover ./pkg/rabbitmq&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="复用-yaml-配置片段">复用 yaml 配置片段</h3>
<p>在 <code>yaml</code> 中，有一种机制可以让我们复用 <code>yaml</code>
配置片段，比如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发布代码的 job</span></span><br><span class="line"><span class="string">.deploy-job:</span> <span class="string">&amp;release-job</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">.</span> <span class="string">root@example.com:/home/www/foo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-release:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*release-job</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;release&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-master:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*release-job</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;master&quot;</span></span><br></pre></td></tr></table></figure>
<p>上面的代码中，我们定义了一个 <code>release-job</code>
的配置片段，然后在 <code>deploy-release</code> 和
<code>deploy-master</code>
中，我们都引用了这个配置片段，这样我们就可以复用这个配置片段了。
等同于下面的代码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发布代码的 job</span></span><br><span class="line"><span class="string">.deploy-job:</span> <span class="string">&amp;release-job</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">.</span> <span class="string">root@example.com:/home/www/foo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-release:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">.</span> <span class="string">root@example.com:/home/www/foo</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;release&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy-master:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">.</span> <span class="string">root@example.com:/home/www/foo</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;master&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 <code>yaml</code> 的术语中，这一种机制叫做
<code>anchor</code>。</p>
</blockquote>
<h3 id="cache-vs-artifacts">cache vs artifacts</h3>
<p>初次使用的人，可能会对这个东西有点迷惑，因为它们好像都是缓存，但是实际上，它们的用途是不一样的。</p>
<ul>
<li><code>cache</code> 是用来缓存依赖的，比如 <code>node_modules</code>
文件夹，它可以加快后续 <code>pipeline</code>
的执行流程，因为避免了重复的依赖安装。</li>
<li><code>artifacts</code> 是用来缓存构建产物的，比如 <code>build</code>
之后生成的静态文件，它可以在后续的 <code>stage</code>
中使用。<strong>表示的是单个 pipeline 中的不同 stage
之间的共享</strong>。</li>
</ul>
<h3 id="指定-artifacts-的过期时间">指定 artifacts 的过期时间</h3>
<p>我们可以通过 <code>expire_in</code> 来指定 <code>artifacts</code>
的过期时间，比如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job1:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;release&quot;</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/apidoc:1.0.0</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">public</span></span><br><span class="line">    <span class="attr">expire_in:</span> <span class="number">1</span> <span class="string">hour</span></span><br></pre></td></tr></table></figure>
<p>因为我们的 <code>artifacts</code>
有时候只是生成一些需要部署到服务器的东西，然后在下一个
<code>stage</code> 使用，所以是不需要长期保留的。所以我们可以通过
<code>expire_in</code> 来指定一个比较短的 <code>artifacts</code>
的过期时间。</p>
<h3 id="cache-只-pull-不-push">cache 只 pull 不 push</h3>
<p>gitlab CI 的 <code>cache</code> 有一个 <code>policy</code>
属性，它的值默认是 <code>pull-push</code>，也就是在 <code>job</code>
开始执行的时候会拉取缓存，在 <code>job</code>
执行结束的时候会将缓存指定文件夹的内容上传到 gitlab 中。</p>
<p>但是在实际使用中，我们其实只需要在安装依赖的时候上传这些缓存，其他时候都只是读取缓存的。所以我们在安装依赖的
job 中使用默认的 <code>policy</code>，而在后续的 <code>job</code>
中，我们可以通过 <code>policy: pull</code>
来指定只拉取缓存，不上传缓存。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job:</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">composer.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">composer.lock</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;vendor/&quot;</span></span><br><span class="line">    <span class="attr">policy:</span> <span class="string">pull</span>  <span class="comment"># 只拉取 vendor，在 job 执行完毕之后不上传 vendor</span></span><br></pre></td></tr></table></figure>
<h3 id="cache-的-key-使用文件">cache 的 key 使用文件</h3>
<p>这一个特性是非常有用的，在现代软件工程的实践中，往往通过
<code>*.lock</code>
文件来记录我们使用的额依赖的具体版本，以保证在不同环境中使用的时候保持一致的行为。</p>
<p>所以，相应的，我们的缓存也可以在 <code>*.lock</code>
这类文件发生变化的时候，重新生成缓存。上面的例子就使用了这种机制。</p>
<h3 id="script-中使用多行命令">script 中使用多行命令</h3>
<p>在 <code>script</code> 中，我们可以使用多行命令，比如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="comment"># 我们可以通过下面这种方式来写多行的 shell 命令，也就是以一个竖线开始，然后换行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">      if [ &quot;$release_host&quot; != &quot;&quot; ]; then</span></span><br><span class="line"><span class="string">        host=$release_host</span></span><br><span class="line"><span class="string">      fi</span></span><br></pre></td></tr></table></figure>
<h2 id="cd---如何同步代码到服务器">CD - 如何同步代码到服务器</h2>
<p>如果我们的项目需要部署到服务器上，那么我们还需要做一些额外的操作，比如同步代码到服务器上。
如果我们的 gitlab 是通过容器执行的（也就是说 gitlab 是通过 docker
启动的），或者我们的 runner 的 executor 是
docker，那么有一种比较常见的方法是通过 ssh 私钥来进行部署。</p>
<p>我们可以通过以下流程来实现：</p>
<ol type="1">
<li>新建一对 ssh key，比如 <code>id_rsa</code> 和
<code>id_rsa.pub</code>。</li>
<li>将 <code>id_rsa.pub</code> 的内容添加到服务器的
<code>authorized_keys</code> 文件中。</li>
<li>将 <code>id_rsa</code> 上传到 gitlab 中（在项目的 CI/CD
配置中，配置一个变量，变量名为 <code>PRIVATE_KEY</code>，内容为
<code>id_rsa</code> 的内容，类型为 <code>file</code>）。</li>
<li>在我们的 <code>ci</code> 配置文件中，添加如下配置即可：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">$PRIVATE_KEY</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">eleven26/rsync:1.3.0</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="comment"># $user 是 ssh 的用户</span></span><br><span class="line">    <span class="comment"># $host 是 ssh 的主机</span></span><br><span class="line">    <span class="comment"># $port 是 ssh 的端口</span></span><br><span class="line">    <span class="comment"># $PRIVATE_KEY 是我们在 gitlab 中配置的私钥</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">-az</span> <span class="string">-e</span> <span class="string">&quot;ssh -o StrictHostKeyChecking=no -p $port -i $PRIVATE_KEY&quot;</span> <span class="string">--delete</span> <span class="string">--exclude=&#x27;.git&#x27;</span> <span class="string">.</span> <span class="string">$user@$host:/home/www</span></span><br></pre></td></tr></table></figure>
<p>这里的 <code>rsync</code> 命令中，我们使用了
<code>-o StrictHostKeyChecking=no</code>
参数，这是为了避免每次都需要手动输入 <code>yes</code>
来确认服务器的指纹。</p>
<p>安全最佳实践：</p>
<ul>
<li>为每一个 project 配置 ssh key 变量，如果是全局变量的话，其他 project
可以在未授权的情况下，访问到这个私钥，这是非常危险的。</li>
<li>使用单独的仓库来保存 ci 配置文件，防止其他人未经授权就修改 ci
配置文件，这也是非常危险的。</li>
</ul>
<blockquote>
<p>必须严格遵循以上两步，否则会造成严重的安全问题。因为拿到了私钥，就等于拿到了我们的服务器密码。</p>
</blockquote>
<h2 id="error-job-failed-exit-code-xx-解决方案">ERROR: Job failed: exit
code xx 解决方案</h2>
<p>我们在使用的时候可能会经常遇到这种错误（在 <code>job</code>
执行的输出里面），如果运气好，在输出里面也有一些额外的错误信息，
这种是最好处理的，它已经告诉你错误原因了。还有一种非常坑爹的情况是：<code>job</code>
失败了，只有一个非 0
的退出状态码，但是没有任何的报错信息，这种情况就比较难处理（更加坑爹的是，偶尔出现这种失败）。</p>
<h3 id="job-script-的执行流程">job script 的执行流程</h3>
<p>如果我们理解了 gitab CI/CD 中 <code>job</code>
的执行原理，那么这个问题其实就很好解决了，<code>job</code> 的
<code>script</code> 执行流程如下：</p>
<ol type="1">
<li>拿到 <code>script</code> 中第一条命令，然后执行。</li>
<li>检查上一步的退出状态码，如果状态码为
0，继续执行下一条命令。否则，<code>job</code> 直接失败，然后显示信息
<code>ERROR: Job failed: exit code &lt;xx&gt;</code>，最后的
<code>&lt;xx&gt;</code> 就是上一条命令的非 0 的那个退出状态码。</li>
<li>按以上两个步骤来一条条执行 <code>script</code> 中的命令。</li>
</ol>
<blockquote>
<p>如果使用的是 bash shell，我们可以通过 echo $?
来获取上一条命令的退出状态码。状态码方面的约定都是：0 表示成功，非 0
表示不成功。</p>
</blockquote>
<h3 id="解决方法">解决方法</h3>
<p>知道了 <code>job</code>
的执行原理之后，问题就很好解决了，我们只需要在 <code>job</code>
执行日志中找到最后那一条命令即可：</p>
<ol type="1">
<li>先看这个命令是否有执行失败相关的错误输出信息，如果有，那么解决对应错误即可。</li>
<li>如果这个执行失败的命令，一点输出都没有。那么我们可以深入了解一下这个命令的退出状态码什么时候等于我们
<code>job</code> 的状态码，然后再对症下药。</li>
</ol>
<h3 id="一个实例">一个实例</h3>
<p>下面是一个 <code>job</code>
日志的最后几行，但是不包含具体的错误信息：</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="keyword">if</span> (( <span class="variable">$need_restart_queue</span> == 1 )); <span class="keyword">then</span> ssh <span class="variable">$user</span>@<span class="variable">$host</span> <span class="string">&quot;supervisorctl restart xx&quot;</span>; <span class="keyword">fi</span></span></span><br><span class="line">Cleaning up project directory and file based variables</span><br><span class="line">ERROR: Job failed: exit code 1, no message</span><br></pre></td></tr></table></figure>
<p>第一行是执行的命令，这个命令中，通过 <code>ssh</code>
执行了一条远程命令，然后退出。第二行是 <code>job</code>
失败后做清理操作输出的日志，最后一行输出 <code>job</code>
失败的错误码。</p>
<blockquote>
<p>就是这个错误，困扰了我几天，因为它是偶尔失败的。</p>
</blockquote>
<p>在这个例子中，比上面说到的要复杂一点，这里通过了 <code>ssh</code>
来执行远程命令，<strong>如果通过 <code>ssh</code> 执行远程命令，那么
<code>ssh</code>
命令的退出状态码就是执行的那个远程命令的退出状态码。</strong>
明确了这一点，我们就可以把问题定位在那个远程命令
<code>supervisorctl restart xx</code>
上，也就是说我们的失败是因为这个命令导致的。</p>
<p>后面排查发现，<code>supervisorctl</code>
命令本身就有一定几率失败，针对这种情况，有两种解决方案：</p>
<ol type="1">
<li>重试，可以给 <code>job</code> 指定重试次数，可以是 0～2，也就是说
gitlab 的 <code>job</code> 最多可以重试 2 次。</li>
<li>忽略这个错误，使用其他解决方案。（我们可以在 <code>ssh</code>
命令后面加上 <code>|| true</code> 来忽略，加上这个，命令退出状态码一定是
0 了）</li>
</ol>
<blockquote>
<p>我是采取了后面那一种解决方法，因为服务器上还有一个定时任务来检测对应的进程，如果进程不存在，则会使用
<code>supervisorctl start xx</code> 来启动对应的服务。</p>
</blockquote>
<h2 id="总结">总结</h2>
<p>最后，总结一下本文中一些比较关键的内容：</p>
<ul>
<li>gitlab 中的一些基本概念：
<ul>
<li><code>pipeline</code>：代表了一次 CI 的执行过程，它包含了多个
<code>stage</code>。</li>
<li><code>stage</code>：代表了一组 <code>job</code>
的集合，<code>stage</code> 会按照顺序执行。</li>
<li><code>job</code>：代表了一个具体的任务，比如
<code>build</code>、<code>test</code>、<code>deploy</code> 等。</li>
</ul></li>
<li>一个 <code>stage</code> 中的多个 <code>job</code>
是可以并行执行的。但是下一个 <code>stage</code> 的 <code>job</code>
必须要等到上一个 <code>stage</code> 的所有 <code>job</code>
都执行完毕之后才会执行。</li>
<li><code>cache</code> 和 <code>artifacts</code> 的区别：
<ul>
<li><code>cache</code> 是用来缓存依赖的，比如 <code>node_modules</code>
文件夹，它可以加快后续 <code>pipeline</code>
的执行流程，因为避免了重复的依赖安装。</li>
<li><code>artifacts</code> 是用来缓存构建产物的，比如 <code>build</code>
之后生成的静态文件，它可以在后续的 <code>stage</code>
中使用。<strong>表示的是单个 pipeline 中的不同 stage
之间的共享</strong>。</li>
</ul></li>
<li><code>cache</code> 在安装依赖的 <code>job</code> 中才需要使用默认的
<code>policy</code>，也就是
<code>pull-push</code>，在其他不需要安装依赖的 <code>job</code> 中使用
<code>pull</code> 就可以了，不需要上传缓存。</li>
<li><code>cache</code> 的 <code>key</code>
可以指定多个文件，这样在指定的文件变动的时候，缓存会失效，这往往用在依赖相关的文件中。</li>
<li>可以使用 <code>services</code> 关键字来指定需要启动的服务，比如
<code>mysql</code>、<code>redis</code> 等，在 job 中可以连接到这些
services，从而方便进行测试。</li>
<li>可以使用 <code>yaml</code> 的 <code>anchor</code>
机制来复用一些配置片段，可以少写很多重复的配置。</li>
<li>一个 <code>job</code> 必须运行在某个 <code>runner</code>
上，<code>job</code> 和 <code>runner</code> 的关联是通过
<code>tag</code> 来指定的。</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/gitlab/" rel="tag"><i class="fa fa-tag"></i> gitlab</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/02/golang/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20go%20RWMutex/" rel="prev" title="深入理解 go RWMutex">
                  <i class="fa fa-angle-left"></i> 深入理解 go RWMutex
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/18/mac/macOS%20launchd%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/" rel="next" title="macOS launchd 不完全指南">
                  macOS launchd 不完全指南 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">eleven26</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/eleven26" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
