<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"eleven26.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="eleven26">
<meta property="og:url" content="https://eleven26.github.io/page/19/index.html">
<meta property="og:site_name" content="eleven26">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="eleven26">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://eleven26.github.io/page/19/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/19/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>eleven26</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">eleven26</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">100</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">346</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">eleven26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eleven26" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eleven26" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2022/10/27/mysql/SQL%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/27/mysql/SQL%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">SQL 优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-27 09:41:00" itemprop="dateCreated datePublished" datetime="2022-10-27T09:41:00+08:00">2022-10-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="插入数据">插入数据</h2>
<p>插入多条数据的优化方式：</p>
<ol type="1">
<li>批量插入</li>
</ol>
<blockquote>
<p>一次插入数据不建议超过 1000
条，如果要插入的数据太多，可以分批插入</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl <span class="keyword">values</span> (a, b), (c, d);</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>手动提交事务</li>
</ol>
<blockquote>
<p>MySQL
里面的事务提交方式默认是自动提交的，也就是执行一条语句会提交一次，这样效率很低。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl <span class="keyword">values</span> (a, b), (c, d);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl <span class="keyword">values</span> (a1, b1), (c1, d1);</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>主键顺序插入</li>
</ol>
<p>主键顺序插入的性能要高于乱序插入的性能。见下一节。</p>
<ol start="4" type="1">
<li>大批量插入数据（如 100w 条）</li>
</ol>
<p>如果一次性需要插入大批量数据，使用 insert
语句插入性能较低，此时可以使用 MySQL 数据库提供的 load
指令进行插入。</p>
<p>通过 load
指令，我们可以一次性将本地磁盘文件中的数据全部加载进数据库表结构当中。</p>
<p>操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1,a,b,2022-10-27</span><br><span class="line">2,c,d,2022-10-28</span><br></pre></td></tr></table></figure>
<p>磁盘文件为 csv 格式，通过 load
命令可以将这个文件的全部内容加载到数据库中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端连接服务端时，加上参数 --local-infile</span></span><br><span class="line">mysql --local-infile -u root -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置全局参数 local_infile 为 1，开启从本地加载文件导入数据的开关</span></span><br><span class="line">set global local_infile=1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行 load 指令将准备好的数据，加载到表结构中</span></span><br><span class="line">load data local infile &quot;/Users/ruby/a.csv&quot; into table tbl fields terminated by &quot;,&quot; lines terminated by &quot;\n&quot;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>100w 的数据通过 load data 耗时十几秒，但是通过读取然后 insert
的方式需要 10 分钟。</p>
</blockquote>
<blockquote>
<p>主键顺序插入性能高于乱序插入。</p>
</blockquote>
<h2 id="主键优化">主键优化</h2>
<ul>
<li>InnoDB 数据组织方式</li>
</ul>
<p>在 InnoDB
存储引擎中，<strong>表数据都是根据主键顺序组织存放的</strong>，这种存储方式的表称为<strong>索引组织表</strong>（index
organized table IOT）。</p>
<ul>
<li>页分裂</li>
</ul>
<p>页可以为空，也可以填充一半，也可以填充 100%。每个页包含了 2-N
行数据（如果一行数据过大，会行溢出），根据主键排列。</p>
<p><strong>在前后两个页满的时候，如果插入的主键也要插入这其中的一页，那么就会导致页分裂。</strong></p>
<ul>
<li>页合并</li>
</ul>
<p>当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记为删除并且它的空间变得允许被其他记录声明使用。</p>
<p><strong>当页中删除的记录达到 MERGE_THRESHOLD（默认为页的
50%），InnoDB
会开始寻找最靠近的页（前或后）看看是否可以将两个页合并以优化空间使用。</strong></p>
<p><a
target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/index-page-merge-threshold.html">MERGE_THRESHOLD
参考文档</a></p>
<blockquote>
<p>MERGE_THRESHOLD：合并页的阈值，可以自己设置，在创建表或者创建索引时指定。</p>
</blockquote>
<ul>
<li>主键设计原则</li>
</ul>
<ol type="1">
<li>满足业务需求的情况下，尽量降低主键的长度。（减少空间占用，除了主键索引会使用主键，二级索引的叶子结点存的也是主键的值）</li>
<li>插入数据时，尽量选择顺序插入，选择使用 AUTO_INCREMENT
自增主键。（乱序插入可能会导致页分裂）</li>
<li>尽量不要使用 UUID
做主键或者是其他自然主键，如身份证号。（因为这些数据插入的时候其实就等于是乱序插入，而且占用空间也会比整型自增主键，int
是固定的 4 字节，身份证号十几个字节了）</li>
<li>业务操作时，避免对主键的修改。（会导致主键索引的调整）</li>
</ol>
<h2 id="order-by-优化">order by 优化</h2>
<blockquote>
<p>目的：通过建立合适的索引，优化去掉 filesort。</p>
</blockquote>
<h3 id="mysql-里面的排序有哪些">MySQL 里面的排序有哪些？</h3>
<ul>
<li>Using filesort:
通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区 sort
buffer 中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫
filesort 排序。</li>
<li>Using index: 通过有序索引顺序扫描直接返回有序数据，这种情况即为
using index，不需要额外排序，操作效率高。</li>
</ul>
<blockquote>
<p>优化 order by 语句的时候，尽量优化为 using index。</p>
</blockquote>
<h3 id="如果知道-order-by-使用了哪种方式">如果知道 order by
使用了哪种方式？</h3>
<p>使用 explain，extra 会显示排序使用了哪种方式。</p>
<h3 id="如何优化">如何优化？</h3>
<ol type="1">
<li>order by 的字段加索引。(多个字段的话，建立联合索引)</li>
<li>如果是多个字段的排序，则创建索引的时候，不同字段的顺序要跟排序时候的顺序一致。如
order by a asc, b desc 语句，则建立索引的时候就需要是 a 顺序，b
逆序。</li>
</ol>
<blockquote>
<p>show index from tbl; 结果里面的 collation 的 A 表示是升序，D
表示是降序。</p>
</blockquote>
<h3 id="示例">示例</h3>
<blockquote>
<p>前提：覆盖索引。如果是 select * 则又是 using filesort 了。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 没有创建索引时，根据 age，phone 进行排序。排序的方式显示是 using filesort</span></span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> age,phone;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">create</span> index idx_user_age_phone_aa <span class="keyword">on</span> <span class="keyword">user</span>(age,phone);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引后，根据 age,phone 进行升序排序。排序的方式显示是 using index</span></span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> age,phone;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引后，根据 age,phone 进行降序排序。排序的方式依然是 using index，这是因为索引是双向的链表结构。</span></span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">desc</span>, phone <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 根据 age,phone 一个升序，一个降序。排序的方式也出现了 using filesort</span></span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引。一个字段升序，一个字段降序。</span></span><br><span class="line"><span class="keyword">create</span> index idx_user_age_phone_ad <span class="keyword">on</span> <span class="keyword">user</span>(age <span class="keyword">asc</span>,phone <span class="keyword">desc</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 根据 age,phone 进行一个字段升序，一个字段降序的排序。排序方式显示 using index。</span></span><br><span class="line">explain <span class="keyword">select</span> id,age,phone <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, phone <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>using index
意味着从索引返回的数据已经是有序的了，所以不需要再进行排序。</p>
</blockquote>
<h3 id="order-by-优化总结">order by 优化总结</h3>
<ul>
<li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则。</li>
<li>尽量使用覆盖索引。</li>
<li>多字段排序，一个升序一个降序，此时需要注意联合索引在创建时的规则（ASC/DESC）。</li>
<li>如果不可避免的出现
filesort，大数据量排序时，可以适当增大排序缓冲区大小
sort_buffer_size（默认
256K）。（如果要排序的数据太多可能会用到磁盘文件来排序）</li>
</ul>
<h2 id="group-by-优化">group by 优化</h2>
<p>索引对于分组操作的影响。</p>
<blockquote>
<p>关键：联合索引、覆盖索引。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行分组操作，根据 profession 字段进行分组。显示没有用到索引，extra 显示 using temporary。</span></span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引。</span></span><br><span class="line"><span class="keyword">create</span> index idx_user_pro_age_sta <span class="keyword">on</span> <span class="keyword">user</span>(profession, age, status);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行分组操作，根据 profession 字段进行分组。用到了索引 idx_user_pro_age_sta，extra 显示 using index。</span></span><br><span class="line">explain <span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行分组操作，根据 profession,age 字段进行分组。用到了索引 idx_user_pro_age_sta，extra 显示 using index。</span></span><br><span class="line">explain <span class="keyword">select</span> profession, age, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> profession,age;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用到了索引 idx_user_pro_age_sta，extra 显示 using index。</span></span><br><span class="line">explain <span class="keyword">select</span> age,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> profession<span class="operator">=</span><span class="string">&#x27;软件工程&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> age;</span><br></pre></td></tr></table></figure>
<h3 id="总结">总结</h3>
<ul>
<li>在分组操作时，可以通过索引来提高效率。</li>
<li>分组操作时，索引的使用也是满足最左前缀法则的。</li>
</ul>
<h2 id="limit-优化">limit 优化</h2>
<p>一个常见又非常头疼的问题就是 <code>limit 2000000,10</code>，此时需要
MySQL 排序前 2000010 条记录，然后仅仅返回 <code>2000000-2000010</code>
的记录，其他记录丢弃，查询排序的代价非常大。</p>
<h3 id="优化思路">优化思路</h3>
<p><strong>覆盖索引 + 子查询。</strong></p>
<p>一般分页查询时，通过创建覆盖索引能够比较好地提高性能，可以通过覆盖索引加子查询形式进行优化。</p>
<h3 id="实例">实例</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 5s</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sku limit <span class="number">100000</span>,<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化，0.133 秒</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> sku a, (<span class="keyword">SELECT</span> id <span class="keyword">from</span> sku LIMIT <span class="number">100000</span>,<span class="number">10</span>) <span class="keyword">as</span> b <span class="keyword">WHERE</span> a.id <span class="operator">=</span> b.id</span><br><span class="line"></span><br><span class="line"><span class="comment">-- limit 500000,10 的时候，第一种方式 22s，第二种方式 0.35s</span></span><br></pre></td></tr></table></figure>
<h3 id="分析">分析</h3>
<ul>
<li>在上面第一个语句中，因为是 <code>select *</code>
所以这个查询没有用到索引，是全表扫描。</li>
<li>而在第二个查询中，我们先是在子查询里面查询出了
id，而这个查询因为用到了索引，所以会快很多。</li>
<li>然后拿到 id 后再去匹配 <code>sku</code>
表，这个过程也能用到索引，所以就会快很多。</li>
</ul>
<h2 id="count-优化">count 优化</h2>
<ul>
<li>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行
<code>count(*)</code> 的时候会直接返回这个数，效率很高。（前提：没有
where）</li>
<li>InnoDB 执行 <code>count(*)</code>
的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数。</li>
</ul>
<p><strong>优化思路：自己计数。如借助 redis，执行插入的时候
+1，删除的时候 -1。</strong></p>
<h3 id="count-的几种方法">count 的几种方法</h3>
<ul>
<li><p><code>count()</code>
是一个聚合函数，对于返回的结果集，一行行地判断，如果 <code>count</code>
函数的参数不是 <code>NULL</code>，累计值就加
1，否则不加，最后返回累加值。</p></li>
<li><p>用法：<code>count(*)</code>、<code>count(主键)</code>、<code>count(字段)</code>、<code>count(1)</code>。<code>count(字段)</code>
会判断 <code>NULL</code>。</p></li>
<li><p><code>count(主键)</code>: InnoDB 引擎会遍历整张表，把每一行的主键
id
值都取出来，返回给服务层。服务层拿到主键后，直接按行进行累加（主键不可能为
null）。</p></li>
<li><p><code>count(字段)</code>: 没有 <code>not null</code> 约束，InnoDB
引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，服务层判断是否为
null，不为 null，计数累加。有 <code>not null</code> 约束，InnoDB
引擎会遍历整张表把每一行的字段都取出来，返回给服务层，直接按行进行累加。</p></li>
<li><p><code>count(*)</code>: InnoDB
引擎并不会把全部字段取出来，而是专门做了优化，不取值，服务层直接按行进行累加。</p></li>
<li><p><code>count(1)</code>: InnoDB
引擎遍历整张表，但不取值。服务层对于返回的每一行，放一个数字 1
进去，直接按行进行累加。</p></li>
</ul>
<blockquote>
<p>按照效率排序的话，count(字段) &lt; count(主键) &lt; count(1) ≈
count(*)，所以尽量使用 <code>count(*)</code>。</p>
</blockquote>
<h2 id="update-优化">update 优化</h2>
<blockquote>
<p>事务不提交，锁不会释放。</p>
</blockquote>
<p>InnoDB
的行锁是针对索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级为表锁。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2022/10/14/hyperf/hyperf%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/14/hyperf/hyperf%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" class="post-title-link" itemprop="url">hyperf 服务注册与服务发现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-14 09:34:00" itemprop="dateCreated datePublished" datetime="2022-10-14T09:34:00+08:00">2022-10-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言">前言</h2>
<p>在 hyperf 里，支持 Consul 和 Nacos 作为服务中心的组件，本文使用
Consul 作为服务中心演示 hyperf 里面的服务注册与服务发现。</p>
<h2 id="依赖的组件">依赖的组件</h2>
<ul>
<li><code>hyperf/json-rpc</code></li>
<li><code>hyperf/rpc-client</code></li>
<li><code>hyperf/rpc-server</code></li>
<li><code>hyperf/service-governance</code></li>
<li><code>hyperf/service-governance-consul</code></li>
</ul>
<h2 id="docker-网络">docker 网络</h2>
<p>在本文的实验环境下，服务提供者、服务消费者以及服务中心都在同一个
docker 网络下，下面的命令是创建 docker 网络的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create hyperf</span><br></pre></td></tr></table></figure>
<h2 id="启动-consul">启动 consul</h2>
<p>下面的命令启动了一个 <code>consul</code> 容器，并且加入了名为
<code>hyperf</code> 的 docker
网络，这样就可以方便跟服务提供者、服务消费者进行网络通信：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --network=&quot;hyperf&quot; -p 8500:8500 -p 8400:8400 -p 8600:8600 --name=&quot;consul&quot; consul</span><br></pre></td></tr></table></figure>
<h2 id="服务提供者">服务提供者</h2>
<h3 id="新建项目">新建项目</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器</span></span><br><span class="line">docker run --name provider \</span><br><span class="line">    -v /workspace/skeleton:/data/project \</span><br><span class="line">    -p 9501:9501 -it \</span><br><span class="line">    --privileged -u root \</span><br><span class="line">    --entrypoint /bin/sh \</span><br><span class="line">    --network=&quot;hyperf&quot; \</span><br><span class="line">    hyperf/hyperf:7.4-alpine-v3.11-swoole</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在容器里面进行安装 hyperf，安装的时候需要选择的话全部回车，使用默认选项</span></span><br><span class="line">composer create-project hyperf/hyperf-skeleton</span><br><span class="line"></span><br><span class="line">cd hyperf-skeleton</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖</span></span><br><span class="line">composer require hyperf/json-rpc</span><br><span class="line">composer require hyperf/rpc-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装服务注册与发现的依赖</span></span><br><span class="line">composer require hyperf/service-governance</span><br><span class="line">composer require hyperf/service-governance-consul</span><br></pre></td></tr></table></figure>
<h3 id="配置服务提供者">配置服务提供者</h3>
<p>打开文件 <code>config/autoload/server.php</code>，在
<code>servers</code> 块里面添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#x27;name&#x27; =&gt; &#x27;jsonrpc-http&#x27;,</span><br><span class="line">    &#x27;type&#x27; =&gt; Server::SERVER_HTTP,</span><br><span class="line">    &#x27;host&#x27; =&gt; &#x27;0.0.0.0&#x27;,</span><br><span class="line">    &#x27;port&#x27; =&gt; 9503,</span><br><span class="line">    &#x27;sock_type&#x27; =&gt; SWOOLE_SOCK_TCP,</span><br><span class="line">    &#x27;callbacks&#x27; =&gt; [</span><br><span class="line">        Event::ON_REQUEST =&gt; [Hyperf\JsonRpc\HttpServer::class, &#x27;onRequest&#x27;],</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<h3 id="定义服务接口类">定义服务接口类</h3>
<p>创建接口类：<code>app/Contracts/CalculatorServiceInterface.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Contracts</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CalculatorServiceInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$a</span>, <span class="keyword">int</span> <span class="variable">$b</span></span>): <span class="title">int</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义接口实现类">定义接口实现类</h3>
<p>创建实现类：<code>app/JsonRpc/CalculatorService.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">JsonRpc</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Contracts</span>\<span class="title">CalculatorServiceInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Hyperf</span>\<span class="title">RpcServer</span>\<span class="title">Annotation</span>\<span class="title">RpcService</span>; <span class="comment">// 这个不能去掉</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注意，如希望通过服务中心来管理服务，需在注解内增加 publishTo 属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@RpcService</span>(name=&quot;CalculatorService&quot;, protocol=&quot;jsonrpc-http&quot;, server=&quot;jsonrpc-http&quot;, publishTo=&quot;consul&quot;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CalculatorService</span> <span class="keyword">implements</span> <span class="title">CalculatorServiceInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 实现一个加法方法，这里简单的认为参数都是 int 类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$a</span>, <span class="keyword">int</span> <span class="variable">$b</span></span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 这里是服务方法的具体实现</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$a</span> + <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@RpcService</code> 有四个参数：</p>
<ul>
<li><code>name</code>
属性为定义该服务的名称，这里定义一个全局唯一的名字即可，Hyperf
会根据该属性生成对应的 ID 注册到服务中心去；</li>
<li><code>protocol</code> 属性为定义该服务暴露的协议，目前仅支持
<code>jsonrpc-http</code>，<code>jsonrpc</code>，<code>jsonrpc-tcp-length-check</code>，分别对应于
HTTP 协议和 TCP 协议下的两种协议，默认值为
<code>jsonrpc-http</code>，这里的值对应在
<code>Hyperf\Rpc\ProtocolManager</code> 里面注册的协议的
<code>key</code>， 它们本质上都是 JSON RPC
协议，区别在于数据格式化、数据打包、数据传输器等不同；</li>
<li><code>server</code> 属性为绑定该服务类发布所要承载的
<code>Server</code>，默认值为 <code>jsonrpc-http</code>，该属性对应
<code>config/autoload/server.php</code> 文件内 <code>servers</code>
下所对应的 <code>name</code>，这里也就意味着我们需要定义一个对应的
<code>Server</code>；</li>
<li><code>publishTo</code>
属性为定义该服务所要发布的服务中心，目前仅支持
<code>consul</code>、<code>nacos</code>
或为空，为空时代表不发布该服务到服务中心去，但也就意味着您需要手动处理服务发现的问题，要使用此功能需安装
<code>hyperf/service-governance</code> 组件及对应的
驱动依赖，比如，如果使用 <code>consul</code>，还需要安装
<code>hyperf/service-governance-consul</code>。</li>
</ul>
<h3 id="配置服务驱动">配置服务驱动</h3>
<p>修改文件 <code>config/autoload/services.php</code>，修改为如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;enable&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;discovery&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&#x27;register&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;consumers&#x27;</span> =&gt; [],</span><br><span class="line">    <span class="string">&#x27;providers&#x27;</span> =&gt; [],</span><br><span class="line">    <span class="string">&#x27;drivers&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;consul&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;http://consul:8500&#x27;</span>, <span class="comment">// consul 的地址</span></span><br><span class="line">            <span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="启动服务提供者">启动服务提供者</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php bin/hyperf.php start</span><br></pre></td></tr></table></figure>
<h2 id="消费者">消费者</h2>
<h3 id="启动消费者服务">启动消费者服务</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器</span></span><br><span class="line">docker run --name consumer \</span><br><span class="line">    -v /workspace/skeleton:/data/project \</span><br><span class="line">    -p 9501:9501 -it \</span><br><span class="line">    --privileged -u root \</span><br><span class="line">    --entrypoint /bin/sh \</span><br><span class="line">    --network=&quot;hyperf&quot; \</span><br><span class="line">    hyperf/hyperf:7.4-alpine-v3.11-swoole</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在容器里面进行安装 hyperf，安装的时候需要选择的话全部回车，使用默认选项</span></span><br><span class="line">composer create-project hyperf/hyperf-skeleton</span><br><span class="line"></span><br><span class="line">cd hyperf-skeleton</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖</span></span><br><span class="line">composer require hyperf/json-rpc</span><br><span class="line">composer require hyperf/rpc-client</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装服务注册与发现的依赖</span></span><br><span class="line">composer require hyperf/service-governance</span><br><span class="line">composer require hyperf/service-governance-consul</span><br></pre></td></tr></table></figure>
<h3 id="配置服务提供者地址">配置服务提供者地址</h3>
<p>新建文件 <code>config/autoload/services.php</code>，内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;enable&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;discovery&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&#x27;register&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;consumers&#x27;</span> =&gt; [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;CalculatorService&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;registry&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;protocol&#x27;</span> =&gt; <span class="string">&#x27;consul&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span> =&gt; <span class="string">&#x27;http://consul:8500&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        ]</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;drivers&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;consul&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;http://consul:8500&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="定义和服务端相同的接口类">定义和服务端相同的接口类</h3>
<p><code>app/Contracts/CalculatorServiceInterface.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Contracts</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CalculatorServiceInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$a</span>, <span class="keyword">int</span> <span class="variable">$b</span></span>): <span class="title">int</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义消费者实现类">定义消费者实现类</h3>
<p><code>app/JsonRpc/CalculatorServiceConsumer.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">JsonRpc</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Contracts</span>\<span class="title">CalculatorServiceInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Hyperf</span>\<span class="title">RpcClient</span>\<span class="title">AbstractServiceClient</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CalculatorServiceConsumer</span> <span class="keyword">extends</span> <span class="title">AbstractServiceClient</span> <span class="keyword">implements</span> <span class="title">CalculatorServiceInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$serviceName</span> = <span class="string">&#x27;CalculatorService&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protocol</span> = <span class="string">&#x27;jsonrpc-http&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$a</span>, <span class="keyword">int</span> <span class="variable">$b</span></span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__request</span>(<span class="keyword">__FUNCTION__</span>, <span class="title function_ invoke__">compact</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在控制器中使用服务消费者">在控制器中使用服务消费者</h3>
<p><code>app/Controller/IndexController.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Hyperf.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span>     https://www.hyperf.io</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@document</span> https://hyperf.wiki</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  group<span class="doctag">@hyperf</span>.io</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>  https://github.com/hyperf/hyperf/blob/master/LICENSE</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">JsonRpc</span>\<span class="title">CalculatorServiceConsumer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Hyperf</span>\<span class="title">Di</span>\<span class="title">Annotation</span>\<span class="title">Inject</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">AbstractController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 依赖注入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Inject</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> CalculatorServiceConsumer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$service</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">input</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;Hyperf&#x27;</span>);</span><br><span class="line">        <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getMethod</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;sum&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;service-&gt;<span class="title function_ invoke__">add</span>(<span class="number">1</span>, <span class="number">2</span>),  <span class="comment">// 调用消费者，最终是会通过 rpc 调用服务提供者的方法</span></span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="variable">$method</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&quot;Hello <span class="subst">&#123;$user&#125;</span>.&quot;</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="启动服务消费者">启动服务消费者</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php bin/hyperf.php start</span><br></pre></td></tr></table></figure>
<h2 id="检验">检验</h2>
<ol type="1">
<li>打开 <code>http://localhost:8500</code>，在里面可以看到注册的
<code>CalculatorService</code> 服务</li>
<li>访问 <code>http://localhost:9501</code>，可以看到输出的结果里面有
<code>sum</code></li>
</ol>
<h2 id="参考文档">参考文档</h2>
<ol type="1">
<li>安装文档 <a
target="_blank" rel="noopener" href="https://hyperf.wiki/2.2/#/zh-cn/quick-start/install">https://hyperf.wiki/2.2/#/zh-cn/quick-start/install</a></li>
<li>json-rpc 文档 <a
target="_blank" rel="noopener" href="https://hyperf.wiki/2.2/#/zh-cn/json-rpc">https://hyperf.wiki/2.2/#/zh-cn/json-rpc</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2022/10/10/c/C%20%E7%9A%84%20likely%20%E5%92%8C%20unlikely%20%E7%9A%84%E4%BD%9C%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/10/c/C%20%E7%9A%84%20likely%20%E5%92%8C%20unlikely%20%E7%9A%84%E4%BD%9C%E7%94%A8/" class="post-title-link" itemprop="url">C 的 likely 和 unlikely 的作用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-10 20:43:00" itemprop="dateCreated datePublished" datetime="2022-10-10T20:43:00+08:00">2022-10-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="定义">定义</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> likely(x) __builtin_expect(!!(x), 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br></pre></td></tr></table></figure>
<p><code>__builtin_expect</code> 是编译器内建函数，原型为
<code>long __builtin_expect (long exp, long c)</code>。该函数并不会改变
<code>exp</code> 的值，但是可以对 <code>if-else</code> 分支或者
<code>if</code> 分支结构进行优化。 <code>likely</code> 表示
<code>if</code> 分支大概率会发生，<code>unlikely</code> 代表
<code>if</code> 分支大概率不会发生。</p>
<blockquote>
<p><code>!!</code> 是 C 语言中处理逻辑表达式的一个技巧。因为 C
语言中没有布尔变量，所以布尔值是用整型来代替的，0 为假，非 0 为真。 当
<code>x</code> 为 0 时，<code>!(x)</code> 为 1，<code>!!(x)</code> 为
0，<code>!!</code> 的运算没有什么意义；但当 x 为非 0 时（比如
100），<code>!(x)</code> 为 0，<code>!!(x)</code> 为 1，
这样就达到了将非 0 值全部映射为 1 的效果。</p>
</blockquote>
<h2 id="应用场景">应用场景</h2>
<p>总的来说，对代码运行效率有要求的 <code>if-else</code> 或
<code>if</code> 分支就应该使用 <code>likely</code> 或
<code>unlikely</code> 优化选项。</p>
<h2 id="注意事项">注意事项</h2>
<ul>
<li><code>likely</code> 和 <code>unlikely</code>
的概率判断务必准确，不要写反了，否则非但不能提升运行效率，反而会起到反作用。</li>
<li>选择表达式时要选择编译阶段编译器无法推测出真假的表达式，否则优化不起作用。</li>
<li>编译时需要至少使用 <code>-O2</code> 选项，否则优化不起作用。</li>
</ul>
<h2 id="作用原理">作用原理</h2>
<h3 id="理论">理论</h3>
<p>使用 <code>likely</code> 或 <code>unlikely</code>
为什么会起到提升代码运行效率的优化效果呢？</p>
<p>主要的作用机理有以下 2 点：</p>
<ul>
<li>gcc 编译器在编译生成汇编代码时会在编译选项的引导下调整
<code>if</code> 分支内代码的位置，如果是 <code>likely</code>
修饰过的就调整到前面，如果是 <code>unlikely</code>
修饰过的就调整到后面。
放到前面的代码可以节省跳转指令带来的时间开销，从而达到提升效率的目的。</li>
<li>当代 CPU 都有 ICache 和流水线机制，在运行当前这条指令时，ICache
会预读取后面的指令，以提升运行效率。但是如果条件分支的结果是跳转到了其他指令，那取的下一条指令（有的
CPU 设置的是 4 级流水，也就是 4 条指令）就没用了，
这样就降低了流水线的效率。如果使用 <code>likely</code> 和
<code>unlikely</code>
来指导编译器总是将大概率执行的代码放在靠前的位置，就可以大大提高预取值的命中率，从而达到提升效率的目的。</li>
</ul>
<h3 id="实践">实践</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 编译生成a.out，注意使用-O2选项，否则不生效</span><br><span class="line">gcc -O2 test.c</span><br><span class="line"># 根据生成的a.out生成反汇编代码</span><br><span class="line">objdump -CS a.out &gt; objdump.txt</span><br></pre></td></tr></table></figure>
<ul>
<li><code>objdump</code>
命令是用来查看目标文件或者可执行的目标文件的构成的 gcc 工具。</li>
<li><code>-d</code> 反汇编目标文件中包含的可执行指令。</li>
<li><code>-S</code> 混合显示源码和汇编代码，前提是在编译目标文件时加上
-g，否则相当于 -d</li>
<li><code>-C</code> 一般针对 C++ 语言，用来更友好地显示符号名。</li>
</ul>
<h4 id="不使用-likely-和-unlikely-选项">不使用 <code>likely</code> 和
<code>unlikely</code> 选项</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> likely(x) __builtin_expect(!!(x), 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) i--;</span><br><span class="line">    <span class="keyword">else</span> i++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objdump 里面的 <code>main</code>：</p>
<blockquote>
<p>没有跳转指令。</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400440</span> &lt;main&gt;:</span><br><span class="line">  <span class="number">400440</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  <span class="number">400444</span>:	<span class="number">48</span> 8b 7e <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rsi),%rdi</span><br><span class="line">  <span class="number">400448</span>:	ba 0a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>xa,%edx</span><br><span class="line">  <span class="number">40044d</span>:	<span class="number">31</span> f6                	<span class="keyword">xor</span>    %esi,%esi</span><br><span class="line">  40044f:	e8 dc ff ff ff       	callq  <span class="number">400430</span> &lt;strtol@plt&gt;</span><br><span class="line">  <span class="number">400454</span>:	<span class="number">8d</span> <span class="number">50</span> ff             	<span class="keyword">lea</span>    -<span class="number">0x1</span>(%rax),%edx   // %rax 是返回值寄存器，i-<span class="number">1</span></span><br><span class="line">  <span class="number">400457</span>:	<span class="number">8d</span> <span class="number">48</span> <span class="number">01</span>             	<span class="keyword">lea</span>    <span class="number">0x1</span>(%rax),%ecx // i+<span class="number">1</span></span><br><span class="line">  40045a:	<span class="number">85</span> c0                	<span class="keyword">test</span>   %eax,%eax // 判断 %eax 是否为 <span class="number">0</span></span><br><span class="line">  40045c:	0f 4e d1             	<span class="keyword">cmovle</span> %ecx,%edx // if &lt;=, <span class="built_in">edx</span> = <span class="built_in">ecx</span></span><br><span class="line">  40045f:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  <span class="number">400463</span>:	<span class="number">89</span> d0                	<span class="keyword">mov</span>    %edx,%eax // %edx 是最终返回值</span><br><span class="line">  <span class="number">400465</span>:	c3                   	retq</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-0x1(%rax)</code> 表示 <code>%rax</code> 的值减
1，<code>lea -0x1(%rax),%edx</code> 则表示 <code>%edx</code> 保存的是
<code>i-1</code></li>
<li><code>0x1(%rax)</code> 表示 <code>%rax</code> 的值加
1，<code>lea 0x1(%rax),%ecx</code> 则表示 <code>%ecx</code> 保存的是
<code>i+1</code></li>
</ul>
<blockquote>
<p>x86 寄存器参考文档：<a
target="_blank" rel="noopener" href="https://www.cs.uaf.edu/2017/fall/cs301/lecture/09_11_registers.html">https://www.cs.uaf.edu/2017/fall/cs301/lecture/09_11_registers.html</a></p>
</blockquote>
<blockquote>
<p>其他参考文档 <a
target="_blank" rel="noopener" href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1186/lectures/14-slides.pdf">https://web.stanford.edu/class/archive/cs/cs107/cs107.1186/lectures/14-slides.pdf</a></p>
</blockquote>
<h4 id="使用-likely">使用 <code>likely</code></h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> likely(x) __builtin_expect(!!(x), 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (likely(i &gt; <span class="number">0</span>)) i--;</span><br><span class="line">    <span class="keyword">else</span> i++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objdump 里面的 <code>main</code>：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400440</span> &lt;main&gt;:</span><br><span class="line">  <span class="number">400440</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  <span class="number">400444</span>:	<span class="number">48</span> 8b 7e <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rsi),%rdi</span><br><span class="line">  <span class="number">400448</span>:	ba 0a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>xa,%edx</span><br><span class="line">  <span class="number">40044d</span>:	<span class="number">31</span> f6                	<span class="keyword">xor</span>    %esi,%esi</span><br><span class="line">  40044f:	e8 dc ff ff ff       	callq  <span class="number">400430</span> &lt;strtol@plt&gt;</span><br><span class="line">  <span class="number">400454</span>:	<span class="number">85</span> c0                	<span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  <span class="number">400456</span>:	7e <span class="number">08</span>                	<span class="keyword">jle</span>    <span class="number">400460</span> &lt;main+<span class="number">0x20</span>&gt; // 小于等于的时候跳转，if 语句块在前面</span><br><span class="line">  <span class="number">400458</span>:	<span class="number">83</span> e8 <span class="number">01</span>             	<span class="keyword">sub</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  40045b:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  40045f:	c3                   	retq</span><br><span class="line">  <span class="number">400460</span>:	<span class="number">83</span> c0 <span class="number">01</span>             	<span class="keyword">add</span>    <span class="number">$0</span>x1,%eax          // else 语句块在后面</span><br><span class="line">  <span class="number">400463</span>:	eb f6                	<span class="keyword">jmp</span>    40045b &lt;main+<span class="number">0x1b</span>&gt;</span><br></pre></td></tr></table></figure>
<p>使用 <code>likely</code>
的时候，编译器就知道，大部分情况下，<code>if</code> 判断的结果会是
<code>true</code>，所以只有 <code>i &lt;= 0</code>
的时候才会去跳转，这样一来大部分的情况下都不用跳转。</p>
<h4 id="使用-unlikely">使用 <code>unlikely</code></h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> likely(x) __builtin_expect(!!(x), 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(i &gt; <span class="number">0</span>)) i--;</span><br><span class="line">    <span class="keyword">else</span> i++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objdump 里面的 <code>main</code>：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400440</span> &lt;main&gt;:</span><br><span class="line">  <span class="number">400440</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  <span class="number">400444</span>:	<span class="number">48</span> 8b 7e <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rsi),%rdi</span><br><span class="line">  <span class="number">400448</span>:	ba 0a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>xa,%edx</span><br><span class="line">  <span class="number">40044d</span>:	<span class="number">31</span> f6                	<span class="keyword">xor</span>    %esi,%esi</span><br><span class="line">  40044f:	e8 dc ff ff ff       	callq  <span class="number">400430</span> &lt;strtol@plt&gt;</span><br><span class="line">  <span class="number">400454</span>:	<span class="number">85</span> c0                	<span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  <span class="number">400456</span>:	7f <span class="number">08</span>                	<span class="keyword">jg</span>     <span class="number">400460</span> &lt;main+<span class="number">0x20</span>&gt; // 大于的时候跳转，else 语句块在前面</span><br><span class="line">  <span class="number">400458</span>:	<span class="number">83</span> c0 <span class="number">01</span>             	<span class="keyword">add</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  40045b:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  40045f:	c3                   	retq</span><br><span class="line">  <span class="number">400460</span>:	<span class="number">83</span> e8 <span class="number">01</span>             	<span class="keyword">sub</span>    <span class="number">$0</span>x1,%eax          // if 语句块在后面</span><br><span class="line">  <span class="number">400463</span>:	eb f6                	<span class="keyword">jmp</span>    40045b &lt;main+<span class="number">0x1b</span>&gt;</span><br></pre></td></tr></table></figure>
<p>使用 <code>unlikely</code>
的时候，编译器就知道，大部分情况下，<code>if</code> 判断的结果会是
<code>false</code>，所以只有 <code>i &gt; 0</code>
的时候才会去跳转，这样一来大部分的情况下都不用跳转。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2022/09/01/linux/xargs%E8%B7%AF%E5%BE%84%E7%A9%BA%E6%A0%BC%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/01/linux/xargs%E8%B7%AF%E5%BE%84%E7%A9%BA%E6%A0%BC%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">xargs路径空格问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-01 14:19:00" itemprop="dateCreated datePublished" datetime="2022-09-01T14:19:00+08:00">2022-09-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题">问题</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls *.pdf | xargs ls -lh</span><br></pre></td></tr></table></figure>
<p>这个命令的作用是 <code>ls -lh</code> 当前目录下的 pdf
文件，但是有个问题是，如果 pdf
文件的路径有空格，这会被视作多个不同的路径，从而导致报错：</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  Downloads ls *.pdf | xargs ls -lh</span><br><span class="line">ls: 01.pdf: No such file or directory</span><br><span class="line">ls: 12.46.55.pdf: No such file or directory</span><br><span class="line">ls: 696390: No such file or directory</span><br></pre></td></tr></table></figure>
<h2 id="解决方法">解决方法</h2>
<p>使用 <code>-I</code> 参数:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls *.pdf | xargs -I &#123;&#125; ls -lh &quot;&#123;&#125;&quot;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2022/08/29/%E6%9D%82%E8%B0%88/%E5%AF%B9%E6%9E%84%E5%BB%BA%E9%AB%98%E8%B4%A8%E9%87%8F%E8%BD%AF%E4%BB%B6%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/29/%E6%9D%82%E8%B0%88/%E5%AF%B9%E6%9E%84%E5%BB%BA%E9%AB%98%E8%B4%A8%E9%87%8F%E8%BD%AF%E4%BB%B6%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">对构建高质量软件的一点点理解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-29 20:01:00" itemprop="dateCreated datePublished" datetime="2022-08-29T20:01:00+08:00">2022-08-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>最近在实现一个 go
云存储库的过程中，思考了比较多关于软件设计的问题，这里就简单记录一下思考的东西吧。</p>
</blockquote>
<p>对于很多人来说，我也一样，工作多年了，对于实现需求这一点上没啥问题，但是写出来的代码大部分情况都是难以维护的。<del>毕竟很多情况下，在要求的时间内把功能实现已经是一件比较艰难的事了。</del></p>
<p>这样的结果便是，代码改起来往往比较痛苦，本文就聊聊我们可以做点什么，让我们在开发的过程中不那么痛苦（<del>当然，最简单直接的办法当然是加入某团、某滴。</del>）。</p>
<h2 id="设计原则">设计原则</h2>
<p>设计原则，也就是
SOLID（单一职责原则、开闭原则、里氏替换原则、接口隔离原则、依赖倒置原则）。我就不说里氏替换原则和接口隔离原则了，还没有深入地去实践过，没有发言权。个人观点，也许你可以不那么懂设计模式，但是这几个设计原则最好还是可以了解一下，因为这些原则离我们更加近，而设计模式往往在特定场景下才需要。</p>
<ul>
<li>单一职责原则：这里举一些反例吧
<ul>
<li>最常见的不好的写法是，service
里面一个方法做完了一个请求的全部事情，比如参数校验、业务逻辑、数据库查询。
=&gt; 更好的做法也许是将数据库访问的代码从业务逻辑中抽离出去。</li>
<li>又或者在一个方法里面混杂了不同抽象层级的代码，比如一个方法要做两件事，A、B，A
有方法封装起来了，但是 B 没有，然后我们可能会看到这样的代码，调用 A
方法，然后在当前的方法内去实现 B 的逻辑，包含了全部 B
的细节部分的内容。=&gt; 也许更好的处理方式是，将 B
也重构为一个方法，我们在阅读的时候，可以看到清晰的逻辑
A-&gt;B-&gt;...，而不是在看完 A 之后，迷失在 B 的细节之中。</li>
<li>做了不该做的事情，比如在处理当前业务的代码中，却中途穿插了其他业务模块的逻辑代码。
=&gt; 更好的方法也许将其他业务模块的代码从中抽取出去。</li>
</ul></li>
<li>开闭原则：要做到这一点，我们要在开发的时候就预留可以扩展点，主要目的是为了让后续增加功能的时候，可以尽量少改或者不改旧的代码，通过增加代码就实现新的功能。
<ul>
<li>比如，<code>Laravel</code> 框架里面，我们可以很容易地通过
<code>ServiceProvider</code>
来扩展框架的功能，但是不需要对框架本身做任何修改（也就是说
<code>Laravel</code> 对扩展是开放的，对修改是封闭的）。</li>
</ul></li>
<li>依赖倒置原则：简单来说就是高层模块跟底层模块不相互依赖，两者共同依赖于抽象出来的接口。
<ul>
<li>比如在 <code>Laravel</code> 中，我们使用 <code>Cache</code>
的时候，并不关心具体使用的是哪一种缓存（有可能是
redis、memcached、file），我们需要只知道 <code>Cache</code>
给我们提供了哪些接口就可以使用缓存这个功能了。同样的，<code>Laravel</code>
框架在实现缓存的 <code>redis</code>、<code>file</code>
驱动的时候，也不需要关心应用开发者是怎么使用缓存这个功能的，因为
<code>Cache</code>
接口已经规定了有哪些接口，缓存驱动之需要实现这些接口就足够了。</li>
<li>因为抽象是基本不会变的，会变的是底层细节部分。这样一来，底层细节发生变动的时候，对应用开发者是完全透明的，因为应用开发者依赖的抽象接口并没有发生变动。</li>
</ul></li>
</ul>
<h2 id="软件结构">软件结构</h2>
<p>窃以为，好的软件结构应该是自顶向下、逐步细化的，我们去阅读一个软件的时候，应该先看到的是其顶层设计结构里面有哪些功能模块，然后从某一个功能模块进去，我们可以看到这个功能模块里面有哪些子模块，然后到子模块的实现细节等。</p>
<p>在今天我们很多项目中，也许从某一个角度来说，符合这种结构。从哪个角度呢？从业务需求的角度。但现实是，业务需求之间往往有很多关联，每一个业务之间肯定不会是完全独立的，每一个业务的子模块也不是完全独立的。如果只是仅仅按照业务功能来进行软件模块的设计的话，不同业务模块之间的相互依赖最终会导致非常高的耦合产生。</p>
<blockquote>
<p>好像 DDD
是关于这方面的，但是没有过太深入的了解，读者感兴趣可以自行阅读。</p>
</blockquote>
<p>关于这一点，个人没有想到太多具体可行的办法，但是在编码过程中，多思考一下我们这个模块大概是什么样子的会有利于我们设计出一个结构良好的模块。</p>
<h2 id="简单的接口">简单的接口</h2>
<blockquote>
<p>虽然子标题是简单，但是并不意味着要写出简单的接口也是一件简单的事情，恰恰相反，把代码写复杂是一件很简单的事，但是把代码写简单却是一件非常困难的事。</p>
</blockquote>
<blockquote>
<p>这里的简单指的是，更好的封装，这样别人使用你提供的类/接口的时候，更容易使用。</p>
</blockquote>
<p>这一点可以通过一个更具体的例子来说明，就是我们的类（OOP
里的类）。</p>
<p>有很多人在定义一个类的时候，好像习惯性地把所有的属性、方法都设置为
public，这样写可能只有自己去使用自己开发的类的时候，问题不是很大。但是如果将这样的类提供给其他开发者使用的时候，别人很大可能没有办法在短时间内知道这个类该如何使用，因为当他们想去使用这个类的时候，发现一堆的
public 方法，根本搞不懂哪一个才能满足自己的需求。</p>
<p>而且，都设置为
public，当你需要去改动这一个类的时候，往往不知所措，因为有可能开发的时候，开发者并不是打算将那个方法提供给外部使用的，但是后面发现很多地方却用了。这样就会给后续维护带来很大的困难，尤其是某些弱类型语言。就算在其他地方调用了，你也可能发现不了。</p>
<p>更好的方法也许是，只将类中需要对外提供的方法设置为 public
就可以了，这样使用者也就只需要在少数几个方法中选出适合的那一个方法即可。不过将不该公开的东西设置为
private 算是 OOD 的基础要求了吧。</p>
<h2 id="分层">分层</h2>
<p>一些常见的不那么好的做法是：</p>
<ul>
<li>controller 里面做了数据库查询、业务逻辑处理</li>
<li>service 里面做了数据库查询</li>
<li>除了 controller 就是 service，一个 service 做完所有的事情</li>
</ul>
<p>窃以为，一个更好的做法也许是，controller 跟 service 分开，service 跟
db
分开等，如果尝试这么去做的话，我们会发现，有一些代码变得可以复用了。</p>
<p>事实就是这样，如果我们将我们一些大的类拆分成一个个功能单一的小的类或者方法之后，我们就会发现原来完全不能复用的代码，在很多地方都可以复用，而不再需要将一些重复的逻辑写在
repo 的各个地方了。</p>
<h2 id="分层的例子">分层的例子</h2>
<ul>
<li>协议栈：最常见的分层模型就是网络协议栈了，分了应用层、传输层、网络层、链路层。每一层负责不同的功能，底层模块在使用更低层模块提供的服务的同时，向上层提供新的功能。同时上层不需要关心下层的实现细节，可以专注于本层功能的实现。这样带来的好处是，我们今天网络通信中用的网络协议栈依然是几十年前设计出来的，非常的稳定。</li>
<li>web 应用：mvc 分层，但是窃以为如果在我们日常开发中，将对 db
的访问也拆分出去也许会更好，当然业内也有很多人尝试过了，就是 repository
模式。通过这种模式，我们在做单元测试的时候，也会更加方便，因为可以直接
mock 掉 db 的访问。只需要专注于业务逻辑处理。（因为 db
是非常稳定的，基本不会发生变化，我们在单元测试也要把其考虑进去的话，这会让我们变得不堪重负。）</li>
<li>MySQL：MySQL 中主要分了 Server 层和 engine 层，Server
层处理的是数据库的一些通用的逻辑，存储引擎层处理的是不同的数据存储方式，比如，MyISAM
跟 InnoDB
的存取数据的过程是不一样的，但是取出数据后如果要做一些运算，做判断等这些就一样了。</li>
</ul>
<h2 id="外部依赖">外部依赖</h2>
<p>我们也许有时候会用到一些自己完全不了解的外部模块，而且有可能我们还很频繁地去使用，这种情况下，一旦依赖的这个外部的方法发生了改变，我们就要改动很多不同的地方。</p>
<p>对于这种情况，有一种方法是将这些外部的依赖都放到一个地方，这样即使外部的依赖发生了一些变更，我们只需要在一个地方修改即可。</p>
<p>关于这种做法，有一个更专业的名词叫做
“防腐层”。这种做法背后的逻辑其实也是很常见的一种软件设计方式，就是关注点分离，我们可以将变与不变的分离开，将不可控的部分控制在一个小范围内。</p>
<h2 id="相互依赖">相互依赖</h2>
<p>这里说的依赖大概是下图这种：</p>
<p><img src="/images/other/design/1.png" /></p>
<p>这个图中，不同模块相互依赖，有着复杂的依赖关系。对于这种情况，我们可能可以考虑将各模块都需要的东西抽取出来，新建一个类或者其他什么的，通过这个类来作为不同模块之间的沟通的桥梁，如下图这样：</p>
<p><img src="/images/other/design/2.png" /></p>
<h2 id="ci---持续集成">CI - 持续集成</h2>
<p>我们最常用的 gitlab、github 都提供了 ci 的功能，我们可以利用 ci
来帮助我们做很多工作：</p>
<ul>
<li>lint：代码规范检查修正、代码格式化等。</li>
<li>单元测试：让 ci
来完成单元测试的工作，可以让我们及时发现代码中存在的问题，及时得到反馈。同时通过提高测试覆盖率，我们可以很好地提升我们交付的软件的可靠性。而不是等到测试人员测试这一个环节再去发现问题。</li>
<li>也可以做一些集成测试、系统测试等。</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<p>在软件开发过程中，不可避免地会有错误的产生，不管是哪里产生的，总会有错误，如果我们在错误产生的时候，完全不知道错误是从哪一行代码产生的话，会给我们修复错误的过程带来极大的困难。</p>
<p>对于错误处理，个人觉得有以下几点可以做好的地方： 1. 错误定义：在类似
Java、PHP
这种语言中可以通过异常来定义一些可预期的异常，然后直接在外部捕获这些异常进行处理。
2.
错误处理：捕获到异常之后，我们可能需要通过日志来记录、然后再记录一下上下文信息，只是记录错误可能很多人都能做到，但是异常抛出的上下文对我们排查错误更有帮助。
3. 错误堆栈：这个其实也算是必需的一项了，但是有些人可能会习惯性地 catch
异常之后，只记录一下错误信息就完事了，直接不管异常堆栈，这样也是会给排查错误带来很大的困难。</p>
<h2 id="重构">重构</h2>
<p>软件这一词本身就透露出了，它是可以修改的，而硬件不一样，想修改是不大可能的，一般都是直接换掉。</p>
<p>在我们开发完之后，我们依然有机会来对软件的结构等做一些调整，让其性能更好、可维护性更好等。</p>
<p>当然重构的前提是要保证功能不受影响，如果因为我们的重构导致程序崩溃了，或者行为不一致了，那就不叫重构了，那叫搞破坏了。</p>
<p>要如何保证重构之后的代码依然可以维持以前的行为呢？那就是单元测试了。这个可能让很多人会觉得有点失望，因为可能我们的代码一行测试代码也没有，因为测试也是一件比较困难的事情。</p>
<p>但是有时候是不得不做这件事，因为原有代码可能可读性非常差、逻辑非常混乱，仿佛你从代码中就能想象到开发者在写代码时候的那种痛苦的状态。在这种情况下，我们只有通过重构来让旧的代码变得更加易读，让其变得像是可以被修改的代码，而不是那种永远不要动的代码。不管怎样，这是我们很多人必须要面对的事实。</p>
<p>关于重构的，没有什么别的建议，可以看看《重构》这本书。</p>
<h2 id="日志级别">日志级别</h2>
<p>其实，在我能了解的编程语言里面，都有日志库，而且都会定义不同的日志级别，但是可能我们往往就是只用到其中一个日志级别，这对于开发者来说可能并不是一件好事。</p>
<p>也许我们可以考虑使用一下不同的日志级别，然后在不同的情况下启用不同的日志级别，一来可以减少生产环境无效日志的数量，另外也可以针对不同情况设置不同的日志级别。</p>
<p>比如，我们本地就直接 debug 级别，生产就 warn 级别。</p>
<h2 id="后记">后记</h2>
<p>好了，目前能想到的就这些了，总结下来比较重要的就三点：</p>
<ol type="1">
<li>关于设计其实大多都能跟 SOLID 沾点边</li>
<li>单元测试，但实际上要写好测试，就要先设计好代码，设计不好的代码是非常难写测试的。</li>
<li>ci，可以通过 ci 脚本可以做一些 lint、format、test 等工作</li>
</ol>
<p>当然，说起来简单，做起来很难。但正是在这些一次次艰难的关于如何开发高质量软件的思考与实践中，才能慢慢体会到什么情况该如何去做，才能及时发现很多不好的设计。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/18/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/70/">70</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/20/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">eleven26</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/eleven26" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
