<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"eleven26.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="eleven26">
<meta property="og:url" content="https://eleven26.github.io/page/29/index.html">
<meta property="og:site_name" content="eleven26">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="eleven26">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://eleven26.github.io/page/29/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/29/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>eleven26</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">eleven26</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">100</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">346</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">eleven26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eleven26" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eleven26" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2021/11/25/laravel/Laravel%20Horizon%20%E5%AE%9A%E6%97%B6%20kill%20%E6%8E%89%E6%97%A7%E7%9A%84%E6%B6%88%E8%B4%B9%E8%80%85%E8%BF%9B%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/25/laravel/Laravel%20Horizon%20%E5%AE%9A%E6%97%B6%20kill%20%E6%8E%89%E6%97%A7%E7%9A%84%E6%B6%88%E8%B4%B9%E8%80%85%E8%BF%9B%E7%A8%8B/" class="post-title-link" itemprop="url">Laravel Horizon 定时 kill 掉旧的消费者进程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-25 16:37:00" itemprop="dateCreated datePublished" datetime="2021-11-25T16:37:00+08:00">2021-11-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题">问题</h2>
<p>生产环境使用了 horizon 来处理队列数据，但是在 supervisor
自动重启的过程中，发现有时候会有一些消费者进程在部署的时候无法正常被
kill 掉，导致一些旧的代码消费队列数据，从而引起报错。</p>
<blockquote>
<p>原因是可能在重启的时候，那个消费者恰好在处理长时间的任务，导致无法被
kill 掉。但无法肯定是这个原因。</p>
</blockquote>
<h2 id="解决方法">解决方法</h2>
<p>每分钟 kill 掉那些不是当前 horizon 子孙进程的消费者（S 状态才会 kill
掉，保证正常业务不受影响）。</p>
<h2 id="解决思路">解决思路</h2>
<ol type="1">
<li>通过 <code>shell_exec</code> 来执行
<code>ps</code>、<code>pstree</code>
等命令查看当前的进程信息，从而找出那些异常的消费者进程 id。</li>
<li>判断这些异常进程是否没有在处理任务。</li>
<li>kill 掉 S 状态的异常消费者进程。</li>
</ol>
<blockquote>
<p>注意：<code>shell_exec</code> 里面使用 <code>ps aux</code>
可能无法获取正常在终端运行的结果，需要使用 <code>ps -efww</code>
才可以获取完整的输出。</p>
</blockquote>
<h2 id="实现代码">实现代码</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Log</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClearInvalidQueueConsumer</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&#x27;clear-invalid-queue-consumer&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;清除无效的队列消费者进程&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$noParentPids</span>        = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">noParentPids</span>();</span><br><span class="line">        <span class="variable">$sleepingProcessPids</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getSleepingProcessPids</span>(<span class="variable">$noParentPids</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$sleepingProcessPids</span>) &#123;</span><br><span class="line">            <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;kill 掉无效的队列进程：&#x27;</span>, <span class="variable">$sleepingProcessPids</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">killInvalidProcess</span>(<span class="variable">$sleepingProcessPids</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">noParentPids</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$pids</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getValidPids</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$allPids</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAllQueueProcessPids</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">array_diff</span>(<span class="variable">$allPids</span>, <span class="variable">$pids</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * kill 掉无效的进程</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $pids</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">killInvalidProcess</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$pids</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$pids</span> <span class="keyword">as</span> <span class="variable">$pid</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">posix_kill</span>(<span class="variable">$pid</span>, SIGTERM)) &#123;</span><br><span class="line">                <span class="title class_">Log</span>::<span class="title function_ invoke__">error</span>(<span class="string">&quot;kill $&#123;pid&#125; error!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$error</span> = <span class="title function_ invoke__">posix_get_last_error</span>()) &#123;</span><br><span class="line">                <span class="title class_">Log</span>::<span class="title function_ invoke__">error</span>(<span class="string">&#x27;kill process error: &#x27;</span> . <span class="title function_ invoke__">posix_strerror</span>(<span class="variable">$error</span>));</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            system(&quot;kill -9 &#123;$pid&#125;&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 pid 数组里面筛选出睡眠状态的进程</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $pids</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSleepingProcessPids</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$pids</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$pids</span> <span class="keyword">as</span> <span class="variable">$pid</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isSleeping</span>(<span class="variable">$pid</span>)) &#123;</span><br><span class="line">                <span class="variable">$result</span>[] = <span class="variable">$pid</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进程是否是睡眠状态</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $pid</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSleeping</span>(<span class="params"><span class="variable">$pid</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">grepPidStatus</span>(<span class="variable">$pid</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$res</span>) &#123;</span><br><span class="line">            <span class="variable">$status</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">statusOfLine</span>(<span class="variable">$res</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$status</span> == <span class="string">&#x27;S&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">grepPidStatus</span>(<span class="params"><span class="variable">$pid</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;ps -efww | grep php | grep $&#123;pid&#125; | grep -v grep&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前所有的队列进程</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllQueueProcessPids</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$res</span>     = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">horizonProcesses</span>();</span><br><span class="line">        <span class="variable">$allPids</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&quot;\n&quot;</span>, <span class="variable">$res</span>) <span class="keyword">as</span> <span class="variable">$line</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$line</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$allPids</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pidOfLine</span>(<span class="variable">$line</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$allPids</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">horizonProcesses</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;ps -efww | grep horizon | grep -v grep&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前有效的进程 id 数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValidPids</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$horizonPid</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">horizonProcessPid</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$horizonPid</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pstree</span>(<span class="variable">$horizonPid</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&quot;/php,\d+/&quot;</span>, <span class="variable">$res</span>, <span class="variable">$matches</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pids</span> = [];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$matches</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$matches</span>[<span class="number">0</span>] <span class="keyword">as</span> <span class="variable">$match</span>) &#123;</span><br><span class="line">                <span class="variable">$pids</span>[] = <span class="title function_ invoke__">substr</span>(<span class="variable">$match</span>, <span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$pids</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pstree</span>(<span class="params"><span class="variable">$horizonPid</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;pstree -a <span class="subst">&#123;$horizonPid&#125;</span> -p&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 horizon 启动进程 id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int|mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">horizonProcessPid</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">horizonPidLine</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$res</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pidOfLine</span>(<span class="variable">$res</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">horizonPidLine</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;ps -efww | grep -v grep | grep &#x27;/usr/lnmp/php/bin/php /home/www/api/default/current/artisan horizon&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 ps aux 的输出行里面获取进程状态 S -&gt; 睡眠</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $line</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">statusOfLine</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$line</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fields</span>(<span class="variable">$line</span>)[<span class="number">7</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 ps aux 的输出行里面获取 pid</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $line</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pidOfLine</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$line</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fields</span>(<span class="variable">$line</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ps aux 输出行里面空格分隔的单词列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $line</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fields</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$line</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$line</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$line</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fields</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27; &#x27;</span>, <span class="variable">$line</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">array_values</span>(<span class="title function_ invoke__">array_filter</span>(<span class="variable">$fields</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2021/11/25/kubernetes/Kubernetes%20%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/25/kubernetes/Kubernetes%20%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">Kubernetes 集群环境搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-25 07:45:00" itemprop="dateCreated datePublished" datetime="2021-11-25T07:45:00+08:00">2021-11-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="环境规划">环境规划</h2>
<h3 id="集群类型">集群类型</h3>
<p>kubernetes
集群大体上分为两类：<strong>一主多从</strong>和<strong>多主多从</strong>。</p>
<ul>
<li>一主多从：一台 Master 节点和多台 Node
节点，搭建简单，但是有单机故障风险，适合用于测试环境。</li>
<li>多主多从：多台 Master 节点和多台 Node
节点，搭建麻烦，安全性高，适合用于生产环境。</li>
</ul>
<figure>
<img src="/images/k8s/cluster.png" alt="cluster" />
<figcaption aria-hidden="true">cluster</figcaption>
</figure>
<blockquote>
<p>说明：为了测试简单，本次搭建的是一主两从类型的集群。</p>
</blockquote>
<h3 id="安装方式">安装方式</h3>
<p>kubernetes 有多种部署方式，目前主流的方式有
kubeadm、minikube、二进制包。</p>
<ul>
<li>minikube：一个用于快速搭建单节点 kubernetes 的工具</li>
<li>kubeadm：一个用于快速搭建 kubernetes 集群的工具</li>
<li>二进制包：从官网下载每个组件的二进制包，依次去安装，此方式对于理解
kubernetes 组件更加有效</li>
</ul>
<blockquote>
<p>说明：现在需要安装 kubernetes
的集群环境，但是又不想过于麻烦，所以使用 kubeadm 方式</p>
</blockquote>
<h3 id="主机规划">主机规划</h3>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>作用</th>
<th>IP地址</th>
<th>操作系统</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Master</td>
<td>192.168.235.100</td>
<td>CentOS7.5 基础设施服务器</td>
<td>2颗CPU 2G内存 50G硬盘</td>
</tr>
<tr class="even">
<td>Node1</td>
<td>192.168.235.101</td>
<td>CentOS7.5 基础设施服务器</td>
<td>2颗CPU 2G内存 50G硬盘</td>
</tr>
<tr class="odd">
<td>Node2</td>
<td>192.168.235.102</td>
<td>CentOS7.5 基础设施服务器</td>
<td>2颗CPU 2G内存 50G硬盘</td>
</tr>
</tbody>
</table>
<!-- [https://www.bilibili.com/video/BV1Qv41167ck](https://www.bilibili.com/video/BV1Qv41167ck) -->
<h2 id="环境搭建">环境搭建</h2>
<p>本次环境搭建需要安装三台 linux 系统（一主二从），内置 CentOS7.5
系统，然后在每台 linux 中分别安装 docker，kubeadm，kubelet，kubectl
程序。</p>
<h3 id="主机安装">主机安装</h3>
<p>安装虚拟机过程注意下面选项的设置：</p>
<ul>
<li>操作系统环境：CPU（2C） 内存（2G）硬盘（50G）</li>
<li>语言选择：中文简体</li>
<li>软件选择：基础设施服务器</li>
<li>分区选择：自动分区</li>
<li>网络配置：按照下面配置网络地址信息（IPv4）</li>
</ul>
<blockquote>
<p>网络地址：192.168.235.100（每台主机都不一样 分别为
100、101、102）(vmware的编辑-&gt;虚拟网络编辑器里面第二个网卡可以看到本地的虚拟机网段是什么)
子网掩码：255.255.255.0 默认网关:192.168.235.2 DNS：223.5.5.5</p>
</blockquote>
<figure>
<img src="/images/k8s/vm-network.png" alt="vm-network" />
<figcaption aria-hidden="true">vm-network</figcaption>
</figure>
<blockquote>
<p>常规里面的第一个勾上。</p>
</blockquote>
<ul>
<li>主机名设置：按照下面信息设置主机名</li>
</ul>
<blockquote>
<p>master节点：master node节点：node1 node节点：node2</p>
</blockquote>
<figure>
<img src="/images/k8s/vm-hostname.png" alt="vm-hostname" />
<figcaption aria-hidden="true">vm-hostname</figcaption>
</figure>
<h3 id="环境初始化">环境初始化</h3>
<ol type="1">
<li>检查操作系统的版本</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 此方式安装 kubernetes 集群要求 CentOS 版本在 7.5 或以上</span><br><span class="line">[root@master ~]# cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>主机名解析</li>
</ol>
<p>为了方便后面集群节点间的直接调用，再配置一下主机名解析，企业中推荐使用内部
DNS 服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 主机名解析 编辑三台服务器的 /etc/hosts 文件，添加下面内容</span><br><span class="line">192.168.235.100 master</span><br><span class="line">192.168.235.101 node1</span><br><span class="line">192.168.235.102 node2</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>时间同步</li>
</ol>
<p>kubernetes 要求集群中的节点时间必须精确一致，这里直接使用
<code>chronyd</code> 服务从网络同步时间。</p>
<p>企业中建议配置内部时间同步服务器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 启动 chronyd 服务</span><br><span class="line">[root@master ~]# systemctl start chronyd</span><br><span class="line"># 设置 chronyd 服务开机启动</span><br><span class="line">[root@master ~]# systemctl enable chronyd</span><br><span class="line"># chronyd 服务启动稍等几秒钟，就可以使用 date 命令验证时间了</span><br><span class="line">[root@master ~]# date</span><br><span class="line">2021年 11月 27日 星期六 09:28:07 CST</span><br></pre></td></tr></table></figure>
<ol start="4" type="1">
<li>禁用 iptables 和 firewalld 服务</li>
</ol>
<p>kubernetes 和 docker 在运行中会产生大量的 iptables
规则，为了不让系统规则跟它们混淆，直接关闭系统的规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 1 关闭 firewalld 服务</span><br><span class="line">[root@master ~]# systemctl stop firewalld</span><br><span class="line">[root@master ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line"></span><br><span class="line"># 2 关闭 iptables 服务</span><br><span class="line">[root@master ~]# systemctl stop iptables</span><br><span class="line">Failed to stop iptables.service: Unit iptables.service not loaded.</span><br><span class="line">[root@master ~]# systemctl disable iptables</span><br><span class="line">Failed to execute operation: No such file or directory</span><br></pre></td></tr></table></figure>
<ol start="5" type="1">
<li>禁用 selinux</li>
</ol>
<p><code>selinux</code> 是 linux
系统下的一个安全服务，如果不关闭它，在安装集群中会产生各种各样的奇葩问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 编辑 /etc/selinux/config 文件，修改 SELINUX 的值为 disabled</span><br><span class="line"># 注意修改完毕之后需要重启 linux 服务</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<ol start="6" type="1">
<li>禁用 swap 分区</li>
</ol>
<p><code>swap</code>
分区指的是虚拟内存分区，它的作用是在物理内存使用完之后，将磁盘空间虚拟成内存来使用。</p>
<p>启用 <code>swap</code> 设备会对系统的性能产生非常负面的影响，因此
kubernetes 要求每个节点都要禁用 <code>swap</code> 设备。</p>
<p>但是如果因为某些原因确实不能关闭 <code>swap</code>
分区，就需要在集群安装过程中通过明确的参数进行配置说明。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 编辑分区配置文件 /etc/fstab，注释掉 swap 分区一行</span><br><span class="line"># 注意修改完毕之后需要重启 linux 服务</span><br><span class="line">UUID=0a79fea5-0afa-49a7-9c5e-53c37a76980f /boot                   xfs     defaults        0 0</span><br><span class="line">#/dev/mapper/centos-swap swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure>
<ol start="7" type="1">
<li>修改 linux 的内核参数</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 修改 linux 的内核参数，添加网桥过滤和地址转发功能</span><br><span class="line"># 编辑 /etc/sysctl.d/kubernetes.conf 文件，添加如下配置：</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line"># 重新加载配置</span><br><span class="line">[root@master ~]# sysctl -p</span><br><span class="line"></span><br><span class="line"># 加载网桥过滤模块</span><br><span class="line">[root@master ~]# modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"># 查看网桥过滤模块是否加载成功</span><br><span class="line">[root@master ~]# lsmod | grep br_netfilter</span><br><span class="line">br_netfilter           22256  0</span><br><span class="line">bridge                146976  1 br_netfilter</span><br></pre></td></tr></table></figure>
<ol start="8" type="1">
<li>配置 ipvs 功能</li>
</ol>
<p>在 kubernetes 中 service 有两种代理模型，一种是基于
<code>iptables</code> 的，一种是基于 <code>ipvs</code> 的。</p>
<p>两者比较的话，<code>ipvs</code>
的性能明显要高一些，但是如果要使用它，需要手动载入 <code>ipvs</code>
模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 1 安装 ipset 和 ipvsadm</span><br><span class="line">[root@master ~]# yum install ipset ipvsadm -y</span><br><span class="line"></span><br><span class="line"># 2 添加需要加载的模块写入脚本文件</span><br><span class="line">[root@master ~]# cat &lt;&lt;EOF &gt; /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">#!/bin/bash</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 3 为脚本文件添加执行权限</span><br><span class="line">[root@master ~]# chmod +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line"># 4 执行脚本文件</span><br><span class="line">[root@master ~]# /bin/bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line"># 5 查看对应的模块是否加载成功</span><br><span class="line">[root@master ~]# lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>
<ol start="9" type="1">
<li>重启服务器</li>
</ol>
<p>上面步骤完成之后，需要重新启动 linux 系统。</p>
<h3 id="安装-docker">安装 docker</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 1 切换镜像源</span><br><span class="line">[root@master ~]# wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 2 查看当前镜像源中支持的 docker 版本</span><br><span class="line">[root@master ~]# yum list docker-ce --showduplicates</span><br><span class="line"></span><br><span class="line"># 3 安装指定版本的 docker-ce</span><br><span class="line"># 必须指定 --setopt=obsoletes=0，否则 yum 会自动安装更高版本</span><br><span class="line">[root@master ~]# yum install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7 -y</span><br><span class="line"></span><br><span class="line"># 4 添加一个配置文件</span><br><span class="line"># Docker 在默认情况下使用 Cgroup Driver 为 cgroupfs，而 kubernetes 推荐使用 systemc 来代替 cgroupfs</span><br><span class="line">[root@master ~]# mkdir /etc/docker</span><br><span class="line">[root@master ~]# cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://kn0t2bca.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 5 启动 docker</span><br><span class="line">[root@master ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line"># 6 检查 docker 状态和版本</span><br><span class="line">[root@master ~]# docker version</span><br></pre></td></tr></table></figure>
<h3 id="安装-kubernetes-组件">安装 kubernetes 组件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 由于 kubernetes 的镜像源在国外，速度比较慢，这里切换成国内的镜像源</span><br><span class="line"># 编辑 /etc/yum.repos.d/kubernetes.repo，添加下面的配置</span><br><span class="line">[kunernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line"></span><br><span class="line"># 安装 kubeadm、kubelet 和 kubectl</span><br><span class="line">[root@master ~]# yum install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0 -y</span><br><span class="line"></span><br><span class="line"># 配置 kubelet 的 cgroup</span><br><span class="line"># 编辑 /etc/sysconfig/kubelet，添加下面的配置</span><br><span class="line">KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span><br><span class="line">KUBE_PROXY_MODE=&quot;ipvs&quot;</span><br><span class="line"></span><br><span class="line"># 设置 kubelet 开机自启</span><br><span class="line">[root@master ~]# systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<h3 id="准备集群镜像">准备集群镜像</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 在安装 kubernetes 集群之前，必须要提前准备好集群需要的镜像，所需镜像可以通过下面命令查看</span><br><span class="line">[root@master ~]# kubeadm config images list</span><br><span class="line"></span><br><span class="line"># 下载镜像</span><br><span class="line"># 此镜像在 kubernetes 的仓库中，由于网络原因，无法连接，下面提供了一种替代方案</span><br><span class="line">images=(</span><br><span class="line">    kube-apiserver:v1.17.4</span><br><span class="line">    kube-controller-manager:v1.17.4</span><br><span class="line">    kube-scheduler:v1.17.4</span><br><span class="line">    kube-proxy:v1.17.4</span><br><span class="line">    pause:3.1</span><br><span class="line">    etcd:3.4.3-0</span><br><span class="line">    coredns:1.6.5</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for imageName in $&#123;images[@]&#125;; do</span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName</span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName</span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="集群初始化">集群初始化</h3>
<p>下面开始对集群进行初始化，并将 <code>node</code> 节点加入到集群中</p>
<blockquote>
<p>下面的操作只需要在 <code>master</code> 节点上执行即可</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 创建集群</span><br><span class="line">[root@master ~]# kubeadm init \</span><br><span class="line">    --kubernetes-version=v1.17.4 \</span><br><span class="line">    --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">    --service-cidr=10.96.0.0/12 \</span><br><span class="line">    --apiserver-advertise-address=192.168.235.100</span><br><span class="line"></span><br><span class="line"># 创建必要文件（注意看初始化成功后的输出）</span><br><span class="line">[root@master ~]# mkdir -p $HOME/.kube</span><br><span class="line">[root@master ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">[root@master ~]# chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<blockquote>
<p>下面的操作只需要在 <code>node</code> 节点上执行即可</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 将 node 节点加入集群</span><br><span class="line">[root@master ~]# kubeadm join 192.168.235.100:6443 \</span><br><span class="line">    --token i50jyb.m7n0z8wxwecqvvs1 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:51c607f11b6f9077e073ccf9111047c7838b1e8f7ef52690d8c9b3fb6d9b67b3</span><br><span class="line"></span><br><span class="line"># 这里 token 和 hash 取值看 master 初始化的输出。</span><br><span class="line"></span><br><span class="line"># 查看集群状态 此时集群的状态为 NotReady，这是因为还没有配置网络插件</span><br><span class="line">[root@master ~]# kubectl get nodes</span><br><span class="line">NAME     STATUS     ROLES    AGE     VERSION</span><br><span class="line">master   NotReady   master   5m52s   v1.17.4</span><br><span class="line">node1    NotReady   &lt;none&gt;   23s     v1.17.4</span><br><span class="line">node2    NotReady   &lt;none&gt;   2s      v1.17.4</span><br></pre></td></tr></table></figure>
<h3 id="安装网络插件">安装网络插件</h3>
<p>kubernetes 支持多种网络插件，比如 flannel、calico、canal
等等，任选一种使用即可，本次选择 flannel</p>
<blockquote>
<p>下面操作依旧只在 master 节点执行即可，插件使用的是 DaemonSet
的控制器，它会在每个节点上都运行</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 获取 flannel 的配置文件</span><br><span class="line">[root@master ~]# wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"># 使用配置文件启动 flannel</span><br><span class="line">[root@master ~]# kubectl apply -f kube-flannel.yml</span><br><span class="line"></span><br><span class="line"># 稍等片刻，再次查看集群节点的状态</span><br><span class="line">[root@master ~]# kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE   VERSION</span><br><span class="line">master   Ready    master   16m   v1.17.4</span><br><span class="line">node1    Ready    &lt;none&gt;   11m   v1.17.4</span><br><span class="line">node2    Ready    &lt;none&gt;   10m   v1.17.4</span><br></pre></td></tr></table></figure>
<p>至此，kubernetes 的集群环境搭建完成。</p>
<h2 id="服务部署">服务部署</h2>
<p>接下来在 kubernetes 集群中部署一个 nginx
程序，测试下集群是否在正常工作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 部署 nginx</span><br><span class="line">[root@master ~]# kubectl create deployment nginx --image=nginx:1.14-alpine</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line"></span><br><span class="line"># 暴露端口</span><br><span class="line">[root@master ~]# kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">service/nginx exposed</span><br><span class="line"></span><br><span class="line"># 查看服务状态</span><br><span class="line">[root@master ~]# kubectl get pods,svc</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-6867cdf567-z6jzl   1/1     Running   0          17s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        19m</span><br><span class="line">service/nginx        NodePort    10.105.209.91   &lt;none&gt;        80:32350/TCP   8s</span><br><span class="line"></span><br><span class="line"># 最后在电脑上访问下部署的 nginx 服务</span><br></pre></td></tr></table></figure>
<figure>
<img src="/images/k8s/nginx-svc.png" alt="nginx-svc" />
<figcaption aria-hidden="true">nginx-svc</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2021/11/21/kubernetes/Kubernetes%20%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/21/kubernetes/Kubernetes%20%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">Kubernetes 简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-21 18:45:00" itemprop="dateCreated datePublished" datetime="2021-11-21T18:45:00+08:00">2021-11-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Kubernetes
的本质是一组服务器集群，它可以在集群的每个节点上运行特定的程序，来对节点中的容器进行管理。它的目的就是实现资源管理的自动化，主要提供了如下的主要功能：</p>
<ul>
<li><strong>自我修复</strong>：一旦某一个容器崩溃，能够在 1
秒左右迅速启动新的容器。</li>
<li><strong>弹性伸缩</strong>：可以根据需要，自动对集群中正在运行的容器数量进行调整。</li>
<li><strong>服务发现</strong>：服务可以通过自动发现的形式找到它所依赖的服务。</li>
<li><strong>负载均衡</strong>：如果一个服务启动了多个容器，能够自动实现请求的负载均衡。</li>
<li><strong>版本回退</strong>：如果发现新发布的程序版本有问题，可以立即回退到原来的版本。</li>
<li><strong>存储编排</strong>：可以根据容器自身的需求自动创建存储卷。</li>
</ul>
<figure>
<img src="/images/k8s/node.png" alt="node" />
<figcaption aria-hidden="true">node</figcaption>
</figure>
<h2 id="kubernetes-组件">Kubernetes 组件</h2>
<p>一个 Kubernetes
集群主要是由控制节点（master）、工作节点（node）构成，每个节点上都会安装不同的组件。</p>
<p><strong>master：集群的控制平面，负责集群的决策（管理）</strong></p>
<ul>
<li><strong>ApiServer</strong>：资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制（控制入口）</li>
<li><strong>Scheduler</strong>：负责集群资源调度，按照预定的调度策略将
Pod 调度到相应的 node 节点上</li>
<li><strong>ControllerManager</strong>：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</li>
<li><strong>Etcd</strong>：负责存储集群中各种资源对象的信息</li>
</ul>
<blockquote>
<p>简单来说就是，用户操作命令会到达 ApiServer，然后由 Scheduler
计算操作应该发往哪个 node 上进行，计算完毕，由 ControllerManager 与 node
进行最后的交互。</p>
</blockquote>
<blockquote>
<p>而这个操作的最终结果会存储到 Etcd 里。</p>
</blockquote>
<p><strong>node：集群的数据平面，负责为容器提供运行环境（干活）</strong></p>
<ul>
<li><strong>Kubelet</strong>：负责维护容器的生命周期，即通过控制
docker，来创建、更新、销毁容器</li>
<li><strong>KubeProxy</strong>：负责提供集群内部的服务发现和负载均衡（访问入口）</li>
<li><strong>Docker</strong>：负责节点上容器的各种操作</li>
</ul>
<blockquote>
<p>Kubelet 接收 master 的操作命令，然后控制 Docker 进行具体操作。</p>
</blockquote>
<blockquote>
<p>容器运行起来之后，由于 KubeProxy
提供集群内部的服务发现和负载均衡。</p>
</blockquote>
<figure>
<img src="/images/k8s/components.png" alt="components" />
<figcaption aria-hidden="true">components</figcaption>
</figure>
<p>下面，以部署一个 nginx 服务来说明 kubernetes
系统各个组件调用关系：</p>
<ol type="1">
<li>首先要明确，一旦 kubernetes 环境启动之后，master 和 node
都会将自身的信息存储到 etcd 数据库中。</li>
<li>一个 nginx 服务的安装请求会首先被发送到 master 节点的 ApiServer
组件</li>
<li>ApiServer 组件会调用 Scheduler
组件来决定到底应该把这个服务安装到哪个 node 节点上。在此时，它会从 etcd
中读取各个 node 节点的信息，然后 按照一定的算法进行选择，并将结果告知
ApiServer</li>
<li>ApiServer 调用 ControllerManager 去调度 node 节点来安装 nginx
服务</li>
<li>kubelet 接收到指令后，会通知 docker，然后由 docker 来启动一个 nginx
的 pod。pod 是 kubernetes 的最小操作单元，容器必须跑在 pod 中。</li>
<li>至此，一个 nginx 服务就运行了，如果需要访问 nginx，就需要通过
kube-proxy 来对 pod 产生访问的代理。这样，外界用户就可以访问集群中的
nginx 服务了。</li>
</ol>
<h2 id="kubernetes-概念">Kubernetes 概念</h2>
<ul>
<li><strong>Master</strong>：集群控制节点，每个集群需要至少一个 master
节点负责集群的管控。</li>
<li><strong>Node</strong>：工作负载节点，由 master 分配容器到这些 node
工作节点上，然后 node 节点上的 docker 负责容器的运行。</li>
<li><strong>Pod</strong>：kubernetes 的最小控制单元，容器都是运行在 pod
中的，一个 pod 可以有 1 个或者多个容器。</li>
<li><strong>Controller</strong>：控制器，通过它来实现对 pod
的管理，比如启动 pod、停止 pod、伸缩 pod 的数量等等。</li>
<li><strong>Service</strong>：pod
对外服务的统一入口，下面可以维护着同一类的多个 pod。</li>
<li><strong>Label</strong>：标签，用于对 pod 进行分类，同一类 pod
会拥有相同的标签。</li>
<li><strong>Namespace</strong>：命名空间，用来隔离 pod 的运行环境。</li>
</ul>
<figure>
<img src="/images/k8s/concept.png" alt="concept" />
<figcaption aria-hidden="true">concept</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2021/11/21/kubernetes/%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E6%BC%94%E5%8F%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/21/kubernetes/%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E6%BC%94%E5%8F%98/" class="post-title-link" itemprop="url">应用部署方式演变</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-21 09:45:00" itemprop="dateCreated datePublished" datetime="2021-11-21T09:45:00+08:00">2021-11-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="应用部署方式演变">应用部署方式演变</h2>
<ul>
<li><strong>传统部署</strong>：互联网早期，会直接将应用程序部署在物理机上。
<ul>
<li>优点：简单，不需要其他技术的参与。</li>
<li>缺点：不能为应用程序定义资源的使用边界，很难合理地分配计算资源，而且应用程序之间容易产生影响。</li>
</ul></li>
<li><strong>虚拟化部署</strong>：可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立的一个环境。
<ul>
<li>优点：程序环境不会相互产生影响，提供了一定程度的安全性。</li>
<li>缺点：增加了操作系统，浪费了部分资源。</li>
</ul></li>
<li><strong>容器化部署</strong>：与虚拟化类似，但是共享了操作系统。
<ul>
<li>优点：
<ul>
<li>可以保证每个容器拥有自己的文件系统、CPU、内存、进程空间等。</li>
<li>运行应用程序所需要的资源都被容器包装，并和底层基础架构解耦。</li>
<li>容器化的应用程序可以跨云服务商、跨 Linux
操作系统发行版进行部署。</li>
</ul></li>
</ul></li>
</ul>
<figure>
<img src="/images/k8s/deployment.png" alt="deployment" />
<figcaption aria-hidden="true">deployment</figcaption>
</figure>
<h2 id="容器化部署的问题">容器化部署的问题</h2>
<ul>
<li>一个容器故障了，怎么样让另外一个容器立刻启动去替补停机的容器。</li>
<li>当并发访问量变大的时候，怎么样做到横向扩展容器数量。</li>
</ul>
<p>这些容器管理的问题统称为<strong>容器编排</strong>问题，为了解决这些容器编排问题，就产生了一些容器编排的软件：</p>
<ul>
<li><strong>Swarm</strong>：Docker 自己的容器编排工具。</li>
<li><strong>Mesos</strong>：Apache 的一个统一管控工具，需要和 Marathon
结合使用</li>
<li><strong>Kubernetes</strong>：Google 开源的容器编排工具。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2021/10/29/linux/firewalld%20%E7%A6%81%E6%AD%A2%20ip%20%E8%AE%BF%E9%97%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/29/linux/firewalld%20%E7%A6%81%E6%AD%A2%20ip%20%E8%AE%BF%E9%97%AE/" class="post-title-link" itemprop="url">firewalld 禁止 ip 访问</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-29 15:19:00" itemprop="dateCreated datePublished" datetime="2021-10-29T15:19:00+08:00">2021-10-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="禁止-ip-1.2.3.4-访问服务器">禁止 ip 1.2.3.4 访问服务器</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-rich-rule=&quot;rule family=ipv4 source address=1.2.3.4 drop&quot;</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后一个 drop
的效果，不返回结果给请求地址，所以客户端会等待直至超时。</p>
</blockquote>
<p><a
target="_blank" rel="noopener" href="https://serverfault.com/questions/157375/reject-vs-drop-when-using-iptables">reject/drop
说明</a></p>
<h2 id="移除-ip-禁止访问规则">移除 ip 禁止访问规则</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --remove-rich-rule &#x27;rule family=&quot;ipv4&quot; source address=&quot;1.2.3.4&quot; drop&#x27;</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="列出所有规则">列出所有规则</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure>
<h2 id="reject-和-drop-的区别">reject 和 drop 的区别</h2>
<p>在firewalld中，DROP很简单就是直接丢弃数据，并不反馈任何回应。需要Client等待超时，Client容易发现自己被防火墙所阻挡。而REJECT则会更为礼貌的返回一个拒绝(终止)数据包(TCP
FIN或UDP-ICMP-PORT-UNREACHABLE)，明确的拒绝对方的连接动作。连接马上断开，Client会认为访问的主机不存在。</p>
<p>至于使用DROP还是REJECT更合适请大家根据自己的使用场景进行选择，
REJECT是一种更符合规范的处理方式，并且在可控的网络环境中，更易于诊断和调试网络/防火墙所产生的问题；而DROP则提供了更高的防火墙安全性和少许的效率提高，但是由于DROP不很规范(不很符合TCP连接规范)的处理方式，可能会对你的网络造成一些不可预期或难以诊断的问题。因为DROP虽然单方面的中断了连接，但是并不返回任何拒绝信息，因此连接客户端将被动的等到tcp
session超时才能判断连接是否成功。</p>
<p>在部署防火墙时，如果是面向企业内部(或部分可信任网络)，那么最好使用规范的REJECT方法，对于需要经常变更或调试规则的网络也是如此；而对于面向危险的Internet/Extranet的防火墙，则有必要使用更为粗暴但是安全的DROP方法，可以在一定程度上延缓攻击的进度或难度。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/28/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><span class="page-number current">29</span><a class="page-number" href="/page/30/">30</a><span class="space">&hellip;</span><a class="page-number" href="/page/70/">70</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/30/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">eleven26</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/eleven26" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
