<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"eleven26.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="eleven26">
<meta property="og:url" content="https://eleven26.github.io/page/7/index.html">
<meta property="og:site_name" content="eleven26">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="eleven26">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://eleven26.github.io/page/7/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>eleven26</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">eleven26</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">100</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">346</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">eleven26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eleven26" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eleven26" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/03/30/gitlab/gitlab%20ci%20%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/30/gitlab/gitlab%20ci%20%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">gitlab ci 优化指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-30 20:01:00" itemprop="dateCreated datePublished" datetime="2024-03-30T20:01:00+08:00">2024-03-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在之前的<a
target="_blank" rel="noopener" href="https://blog.baiguiren.com/2023/04/16/gitlab/gitlab%20ci%20cd%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">《gitlab
ci cd 不完全指南》</a>一文中，我们讲了 gitlab ci 中的一些基本用法。
本文会继续介绍一些在使用 gitlab ci 过程中的优化方法，帮助大家减少在
gitlab ci 上的等待时间。</p>
<p>本文会从以下几个方面来介绍 gitlab ci 的优化方法：</p>
<ol type="1">
<li>gitlab runner 的配置优化：包括 executor 的选择、concurrent
的设置等</li>
<li>依赖缓存：如何使用 cache 来加速构建</li>
<li>依赖使用国内的源：如何使用国内的源来加速依赖的下载</li>
<li>多个 job 同时执行</li>
<li>job 配置优化：cache policy、GIT_STRATEGY、dependencies</li>
<li>网络优化：减少同步代码的时间</li>
<li>升级 gitlab 及 runner 版本</li>
</ol>
<h2 id="gitlab-runner-的配置优化">gitlab runner 的配置优化</h2>
<h3 id="concurrent-配置">concurrent 配置</h3>
<p>gitlab runner 中有一个很重要的配置是 <code>concurrent</code>，它表示
gitlab runner 同时运行的 job 数量。默认情况下，<code>concurrent</code>
的值是 1，也就是说 gitlab runner 同时只能运行一个 job。如果你的 gitlab
runner 有多个 executor，那么可以将 <code>concurrent</code> 设置为大于 1
的值，这样可以让 gitlab runner 同时运行多个 job，从而减少等待时间。</p>
<p>具体可参考：https://docs.gitlab.com/runner/configuration/advanced-configuration.html</p>
<h3 id="executor-的选择">executor 的选择</h3>
<p>比较常见的是 docker 和 shell 类型的 executor，docker executor
的优势是可以在不同的环境中运行 job，比如在不同的镜像中运行
job，这样可以避免环境的不一致性。 而 shell executor 的优势是可以直接在
gitlab runner 的机器上运行 job，不需要额外的环境，在较老的 gitlab
版本中，shell executor 是很快的，但 shell executor 的可靠性较低，依赖于
gitlab runner 的机器，如果机器出现问题，那么 job 就会失败。</p>
<p>在 16.10 版本的实际使用中，docker executor
的速度有了明显提升，所以不必为了速度而选择 shell executor。</p>
<p>具体可参考：https://docs.gitlab.com/runner/executors/</p>
<h3 id="docker-executor-的-pull-policy">docker executor 的 pull
policy</h3>
<p>docker executor 在运行 job 时，会拉取 docker
镜像，这个过程会耗费一些时间。我们可以通过设置 <code>pull_policy</code>
来控制是否每次都拉取镜像。默认情况下，<code>pull_policy</code> 的值是
<code>always</code>，也就是每次都会拉取镜像。
如果我们的镜像不经常更新（比如那种用来 build 项目的 job
所依赖的镜像），那么可以将 <code>pull_policy</code> 设置为
<code>if-not-present</code>，这样只有在本地没有镜像的时候才会拉取镜像。</p>
<p>可选值：</p>
<ul>
<li><code>always</code>: 每次都拉取镜像</li>
<li><code>if-not-present</code>: 本地没有镜像的时候才会拉取镜像</li>
<li><code>never</code>: 从不拉取镜像</li>
</ul>
<p>具体可参考：https://docs.gitlab.com/runner/executors/docker.html#configure-how-runners-pull-images</p>
<h2 id="依赖缓存">依赖缓存</h2>
<p>如果我们的项目需要下载一些第三方依赖，比如 npm、composer、go mod
等，那么我们可以使用 cache 来加速构建。cache 会将我们下载的依赖缓存到
gitlab runner 中，下次构建时就不需要重新下载依赖了。</p>
<p>下面是一个前端项目的例子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">package.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">package-lock.json</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node_modules/</span></span><br></pre></td></tr></table></figure>
<p>上面这个例子的含义是：</p>
<ul>
<li>当 package.json 或 package-lock.json
文件发生变化时，就会重新下载依赖（不使用缓存）</li>
<li>将 node_modules 目录缓存到 gitlab runner 中</li>
</ul>
<p>具体可参考：https://docs.gitlab.com/ee/ci/caching/</p>
<p>需要注意的是：<strong>通过监测多个文件的变动来决定是否使用缓存的这个配置，在较新版本的
gitlab 中才有，具体忘记什么版本开始支持</strong></p>
<h2 id="依赖使用国内的源">依赖使用国内的源</h2>
<p>还是拿部署前端项目作为例子，我们在下载依赖时，可以使用国内的源来加速下载。比如使用淘宝的
npm 镜像：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">config</span> <span class="string">set</span> <span class="string">sass_binary_site</span> <span class="string">https://npmmirror.com/mirrors/node-sass</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">config</span> <span class="string">set</span> <span class="string">registry</span> <span class="string">https://registry.npmmirror.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure>
<p>实际上其实就是我们在 <code>npm install</code> 之前设置了一下
registry，这样就会使用国内的源来下载依赖。</p>
<p>类似的，其他常用语言的包管理工具一般都有国内源，比如 go mod
有七牛云、composer 有阿里云的源等。</p>
<h2 id="多个-job-同时执行一个-stage-的多个-job">多个 job 同时执行：一个
stage 的多个 job</h2>
<p>这里说的是那种没有相互依赖的
job，可以同时执行。比如在我们的后端项目中，<code>build</code> 这个
<code>stage</code> 中有两个 job，一个是用来生成 api
文档的，另一个是用来安装依赖的。
因为生成文档这个操作只是依赖于源码本身，不需要等到依赖安装完成，所以可以同时执行。</p>
<p>这种情况实际上就是把多个 job 放到一个 stage 中，这样 gitlab ci
就会同时执行这些 job：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">composer:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">composer</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apidoc:</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">php</span> <span class="string">artisan</span> <span class="string">apidoc</span></span><br></pre></td></tr></table></figure>
<p><strong>注意：如果 job
之间有依赖，或者可能会读写相同的文件，那么可能会有异常。</strong></p>
<h2 id="job-配置优化">job 配置优化</h2>
<h3 id="cache-policy">cache policy</h3>
<p>这在之前那篇文章有说过，这里再重复一下。默认是 pull-push。意思是在
job 开始时拉取缓存，push 是在 job 结束时推送缓存，这样会保留我们在 job
执行过程中对缓存目录的变更。</p>
<p>但是实际上有时候我们是不需要在 job 结束的时候更新缓存的，比如我们的
job 不会更新缓存目录，那么我们可以设置为 pull，这样在 job
结束的时候就不会推送缓存了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只是拉取缓存，然后同步到服务器的 job，不会更新缓存</span></span><br><span class="line"><span class="attr">sync:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span></span><br><span class="line">      <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">composer.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">composer.lock</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;vendor/&quot;</span></span><br><span class="line">    <span class="attr">policy:</span> <span class="string">pull</span></span><br></pre></td></tr></table></figure>
<h3 id="git_strategy-none">GIT_STRATEGY: none</h3>
<p>跟上面这一小点类似，如果我们的 job 并不需要拉取代码，那么可以设置
<code>GIT_STRATEGY</code> 为
<code>none</code>，这样就不会拉取代码了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">GIT_STRATEGY:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure>
<p>在实际中的应用场景是：部署跟发布分离的时候，发布的 job
并不需要拉取代码，只需要通过远程 ssh 命令执行发布的脚本即可。如果我们的
git 仓库比较大，那么这样可以减少一些时间。</p>
<h3 id="dependencies">dependencies: []</h3>
<p>我们知道，gitlab ci 中的 job 可以产出一些构建的产物，比如前端项目
build 出来的静态文件、go 项目编译出来的二进制文件等，这些产物可以被其他
job 使用，只要我们通过 <code>artifacts</code> 配置即可。</p>
<p>但并不是所有的 job 都需要这些 <code>artifacts</code>
的，这个时候我们可以通过 <code>dependencies: []</code> 来告诉 gitlab ci
这个 job 不需要依赖其他 job 的产物。</p>
<p>这样就可以节省下下载 <code>artifacts</code> 的时间。</p>
<h2 id="网络优化">网络优化</h2>
<p>网络状况的好坏直接影响了同步代码的时间，这也是最容易做到的优化方式了。如果我们需要同步的机器比较多，而且同步的文件比较大的时候，网络优化带来的效果就更加明显了。</p>
<h2 id="升级-gitlab-及-runner-版本">升级 gitlab 及 runner 版本</h2>
<p>最近将 gitlab 从 15.9 升级到 16.10 后，发现使用 docker 的 executor
的时候，初始化容器的速度相比旧版本有明显了提升。这也说明了 gitlab
在不断的优化中，所以及时升级 gitlab 及 runner
版本也是一个不错的选择。</p>
<blockquote>
<p>原来可能要 5~10s，如果 job 的数量多，这点提升就会比较明显了。</p>
</blockquote>
<p>当然我们可以选择一个 stage 多个 job，但是有很多时候一些 job
是没有办法并行的，因为会相互影响。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/03/28/gitlab/gitlab%2015.9%20%E5%8D%87%E7%BA%A7%E5%88%B0%2016.10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/28/gitlab/gitlab%2015.9%20%E5%8D%87%E7%BA%A7%E5%88%B0%2016.10/" class="post-title-link" itemprop="url">gitlab 15.9 升级到 16.10</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-28 10:01:00" itemprop="dateCreated datePublished" datetime="2024-03-28T10:01:00+08:00">2024-03-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="原因">原因</h2>
<p>在 15.9 版本中，gitlab ci 中的 job
无法在失败之后进行重试，表现为失败之后进入 <code>pending</code>
状态，一直持续。从而导致了在有时候 job
偶尔的失败需要手动去重试，非常不方便。有时候还会因为来不及手动重试会直接影响线上服务。</p>
<p><img src="/images/gitlab/upgrade/1.png" /></p>
<h2 id="gitlab-15.9-使用的-docker-配置">gitlab 15.9 使用的 docker
配置</h2>
<p>gitlab 使用的是 docker 部署，docker-compose 配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gitlab:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ce:15.9.3-ce.0&#x27;</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">&#x27;192.168.2.168&#x27;</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      external_url &#x27;http://192.168.2.168:8200&#x27;</span></span><br><span class="line"><span class="string">      pages_external_url &#x27;http://192.168.2.168:8300&#x27;</span></span><br><span class="line"><span class="string">      gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2222</span></span><br><span class="line"><span class="string"></span>  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8200:8200&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8300:8300&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;2222:22&#x27;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab/data:/var/opt/gitlab&#x27;</span></span><br><span class="line">  <span class="attr">shm_size:</span> <span class="string">&#x27;256m&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="要解决的几个关键问题">要解决的几个关键问题</h2>
<p>因为是 docker
配置，所以本来打算直接用旧的文件夹来启动一个新版本的容器，不过在启动新版本的容器的时候起不来。
因为版本跨度过大，可能中间太多不兼容，最后决定起一个新的容器，然后把旧的数据手动迁移过去。</p>
<p><strong>在本次迁移中，为了保证旧的用户密码在迁移后依然可用，直接使用了旧的配置文件来启动新的
gitlab 容器，也就是上面 docker-compose 配置中的 /user/lnmp/gitlab/config
这个文件夹。</strong></p>
<blockquote>
<p>gitlab 没有什么工具可以用来迁移数据的，所以比较麻烦。</p>
</blockquote>
<p>在迁移过程中，有几个很关键的问题需要解决：</p>
<ol type="1">
<li>用户和组迁移</li>
<li>用户的 ssh key 迁移</li>
<li>项目迁移</li>
<li>用户权限迁移</li>
</ol>
<p>用户权限这个没有什么好的办法，只能手动去设置。如果用户太多的话，可以看看
gitlab 有没有提供 API，使用它的 API 可能会方便一些。</p>
<p>其他的几个问题可以稍微简单一点，本文会详细介绍。</p>
<h3 id="gitlab-获取-token-以及调用-api-的方法">gitlab 获取 token
以及调用 API 的方法</h3>
<blockquote>
<p>我们需要使用管理员账号来创建 token，其他账号是没有权限的。</p>
</blockquote>
<p>gitlab 提供了很多 REST API，可以通过这些 API 来获取到 gitlab
的数据，以及对 gitlab 进行操作。 我们的一些迁移操作就调用了它的 API
来简化操作，同时也可以避免人为操作导致的一些错误。</p>
<p>但是调用这些 API 之前，我们需要获取到一个 token，从 gitlab
个人设置中获取到 token，然后使用这个 token 来调用
API（<code>Preferences -&gt; Access Tokens</code>，添加 token
的时候把所有权限勾上就好）。</p>
<p>通过 REST API 导出分组的示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --request POST --header &quot;PRIVATE-TOKEN: glpat-L1efQKvKeWu&quot; &quot;http://192.168.2.168:8200/api/v4/groups/1/export&quot;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li><code>PRIVATE-TOKEN</code> header：就是我们在 gitlab
个人设置中获取到的 token。</li>
<li><code>/api/v4/groups/1/export</code>：这个是 gitlab 的
API，可以通过这个 API 导出分组，这里的 <code>1</code> 是分组的 ID。</li>
</ul>
<p>我们可以将这个 <code>curl</code>
命令通过使用自己熟悉的编程语言来调用，这样可以很方便地对获取到的数据进行后续操作。比如我在这个过程中就是使用
python 来调用 gitlab 的 API。</p>
<h2 id="启动一个新的-gitlab-16.10-版本的容器">启动一个新的 gitlab 16.10
版本的容器</h2>
<p>在开始迁移之前，需要先启动一个新的 gitlab 16.10
版本的容器，这个容器是全新的，没有任何数据。但配置文件是复制了一份旧的配置文件。新的
<code>docker-compose.yml</code> 配置文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gitlab:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ce:15.9.3-ce.0&#x27;</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">&#x27;192.168.2.168&#x27;</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      external_url &#x27;http://192.168.2.168:8200&#x27;</span></span><br><span class="line"><span class="string">      pages_external_url &#x27;http://192.168.2.168:8300&#x27;</span></span><br><span class="line"><span class="string">      gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2222</span></span><br><span class="line"><span class="string"></span>  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8200:8200&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8300:8300&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;2222:22&#x27;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab/data:/var/opt/gitlab&#x27;</span></span><br><span class="line">  <span class="attr">shm_size:</span> <span class="string">&#x27;256m&#x27;</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="attr">gitlab-new:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">&quot;gitlab-new&quot;</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ce:16.10.0-ce.0&#x27;</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">&#x27;192.168.2.168&#x27;</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      external_url &#x27;http://192.168.2.168:8211&#x27;</span></span><br><span class="line"><span class="string">      pages_external_url &#x27;http://192.168.2.168:8311&#x27;</span></span><br><span class="line"><span class="string">      gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2233</span></span><br><span class="line"><span class="string"></span>  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8211:8211&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8311:8311&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;2233:22&#x27;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab-new/config:/etc/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab-new/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/usr/lnmp/gitlab-new/data:/var/opt/gitlab&#x27;</span></span><br><span class="line">  <span class="attr">shm_size:</span> <span class="string">&#x27;256m&#x27;</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br></pre></td></tr></table></figure>
<p>在个配置文件中：</p>
<ol type="1">
<li>旧的配置保持不变</li>
<li>旧的配置目录复制了一份 <code>/usr/lnmp/gitlab/config</code> =&gt;
<code>/usr/lnmp/gitlab-new/config</code></li>
<li><code>/usr/lnmp/gitlab-new</code> 目录下只有 <code>config</code>
文件夹，没有 <code>logs</code> 和 <code>data</code>
文件夹，这两个文件夹会在容器启动过程中生成。</li>
</ol>
<p>这样我们就可以在旧的 gitlab
运行过程中，先进行用户、组等数据的迁移。</p>
<h3 id="用户迁移">用户迁移</h3>
<p>Gitlab 提供了获取用户信息的 API，可以通过这个 API
获取到用户的信息（从旧的 gitlab），然后再通过 API 创建用户（在新的
gitlab）。</p>
<blockquote>
<p>我们可以在 https://docs.gitlab.com/16.10/ee/api/users.html 查看
gitlab 的用户 API 详细文档。</p>
</blockquote>
<p>我们会用到它的几个 API：</p>
<ol type="1">
<li>获取用户信息：<code>GET /users</code>：通过这个 API
我们可以获取到所有用户的信息（从旧的 gitlab）。</li>
<li>获取用户的 ssh key：<code>GET /users/:id/keys</code>：通过这个 API
我们可以获取到用户的 ssh key（从旧的 gitlab）。</li>
<li>创建用户：<code>POST /users</code>：通过这个 API
我们可以创建用户（到新的 gitlab）。</li>
<li>创建用户的 ssh key：<code>POST /users/:id/keys</code>：通过这个 API
我们可以创建用户的 ssh key（到新的 gitlab）。</li>
</ol>
<h4 id="从旧的-gitlab-获取用户信息">从旧的 gitlab 获取用户信息</h4>
<p>完整代码太长了，这里只放出关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://192.168.2.168:8200 是旧的 gitlab 地址</span></span><br><span class="line">response = requests.get(<span class="string">&quot;http://192.168.2.168:8200/api/v4/users?per_page=100&quot;</span>, headers=&#123;<span class="string">&#x27;Private-Token&#x27;</span>: tk&#125;)</span><br><span class="line">users = response.json()</span><br></pre></td></tr></table></figure>
<p>这里的 <code>tk</code> 是我们在 gitlab 个人设置中获取到的 token。</p>
<p>它返回的数据格式如下（<code>users</code>）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">33</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deactivated&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;web_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.2.168:8200/x&quot;</span></span><br><span class="line">    <span class="comment">// 其他字段....</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<h4 id="从旧的-gitlab-获取用户的-ssh-key">从旧的 gitlab 获取用户的 ssh
key</h4>
<p>在上一步获取到所有的用户信息之后，我们可以通过用户的 ID 来获取用户的
ssh key。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://192.168.2.168:8200 是旧的 gitlab 地址</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    ssh_keys_response = requests.get(<span class="string">f&quot;http://192.168.2.168:8200/api/v4/users/<span class="subst">&#123;user[<span class="string">&#x27;id&#x27;</span>]&#125;</span>/keys&quot;</span>, headers=&#123;<span class="string">&#x27;Private-Token&#x27;</span>: tk&#125;)</span><br><span class="line">    user[<span class="string">&#x27;keys&#x27;</span>] = ssh_keys_response.json()</span><br></pre></td></tr></table></figure>
<p>这里的 <code>user['keys']</code> 就是用户的 ssh key
信息，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ming&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ming&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;win7&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-04-10T03:15:54.428Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;expires_at&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssh-rsa AAAAB3Nza...&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usage_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth_and_signing&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>这一步，我们获取了用户的 ssh key 并关联到了 user 中了。</p>
<h4 id="在新的-gitlab-上创建用户">在新的 gitlab 上创建用户</h4>
<p>在获取到了用户信息之后，我们就可以在新的 gitlab 上创建用户了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://192.168.2.168:8211 是新的 gitlab 的地址</span></span><br><span class="line">create_user_response = requests.post(<span class="string">&quot;http://192.168.2.168:8211/api/v4/users&quot;</span>, headers=&#123;<span class="string">&#x27;Private-Token&#x27;</span>: tk_new&#125;, json=&#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: user[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: user[<span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: user[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&#x27;12345678Git*&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;note&#x27;</span>: user[<span class="string">&#x27;note&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;bio&#x27;</span>: user[<span class="string">&#x27;bio&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;commit_email&#x27;</span>: user[<span class="string">&#x27;commit_email&#x27;</span>],</span><br><span class="line">&#125;)</span><br><span class="line">user[<span class="string">&#x27;new_user&#x27;</span>] =  create_user_response.json()</span><br></pre></td></tr></table></figure>
<p>这个接口会返回新创建的用户信息，格式如下，我们可以通过这个信息来获取到新创建的用户的
ID。</p>
<blockquote>
<p>因为新旧 gitlab 的用户 ID 会不一样，所以这里需要获取新的 ID 来创建
ssh key。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;locked&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;web_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.2.168:8211/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 其他字段</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="在新的-gitlab-上创建用户的-ssh-key">在新的 gitlab 上创建用户的
ssh key</h4>
<p>创建了用户之后，我们就可以创建用户的 ssh key 了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://192.168.2.168:8211 是新的 gitlab 的地址</span></span><br><span class="line"><span class="keyword">for</span> ssh_key <span class="keyword">in</span> user[<span class="string">&#x27;keys&#x27;</span>]:</span><br><span class="line">    create_keys_response = requests.post(</span><br><span class="line">        <span class="string">f&quot;http://192.168.2.168:8211/api/v4/users/<span class="subst">&#123;user[<span class="string">&#x27;new_user&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]&#125;</span>/keys&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&#x27;Private-Token&#x27;</span>: tk_new&#125;,</span><br><span class="line">        json=&#123;<span class="string">&quot;title&quot;</span>: ssh_key[<span class="string">&#x27;title&#x27;</span>],<span class="string">&quot;key&quot;</span>: ssh_key[<span class="string">&#x27;key&#x27;</span>]&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(create_keys_response.json())</span><br></pre></td></tr></table></figure>
<p>到这里，我们就把用户迁移过来了。</p>
<h2 id="新旧-gitlab-用户密码不一样的问题">新旧 gitlab
用户密码不一样的问题</h2>
<p>在现代的应用中，密码一般会使用诸如 <code>APP_KEY</code>
这种应用独立的 <code>key</code> 来做一些加密，如果是不同的
<code>key</code>，那么加密出来的密码就会不一样。
出于这个考虑，我们在迁移的过程中，直接保留了旧的配置，里面包含了应用的一些
<code>key</code>，这样我们就可以直接从旧系统的数据库中提取出加密后的密码来使用，
因为加密的时候使用的 <code>key</code>
是一样的，所以放到新的系统中是可以直接使用的。</p>
<h4 id="从旧的-gitlab-数据库中获取用户密码">从旧的 gitlab
数据库中获取用户密码</h4>
<ol type="1">
<li>进入 gitlab 容器内部：<code>docker exec -it gitlab bash</code></li>
<li>进入 gitlab 数据库：<code>gitlab-rails dbconsole</code></li>
<li>获取用户密码：<code>select username, encrypted_password from users;</code></li>
</ol>
<p>这会输出所有用户的用户名和加密后的密码，我们可以把这个密码直接放到新的
gitlab 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  username  |                      encrypted_password</span><br><span class="line">------------+--------------------------------------------------------------</span><br><span class="line"> a  | $2a$10$k1/Cj2qUCyWgwalCmzTFo.iqYgnqIoFmQVuT2S6mBuQF0Nql0CRGm</span><br><span class="line"> b  | $2a$10$iWWXEcPJpyZVxfmIU6nv6e46JRj2dYnwGP6GXclryEAeEXJvOZ5aC</span><br></pre></td></tr></table></figure>
<p>因为 <code>username</code> 是唯一的，所以我们可以通过
<code>username</code> 来找到新的 gitlab
中对应的用户（肉眼查找法），最后更新这个用户的
<code>encrypted_password</code> 字段即可。</p>
<p>当然，也可以复制出来做一些简单的文本处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> a  | $2a$10$k1/Cj2qUCyWgwalCmzTFo.iqYgnqIoFmQVuT2S6mBuQF0Nql0CRGm</span></span><br><span class="line"><span class="string"> b  | $2a$10$iWWXEcPJpyZVxfmIU6nv6e46JRj2dYnwGP6GXclryEAeEXJvOZ5aC</span></span><br><span class="line"><span class="string"> &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">lines = text.strip().split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    kvs = [v.strip() <span class="keyword">for</span> v <span class="keyword">in</span> line.strip().split(<span class="string">&#x27;|&#x27;</span>)]</span><br><span class="line">    result.append(&#123;kvs[<span class="number">0</span>]: kvs[<span class="number">1</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>
<p>这样我们就可以得到一个字典列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&#x27;a&#x27;: &#x27;$2a$10$k1/Cj2qUCyWgwalCmzTFo.iqYgnqIoFmQVuT2S6mBuQF0Nql0CRGm&#x27;&#125;,</span><br><span class="line">&#123;&#x27;b&#x27;: &#x27;$2a$10$iWWXEcPJpyZVxfmIU6nv6e46JRj2dYnwGP6GXclryEAeEXJvOZ5aC&#x27;&#125;]</span><br></pre></td></tr></table></figure>
<h4 id="在新的-gitlab-中更新用户密码">在新的 gitlab 中更新用户密码</h4>
<p>同样地，需要进入新的 gitlab
容器内部，然后进入数据库，然后更新用户密码：</p>
<ol type="1">
<li>进入 gitlab
容器内部：<code>docker exec -it gitlab-new bash</code></li>
<li>进入 gitlab 数据库：<code>gitlab-rails dbconsole</code></li>
<li>获取用户密码：<code>select id, username from users;</code></li>
</ol>
<p>拿到上一步的字典后，我们可以通过 <code>username</code> 找到新的
gitlab 中对应的用户 ID，然后更新密码：</p>
<ol type="1">
<li>通过新的 gitlab 的用户 API 获取用户列表</li>
<li>循环这个用户列表，如果 <code>username</code>
在上一步的字典中，那么就更新这个用户的密码</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://192.168.2.168:821 是新的 gitlab 地址</span></span><br><span class="line"><span class="comment"># tk_new 是新的 gitlab 上的 token</span></span><br><span class="line">response = requests.get(<span class="string">&quot;http://192.168.2.168:8211/api/v4/users?per_page=100&quot;</span>, headers=&#123;<span class="string">&#x27;Private-Token&#x27;</span>: tk_new&#125;)</span><br><span class="line">users = response.json()</span><br></pre></td></tr></table></figure>
<p>因为连接到 gitlab 的数据库又比较麻烦，所以这里只是生成了的 update
语句，然后手动在新的 gitlab 数据库中执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users 是新 gitlab 中的用户</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    <span class="keyword">if</span> user[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">in</span> result:</span><br><span class="line">        <span class="comment"># 通过 username 找到旧的密码</span></span><br><span class="line">        encrypted_password = result[user[<span class="string">&#x27;username&#x27;</span>]]</span><br><span class="line">        <span class="comment"># 生成 update 语句</span></span><br><span class="line">        <span class="comment"># 这个 update 语句会将新系统中的用户密码更新为旧系统中的密码</span></span><br><span class="line">        <span class="comment"># 因为是使用相同的 key 加密的，所以迁移后也依然可以使用旧的密码来登录</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;update users set encrypted_password=&#x27;<span class="subst">&#123;encrypted_password&#125;</span>&#x27;, reset_password_token=null, reset_password_sent_at = null,confirmation_token=null,confirmation_sent_at=null where id=<span class="subst">&#123;user[<span class="string">&#x27;id&#x27;</span>]&#125;</span>;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这会生成一些 update 语句，我们可以复制出来在新的 gitlab
中执行（也就是本小节的 <code>gitlab-rails dbconsole</code>）。
到这一步，用户的迁移就算完成了。</p>
<h4 id="group-的迁移">Group 的迁移</h4>
<p>Group 的迁移和用户的迁移类似，只是 Group 的 API 不同，我们可以在
https://docs.gitlab.com/ee/api/group_import_export.html 查看 gitlab 的
Group API 文档。</p>
<p>注意：如果我们的 Group 中除了项目，没什么东西的话，直接自己手动在
gitlab 上创建 Group，然后把项目迁移过去就好了。 使用它的 API
是因为它可以同时迁移：milestone、label、wiki、子 Group 等信息。</p>
<ol type="1">
<li>我们首先需要知道在旧的 gitlab 中的 Group ID，然后通过 API 导出
Group（旧的 gitlab）。</li>
<li>调用了导出的 API
之后，需要等待系统导出完成，然后下载导出的文件（旧的 gitlab）。</li>
<li>调用下载导出文件的 API，获取到导出的分组（旧的 gitlab）。</li>
<li>最后，调用导入分组的 API，将分组导入到新的 gitlab 中（新的
gitlab）。</li>
</ol>
<p>下面是一个例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从旧的 gitlab 导出 Group，1 是 Group ID</span></span><br><span class="line">curl --request POST --header &quot;PRIVATE-TOKEN: glpat-abc&quot; &quot;http://192.168.2.168:8200/api/v4/groups/1/export&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载导出的分组</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--output 指定下载的文件名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`api/v4/groups/1/export/download` 中的 1 是 Group ID</span></span><br><span class="line">curl --request GET \</span><br><span class="line">      --header &quot;PRIVATE-TOKEN: glpat-abc&quot; \</span><br><span class="line">      --output download_group_42.tar.gz \</span><br><span class="line">      &quot;http://192.168.2.168:8200/api/v4/groups/1/export/download&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入分组（在新的 gitlab）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--form 指定 form 表单参数</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`name` 是新的 Group 名称（给人看的名称）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`path` 是新的 Group 路径（体现在 git 仓库的路径上）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`file` 是下载的文件（上一步导出的 Group 文件）</span></span><br><span class="line">curl --request POST --header &quot;PRIVATE-TOKEN: glpat-def&quot; \</span><br><span class="line">     --form &quot;name=g1&quot; --form &quot;path=g2&quot; \</span><br><span class="line">     --form &quot;file=@/Users/ruby/Code/devops/download_group_42.tar.gz&quot; &quot;http://192.168.2.168:8211/api/v4/groups/import&quot;</span><br></pre></td></tr></table></figure>
<p>这样就可以把 Group 迁移过来了。</p>
<h2 id="项目迁移">项目迁移</h2>
<p>项目的迁移没有找到什么好的方法，只能手动迁移了。</p>
<p>gitlab 的项目因为有很多分支、release、issue，所以不能只是简单地把 git
仓库拷贝过去就好了，还需要把这些信息也迁移过去。
这就需要将项目导出，然后导入到新的 gitlab 中。</p>
<p>具体操作步骤如下：</p>
<ol type="1">
<li>在项目主页的
<code>Settings -&gt; General -&gt; Advanced -&gt; Export project</code>
中导出项目</li>
<li>点击导出之后，需要等待导出完成，然后下载导出的文件，还是在
<code>Settings -&gt; General -&gt; Advanced -&gt; Export project</code>
中，点击下载</li>
<li>在新的 gitlab 中，点击 <code>New Project</code>，然后选择
<code>Import project</code>，选择上一步下载的文件，导入项目（导入的类型选择
<code>Gitlab export</code>）</li>
<li>填写项目名，命名空间选择跟旧的 gitlab 一样的
Group，选择上一步下载的文件，然后点击
<code>Import project</code>，等待导入完成即可</li>
</ol>
<h2 id="权限迁移">权限迁移</h2>
<p>这个也是得手动设置，没有什么好的办法。 也许有
API，但是用户少的时候，还是手动设置更快。</p>
<h2 id="gitlab-runner-迁移">gitlab runner 迁移</h2>
<p>这个也是看着旧的 gitlab runner 配置，手动配置一下就完了，没几个。</p>
<p>需要注意的是，gitlab runner 配置的 <code>docker</code> 类型的 runner
的时候，需要加上
<code>pull_policy = ["if-not-present"]</code>，这样会在执行 job
的时候快很多，不然每次都会去拉取镜像。</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  <span class="attr">name</span> = <span class="string">&quot;docker-runner&quot;</span></span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    <span class="attr">pull_policy</span> = [<span class="string">&quot;if-not-present&quot;</span>]</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>最后，再回顾一下迁移过程的一些关键操作：</p>
<ol type="1">
<li>用户迁移：通过 API 从旧的 gitlab 获取用户信息、ssh key，然后在新的
gitlab 中通过 API 创建用户、创建 ssh key。</li>
<li>用户密码可以进入容器中使用 <code>gitlab-rails dbconsole</code>
来获取用户密码，然后在新的 gitlab 中更新用户密码。</li>
<li>Group 迁移：通过 API 导出 Group，然后下载导出的文件，最后导入到新的
gitlab 中。</li>
<li>项目迁移：通过 gitlab
的项目导出、导入功能来迁移项目。这种迁移方式会保留项目的
<code>issues</code>、分支 等信息。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/03/01/log/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20Filebeat%20%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/01/log/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20Filebeat%20%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">如何使用 Filebeat 收集日志</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-01 21:28:30" itemprop="dateCreated datePublished" datetime="2024-03-01T21:28:30+08:00">2024-03-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Filebeat
是一款功能强大的日志传送器，旨在简化从不同来源收集、处理和转发日志到不同目的地的过程。Filebeat
在开发时充分考虑了效率，可确保日志管理无缝且可靠。它的轻量级特性和处理大量数据的能力使其成为开发人员和系统管理员的首选。</p>
<p>在本综合指南中，您将深入探索 Filebeat
的功能。从基础知识开始，您将设置 Filebeat
以从各种来源收集日志。然后，您将深入研究高效处理这些日志的复杂性，从
Docker 容器收集日志并将其转发到不同的目标进行分析和监视。</p>
<h2 id="前言">前言</h2>
<p>在上一篇文章<a
target="_blank" rel="noopener" href="https://blog.baiguiren.com/2024/03/01/log/Filebeat%20vs%20Logstash:%20%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%B7%A5%E5%85%B7%E5%AF%B9%E6%AF%94/">《Filebeat
vs Logstash：日志采集工具对比》</a>中，我们对比了 Filebeat 和 Logstash
的一些优缺点，下面是一份简介版的总结：</p>
<p><img src="/images/filebeat/filebeatvslogstash-min.png" /></p>
<p>我们可以看到，<strong>我们选择 Filebeat
一方面是因为它占用资源少，另外一方面是我们不需要对日志做复杂的处理，同时也不需要将日志发送到多个目的地。</strong></p>
<h2 id="环境准备">环境准备</h2>
<p>创建用以测试的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir log-processing-stack</span><br><span class="line">cd log-processing-stack</span><br></pre></td></tr></table></figure>
<p>为演示应用程序创建一个子目录并移动到该目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir logify &amp;&amp; cd logify</span><br></pre></td></tr></table></figure>
<p>完成这些步骤后，您可以在下一节中创建演示日志记录应用程序。</p>
<h2 id="开发演示日志记录应用程序">开发演示日志记录应用程序</h2>
<p>在本节中，你将使用 Bash
脚本语言构建一个基本的日志记录应用程序。应用程序将定期生成日志，模拟应用程序生成日志数据的真实场景。</p>
<p>在 <code>logify</code> 目录中，创建一个名为 <code>logify.sh</code>
的文件，并将以下内容添加到文件中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">filepath=&quot;/var/log/logify/app.log&quot;</span><br><span class="line"></span><br><span class="line">create_log_entry() &#123;</span><br><span class="line">    local info_messages=(&quot;Connected to database&quot; &quot;Task completed successfully&quot; &quot;Operation finished&quot; &quot;Initialized application&quot;)</span><br><span class="line">    local random_message=$&#123;info_messages[$RANDOM % $&#123;#info_messages[@]&#125;]&#125;</span><br><span class="line">    local http_status_code=200</span><br><span class="line">    local ip_address=&quot;127.0.0.1&quot;</span><br><span class="line">    local emailAddress=&quot;user@mail.com&quot;</span><br><span class="line">    local level=30</span><br><span class="line">    local pid=$$</span><br><span class="line">    local time=$(date +%s)</span><br><span class="line">    local log=&#x27;&#123;&quot;status&quot;: &#x27;$http_status_code&#x27;, &quot;ip&quot;: &quot;&#x27;$ip_address&#x27;&quot;, &quot;level&quot;: &#x27;$level&#x27;, &quot;emailAddress&quot;: &quot;&#x27;$emailAddress&#x27;&quot;, &quot;msg&quot;: &quot;&#x27;$random_message&#x27;&quot;, &quot;pid&quot;: &#x27;$pid&#x27;, &quot;timestamp&quot;: &#x27;$time&#x27;&#125;&#x27;</span><br><span class="line">    echo &quot;$log&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while true; do</span><br><span class="line">    log_record=$(create_log_entry)</span><br><span class="line">    echo &quot;$&#123;log_record&#125;&quot; &gt;&gt; &quot;$&#123;filepath&#125;&quot;</span><br><span class="line">    sleep 3</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p><code>create_log_entry()</code> 函数以 JSON
格式生成日志记录，包含严重性级别、消息、HTTP
状态代码和其他关键字段等基本详细信息。此外，它还包括敏感字段，例如电子邮件地址、和
IP 地址，这些字段是特意包含的，以展示 Filebeat
屏蔽字段中敏感数据的能力。</p>
<p>接下来，程序进入无限循环，重复调用 <code>create_log_entry()</code>
函数并将日志写入 <code>/var/log/logify</code> 目录中的指定文件。</p>
<p>添加完代码后，保存更改并使脚本可执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x logify.sh</span><br></pre></td></tr></table></figure>
<p>然后，创建 <code>/var/log/logify</code>
用于存储应用程序日志的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /var/log/logify</span><br></pre></td></tr></table></figure>
<p>接下来，使用 <code>$USER</code> 环境变量将
<code>/var/log/logify</code> 目录的所有权分配给当前登录的用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $USER:$USER /var/log/logify/</span><br></pre></td></tr></table></figure>
<p>在后台运行 <code>logify.sh</code> 脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./logify.sh &amp;</span><br></pre></td></tr></table></figure>
<p>命令末尾的 <code>&amp;</code>
符号指示脚本在后台运行，允许您在日志记录应用程序独立运行时继续使用终端执行其他任务。</p>
<p>当程序启动时，它将显示如下所示的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1] 91773</span><br></pre></td></tr></table></figure>
<p>此处表示 <code>91773</code> 进程 ID，如果需要，该 ID
可用于稍后终止脚本。</p>
<p>若要查看 <code>app.log</code> 文件的内容，可以使用以下
<code>tail</code> 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -n 4 /var/log/logify/app.log</span><br></pre></td></tr></table></figure>
<p>此命令以 JSON 格式显示 <code>app.log</code> 文件中的最后 4
个日志条目：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connected to database&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286422</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286425</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286428</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Operation finished&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709286431</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>现在，您已成功创建用于生成示例日志条目的日志记录应用程序。</p>
<h2 id="安装-filebeat">安装 Filebeat</h2>
<p>我的系统是 MacOS，所以执行下面的命令即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.12.2-darwin-x86_64.tar.gz</span><br><span class="line">tar xzvf filebeat-8.12.2-darwin-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
<p>最后，进入 <code>filebeat</code> 目录下去执行 <code>filebeat</code>
命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd filebeat-8.12.2-darwin-x86_64</span><br><span class="line">./filebeat version</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebeat version 8.12.2 (amd64), libbeat 8.12.2 [0b71acf2d6b4cb6617bff980ed6caf0477905efa built 2024-02-15 13:39:16 +0000 UTC]</span><br></pre></td></tr></table></figure>
<h2 id="filebeat-的工作原理">Filebeat 的工作原理</h2>
<p>在开始使用 Filebeat
之前，了解其工作原理至关重要。在本节中，我们将探讨其基本组件和流程，确保您在深入研究实际使用之前有一个坚实的基础：</p>
<p><img src="/images/filebeat/1-min.png" /></p>
<p>要了解 Filebeat 的工作原理，主要需要熟悉以下组件：</p>
<ul>
<li><strong>收割机(Harvesters)</strong>，收割机负责逐行读取文件的内容。当
Filebeat
配置为监控特定日志文件时，会为每个文件启动一个收集器。这些收割机不仅可以读取日志数据，还可以管理打开和关闭文件。通过逐行增量读取文件，收集器可确保有效地收集新附加的日志数据并转发以进行处理。</li>
<li><strong>输入(Inputs)</strong>：输入充当收割机和数据源之间的桥梁。他们负责管理收割机并找到
Filebeat
需要从中读取日志数据的所有来源。可以为各种源（例如日志文件、容器或系统日志）配置输入。用户可以通过定义输入来指定
Filebeat 应监控的文件或位置。</li>
</ul>
<p>Filebeat
读取日志数据后，日志事件将进行转换或使用数据进行扩充。最后发送到指定的目的地。</p>
<p>可以在 <code>filebeat.yml</code> 配置文件中指定以下行为：</p>
<blockquote>
<p>我们可以在下载的目录中看到有一个 <code>filebeat.yml</code>
的配置文件。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line">  <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="attr">output.plugin_name:</span></span><br><span class="line">   <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br></pre></td></tr></table></figure>
<p>现在让我们详细研究每个部分：</p>
<ul>
<li><code>filebeat.inputs</code>：Filebeat 实例应监控的输入源。</li>
<li><code>processors</code>：在将数据发送到输出之前对其进行扩充、修改或筛选。</li>
<li><code>output.plugin_name</code>：Filebeat
应转发日志数据的输出目标。</li>
</ul>
<p>这些指令中的每一个都要求您指定一个执行其相应任务的插件。</p>
<p>现在，让我们来探讨一些可以与 Filebeat
一起使用的输入、处理器和输出。</p>
<h2 id="filebeat-输入插件">Filebeat 输入插件</h2>
<p>Filebeat
提供了一系列输入插件，每个插件都经过定制，用于从特定来源收集日志数据：</p>
<ul>
<li><code>container</code>：收集容器日志。</li>
<li><code>filestream</code>：主动从日志文件中读取行。</li>
<li><code>syslog</code>：从 Syslog 中获取日志条目。</li>
<li><code>httpjson</code>：从 RESTful API 读取日志消息。</li>
</ul>
<h2 id="filebeat-输出插件">Filebeat 输出插件</h2>
<p>Filebeat
提供了多种输出插件，使您能够将收集的日志数据发送到不同的目的地：</p>
<ul>
<li><code>File</code>：将日志事件写入文件。</li>
<li><code>Elasticsearch</code>：使 Filebeat 能够使用其 HTTP API
将日志转发到 Elasticsearch。</li>
<li><code>Kafka</code>：将日志记录下发给 Apache Kafka。</li>
<li><code>Logstash</code>：直接向 Logstash 发送日志。</li>
</ul>
<h2 id="filebeat-模块插件">Filebeat 模块插件</h2>
<p>Filebeat
通过其模块简化日志处理，提供专为特定日志格式设计的预配置设置。这些模块使您能够毫不费力地引入、解析和丰富日志数据，而无需进行大量手动配置。以下是一些可以显著简化日志处理工作流程的可用模块：</p>
<ul>
<li>Logstash</li>
<li>AWS</li>
<li>PostgreSQL</li>
<li>Nginx</li>
<li>RabbitMQ</li>
<li>HAproxy</li>
</ul>
<h2 id="filebeat-入门">Filebeat 入门</h2>
<p>现在您已经了解了 Filebeat
的工作原理，让我们将其配置为从文件中读取日志条目并将其显示在控制台上。</p>
<p>首先，打开位于解压目录的 Filebeat 配置文件
<code>filebeat.yml</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>接下来，清除文件的现有内容，并将其替换为以下代码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/logify/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在本节 <code>filebeat.inputs</code> 中，您指定 Filebeat 应使用
<code>logs</code> 插件从文件中读取日志。<code>paths</code> 参数指示
Filebeat 将监控的日志文件的路径，此处设置为
<code>/var/log/logify/app.log</code>。</p>
<p><code>output.console</code>
部分将收集到的日志数据发送到控制台。<code>pretty: true</code>
参数可确保日志条目在控制台上显示时以可读且结构良好的格式显示。</p>
<p>添加这些配置后，保存文件。</p>
<p>在执行 Filebeat 之前，必须验证配置文件语法以识别和纠正任何错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml test config</span><br></pre></td></tr></table></figure>
<p>如果配置文件正确，则应看到以下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Config OK</span><br></pre></td></tr></table></figure>
<p>现在，继续运行 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>当 Filebeat 开始运行时，它将显示类似于以下内容的日志条目：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:35:34.696Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2875279</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;status\&quot;: 200, \&quot;ip\&quot;: \&quot;127.0.0.1\&quot;, \&quot;level\&quot;: 30, \&quot;emailAddress\&quot;: \&quot;user@mail.com\&quot;, \&quot;msg\&quot;: \&quot;Task completed successfully\&quot;, \&quot;pid\&quot;: 6512, \&quot;timestamp\&quot;: 1709343333&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;310a7b92-f2fb-42ca-b3d8-e32e348c7a57&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Filebeat 现在在控制台中显示日志消息。Bash 脚本中的日志事件位于
<code>message</code> 字段下，Filebeat
添加了其他字段以提供上下文。您现在可以通过按 <code>CTRL + C</code> 停止
Filebeat。</p>
<p>成功配置 Filebeat
以读取日志并将其转发到控制台后，下一节将重点介绍数据转换。</p>
<h2 id="使用-filebeat-转换日志">使用 Filebeat 转换日志</h2>
<p>当 Filebeat
收集数据时，您可以在将其发送到输出之前对其进行处理。您可以使用新字段来丰富它，解析数据，以及删除或编辑敏感字段以确保数据隐私。</p>
<p>在本部分中，你将通过以下方式转换日志：</p>
<ul>
<li>解析 JSON 日志。</li>
<li>删除不需要的字段。</li>
<li>添加新字段。</li>
<li>屏蔽敏感数据。</li>
</ul>
<h2 id="使用-filebeat-解析-json-日志">使用 Filebeat 解析 JSON 日志</h2>
<p>由于演示日志记录应用程序以 JSON
格式生成日志，因此必须正确解析它们以进行结构化分析。</p>
<p>让我们检查上一节中的示例日志事件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  &quot;message&quot;: &quot;&#123;\&quot;status\&quot;: 200, \&quot;ip\&quot;: \&quot;127.0.0.1\&quot;, \&quot;level\&quot;: 30, \&quot;emailAddress\&quot;: \&quot;user@mail.com\&quot;, \&quot;msg\&quot;: \&quot;Task completed successfully\&quot;, \&quot;pid\&quot;: 6512, \&quot;timestamp\&quot;: 1709343333&#125;&quot;,</span><br><span class="line">  &quot;input&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;log&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>要将日志事件解析为有效的 JSON，请打开 Filebeat 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>然后，使用以下代码行更新文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/logify/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码片段中，您将处理器配置为 <code>decode_json_fields</code>
解码每个日志条目 <code>message</code> 字段中的 JSON
编码数据，并将其附加到日志事件。</p>
<p>保存并退出文件。使用以下命令重新运行 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>如果配置文件正确，则应看到以下输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:43:07.367Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;status\&quot;: 200, \&quot;ip\&quot;: \&quot;127.0.0.1\&quot;, \&quot;level\&quot;: 30, \&quot;emailAddress\&quot;: \&quot;user@mail.com\&quot;, \&quot;msg\&quot;: \&quot;Initialized application\&quot;, \&quot;pid\&quot;: 6512, \&quot;timestamp\&quot;: 1709343785&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f33a1fc6-e8f1-4dde-8740-5f85a1e8bcfd&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709343785</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2898143</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;emailAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@mail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在输出中，您将看到 <code>message</code> 字段中的所有属性（如
<code>msg</code>、 <code>ip</code> 等）都已添加到日志事件中。</p>
<p>现在，您可以解析 JSON 日志，您将修改日志事件的属性。</p>
<h2 id="使用-filebeat-添加和删除字段">使用 Filebeat 添加和删除字段</h2>
<p>日志事件包含需要保护的敏感 <code>emailAddress</code>
字段。在本部分中，你将删除该 <code>emailAddress</code>
字段，并向日志事件添加一个新字段，以提供更多上下文。</p>
<p>打开 Filebeat 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>添加以下行以修改日志事件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/logify/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;emailAddress&quot;</span>, <span class="string">&quot;message&quot;</span>]  </span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">&quot;environment&quot;</span>  <span class="comment"># Add a new &#x27;env&#x27; field set to &quot;development&quot;</span></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>若要修改日志事件，请添加 <code>drop_fields</code>
处理器，该处理器具有一个 <code>field</code>
选项，用于获取要删除的字段列表，包括敏感 <code>EmailAddress</code>
字段和 <code>message</code> 字段。删除 <code>message</code>
字段是因为在分析数据后，<code>message</code>
字段的属性已合并到日志事件中，从而使原始 <code>message</code>
字段过时。</p>
<p>编写代码后，保存并退出文件。然后，重新启动 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>运行 Filebeat 时，您会注意到该 <code>emailAddress</code>
字段已被成功删除，并且已将一个新 <code>env</code>
字段添加到日志事件中：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:47:33.907Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2911714</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Operation finished&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709344053</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;environment&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;607c49c8-9339-4851-b8e6-caab3bf6138b&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>现在，您可以扩充和删除不需要的字段，接下来将编写条件语句。</p>
<h2 id="在-filebeat-中使用条件语句">在 Filebeat 中使用条件语句</h2>
<p>Filebeat 允许您检查条件，并在条件计算结果为 <code>true</code>
时添加字段。在本节中，您将检查该 <code>status</code> 值是否等于
<code>true</code> ，如果满足条件，您将向日志事件添加一个
<code>is_successful</code> 字段。</p>
<p>为此，请打开配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>之后，添加突出显示的行以根据指定条件添加 <code>is_successful</code>
字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;emailAddress&quot;</span>]  <span class="comment"># Remove the &#x27;emailAddress&#x27; field</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">&quot;environment&quot;</span>  <span class="comment"># Add a new &#x27;env&#x27; field set to &quot;development&quot;</span></span><br><span class="line">  <span class="comment"># 如果 status 字段的值为 200，则添加 is_successful 字段</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="attr">equals:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">is_successful:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>该 <code>when</code> 选项检查 <code>status</code> 字段值是否等于
<code>200</code>。如果为 <code>true</code>，则将该
<code>is_successful</code> 字段添加到日志事件中。</p>
<p>保存新更改后，启动 Filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c ./filebeat.yml</span><br></pre></td></tr></table></figure>
<p>Filebeat 将生成与此内容密切相关的输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:50:31.697Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;environment&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20cca3c1-6ba3-4a78-8e0e-cb07bdb885f1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_successful&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Task completed successfully&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2920724</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709344231</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在输出中，该 <code>is_successful</code> 字段已添加到日志条目中，HTTP
状态代码为 <code>200</code>。</p>
<p>这负责根据条件添加新字段。</p>
<h2 id="使用-filebeat-编辑敏感数据">使用 Filebeat 编辑敏感数据</h2>
<p>在本文前面，您删除了 <code>emailAddress</code>
字段以确保数据隐私。但是，IP
地址敏感字段仍保留在日志事件中。此外，组织内的其他开发人员可能会无意中将敏感数据添加到日志事件中。通过编辑与特定模式匹配的数据，您可以屏蔽任何敏感信息，而无需删除整个字段，从而确保保留消息的重要性。</p>
<p>在文本编辑器中，打开 Filebeat 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml</span><br></pre></td></tr></table></figure>
<p>添加以下代码以编辑 IP 地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">script:</span></span><br><span class="line">      <span class="attr">lang:</span> <span class="string">javascript</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">redact-sensitive-info</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        function process(event) &#123;</span></span><br><span class="line"><span class="string">            // Redact IP addresses (e.g., 192.168.1.1) from the &quot;message&quot; field</span></span><br><span class="line"><span class="string">            event.Put(&quot;message&quot;, event.Get(&quot;message&quot;).replace(/\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b/g, &quot;[REDACTED-IP]&quot;));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">      <span class="attr">fields:</span> [<span class="string">&quot;emailAddress&quot;</span>]  <span class="comment"># Remove the &#x27;emailAddress&#x27; field</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">&quot;environment&quot;</span>  <span class="comment"># Add a new &#x27;env&#x27; field set to &quot;development&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_fields:</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="attr">equals:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="string">is_successful</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>在添加的代码中，您将定义一个用 JavaScript
编写的脚本，用于编辑日志事件中的敏感信息。该脚本使用正则表达式来标识 IP
地址，并分别将它替换为 <code>[REDACTED-IP]</code>。</p>
<p>添加代码后，运行 Filebeat：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./filebeat</span> <span class="string">-c</span> <span class="string">./filebeat.yml</span></span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-02T01:53:50.792Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">2930777</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/logify/app.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">6512</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;environment&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Initialized application&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_successful&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f177dd40-1249-487c-b9da-aaab03cfd05c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rubys-iMac.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.12.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8bf595e9-0376-42ec-be51-42a104527449&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1709344429</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[REDACTED-IP]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>输出中的日志事件现在将 IP 地址替换为 <code>[REDACTED-IP]</code>。</p>
<blockquote>
<p>注意：上面的脚本会将 <code>message</code> 中的所有 IP
地址都替换。</p>
</blockquote>
<p>您现在可以停止 Filebeat 和 <code>logify.sh</code> 程序。</p>
<p>若要停止 bash 脚本，请获取进程 ID：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jobs -l | grep &quot;logify&quot;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1]  + 6512 running    ./logify.sh</span><br></pre></td></tr></table></figure>
<p>替换 <code>kill</code> 命令中的进程 ID：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 &lt;6512&gt;</span><br></pre></td></tr></table></figure>
<p>成功编辑敏感字段后，您现在可以使用 Filebeat 从 Docker
容器收集日志，并将它们集中起来以进行进一步的分析和监控。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了 Filebeat
的基本概念和工作原理。我们还演示了如何配置 Filebeat
以收集日志，并使用处理器对日志事件进行转换。我们还讨论了 Filebeat
的输入、输出和模块插件，以及如何使用条件语句和脚本处理器来编辑日志事件。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/03/01/log/Filebeat_vs_Logstash%20%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%B7%A5%E5%85%B7%E5%AF%B9%E6%AF%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/01/log/Filebeat_vs_Logstash%20%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%B7%A5%E5%85%B7%E5%AF%B9%E6%AF%94/" class="post-title-link" itemprop="url">Filebeat vs Logstash：日志采集工具对比</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-01 20:28:30" itemprop="dateCreated datePublished" datetime="2024-03-01T20:28:30+08:00">2024-03-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Filebeat 和 Logstash 均由 Elastic 开发，是 Elastic Stack
不可或缺的组件，它们都充当日志收集器，具有不同的特性和功能。Logstash 是
ELK
Stack（Elasticsearch、Logstash、Kibana）的原始组件，旨在高效地从多个来源收集大量日志并将其分发到不同的目的地。</p>
<p>虽然 Logstash
越来越受欢迎，但由于资源密集型操作，尤其是在资源有限的系统上，它面临着挑战。为了解决这个问题，Elastic
推出了 Filebeat 作为 Beats 系列的一部分，为 Logstash
提供了轻量级的替代品。这一新增导致 ELK Stack 更名为 Elastic
Stack，以更好地涵盖包括 Beats 在内的不断增长的工具套件。Filebeat
旨在补充 Logstash，但随着时间的推移演变成一个独立的日志收集器。</p>
<p>因此，鉴于这两个日志收集器的独特优势和功能，在这两个日志收集器之间做出决定可能是一项艰巨的任务。本文将比较
Filebeat 和
Logstash，探讨它们的优缺点，并提供有关何时选择其中一种的见解。</p>
<h2 id="什么是-filebeat">什么是 Filebeat？</h2>
<p>Filebeat 是由 Elastic 开发的免费开源日志收集器，是 Elastic Stack 中
beats
系列的一部分。这套工具对于收集和传送各种类型的数据（如日志、指标和网络信息）至关重要。Filebeat
最初主要设计用于 Logstash，但随着时间的推移，随着 Elastic
对其日志处理能力的不断更新，Filebeat 已经超越了这一点。</p>
<p>此外，Filebeat
具有各种内置输入和输出，可满足不同的来源和目标。如果这些内置选项不符合特定要求，它还允许创建自定义插件。Filebeat
还包括内部模块，用于从广泛使用的工具（如 NGINX、Apache、系统日志和
MySQL）收集和解析日志。</p>
<p>Filebeat
因其轻量级设计、可靠性和稳健性而受到重视。它支持加密数据传输，并使用背压敏感协议，这在处理大量数据时很有用。此功能使其能够调整其数据传输速率，防止目的地过载。</p>
<p><img src="/images/log/1.png" /></p>
<h2 id="什么是-logstash">什么是 Logstash？</h2>
<p>Logstash 是由 Elastic
创建的免费开源数据管道工具。它旨在有效地收集、处理日志并将其发送到各种目标。Logstash
以其灵活性而闻名，提供多个输入、过滤器和输出，使其能够适应不同的日志处理需求。它擅长过滤、解析和转换日志，提供高级日志处理能力。</p>
<p>作为 Elastic Stack 的关键组件，Logstash 可与 Beats、Elasticsearch 和
Kibana 等其他工具无缝协作。它从各种来源提取数据并将其推送到
Elasticsearch，然后转发到 Kibana 进行分析和可视化。</p>
<p>Logstash 拥有超过 200 个插件，并提供了一个
API，用于创建满足特定用户需求的自定义插件。Logstash
的一个显著特点是其可靠性，它由一个持久队列支撑，该队列在传输日志事件时保存日志事件。在事件发送失败的情况下，Logstash
可以将其重新路由到另一个队列进行进一步检查和重新处理。</p>
<p><img src="/images/log/2.png" /></p>
<p>现在我们已经对 Filebeat 和 Logstash
有了基本的了解，让我们来比较一下这两个工具。我们的比较将重点关注以下关键标准：</p>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 37%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">特征</th>
<th style="text-align: center;">Filebeat</th>
<th style="text-align: center;">Logstash</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">支持的平台</td>
<td style="text-align: center;">跨平台</td>
<td style="text-align: center;">跨平台</td>
</tr>
<tr class="even">
<td style="text-align: center;">内存使用率/性能</td>
<td style="text-align: center;">轻量级</td>
<td style="text-align: center;">利用大量内存</td>
</tr>
<tr class="odd">
<td style="text-align: center;">生态系统和插件</td>
<td style="text-align: center;">少于 60 个插件</td>
<td style="text-align: center;">超过 200 个插件</td>
</tr>
<tr class="even">
<td style="text-align: center;">日志解析</td>
<td style="text-align: center;">具有内置解析器和模块</td>
<td style="text-align: center;">具有更强大的解析器</td>
</tr>
<tr class="odd">
<td style="text-align: center;">事件路由</td>
<td style="text-align: center;">不支持</td>
<td style="text-align: center;">使用条件语句路由日志</td>
</tr>
<tr class="even">
<td style="text-align: center;">传输</td>
<td style="text-align: center;">缓冲日志事件并具有持久性队列</td>
<td style="text-align: center;">缓冲日志事件并具有持久性队列</td>
</tr>
<tr class="odd">
<td style="text-align: center;">UI &amp; UX</td>
<td style="text-align: center;">没有 UI，但可以与 Kibana 集成</td>
<td style="text-align: center;">没有 UI，但可以与 Kibana 集成</td>
</tr>
</tbody>
</table>
<h2 id="支持的平台">1. 支持的平台</h2>
<p>Filebeat 是使用 Go 开发的，Go
是一种以创建高性能网络和基础设施程序而闻名的现代语言。其设计允许
Filebeat
以较低的内存占用量收集、处理和转发日志。此外，它的兼容性跨越各种平台，包括
Linux、Windows、MacOS，甚至容器化环境。</p>
<p>另一方面，Logstash 是使用 JRuby 构建的，JRuby 是 Java 中 Ruby
编程语言的高性能实现。要运行 Logstash，需要 Java 虚拟机 （JVM）。JVM
的跨平台兼容性确保 Logstash 可以在各种系统上运行，包括 Linux、Windows 和
MacOS。这使得 Logstash 在平台支持方面同样通用。</p>
<p>考虑到支持的平台，Filebeat 和 Logstash
都表现出很强的适应性，使其成为跨平台支持的绝佳选择。</p>
<h2 id="内存使用率性能filebeat-获胜">2. 内存使用率/性能：Filebeat
获胜</h2>
<p>Filebeat
旨在专注于轻量级效率，使其能够处理大量数据，同时保持最小的内存消耗。Filebeat
的单个实例通常使用不到 2MB 的内存，并使用不到 30% 的
CPU。如前所述，这种非凡的效率主要归功于它在 Go 中的发展。</p>
<p>此外，Filebeat
还具有负载平衡和故障转移功能，这对于确保一致的日志数据检索和转发至关重要，尤其是在高流量场景中。</p>
<p>相比之下，Logstash
需要的内存占用要高得多。根据官方文档，为了有效运行，它需要一个至少具有
2GB 内存的主机，建议的内存分配约为 4GB。这种需求的增加源于 Logstash 对
Java 虚拟机 （JVM）
及其复杂的日志处理功能的依赖，这自然会消耗更多的资源。虽然 Logstash
确实包含负载平衡和故障转移功能以实现可靠的日志处理，但其较高的资源要求使其不太适合内存和
CPU 使用率是关键限制的环境。</p>
<p>总之，对于性能和可扩展性至关重要且内存使用率至关重要的环境，Filebeat
是更有利的选择，因为它具有更低的内存占用和高效的资源利用率。</p>
<h2 id="生态系统和插件logstash-获胜">3. 生态系统和插件：Logstash
获胜</h2>
<p>Filebeat 专注于轻量级和高效，仍然提供包含 60
多个插件的大量库。这些插件涵盖了各种输入和输出，包括 AWS
S3、Kafka、Redis 和
File。这些插件的全面详细信息可以在文档中的详细输入和输出页面上找到。对于那些熟练使用
Go 的人来说，Filebeat
还允许创建自定义插件，为特定用例提供灵活性。此外，Filebeat
的模块简化了从 MySQL 或 Nginx
等流行工具读取日志的过程，增强了其易用性。</p>
<p>另一方面，Logstash 拥有丰富的插件生态系统，数量超过 200
个，分为输入、输出、过滤器和编解码器。这些插件大多是内置的，构成了
Logstash 高级日志处理能力的基础。广泛使用的插件包括 Grok
过滤器插件，它使用正则表达式解析日志，以及 GeoIP 过滤器，它为 IP
地址生成地理信息。</p>
<p>为 Logstash 创建自定义插件非常简单，官方文档提供了全面的指导。</p>
<p>由于其广泛的插件生态系统，Logstash
在需要高级数据处理的场景中成为明显的赢家。</p>
<h2 id="日志解析logstash-获胜">4. 日志解析：Logstash 获胜</h2>
<p>在日志解析方面，Filebeat 和 Logstash
都展示了高级日志解析功能，集成了能够处理结构化和非结构化日志的内置插件。</p>
<p>Filebeat 通过使用可用的处理器增强了其解析功能，能够解析 JSON 和 CSV
等标准格式。此外，内部模块使 Filebeat 能够解析来自 Nginx、MySQL 或
Apache 等来源的流行格式。</p>
<p>同样，Logstash 提供了强大的解析器和内置功能。Logstash
的与众不同之处在于包含
Grok，它使用正则表达式将日志事件与特定模式进行匹配。Grok 具有 200
多种预定义模式，能够解析来自不同来源（如 MongoDB、Postgres 和
AWS）的结构化和非结构化日志，并灵活地定义用于解析自定义日志格式的模式。</p>
<p>在日志解析方面，Filebeat 适合处理标准日志格式，而 Logstash
则凭借强大的解析功能脱颖而出。</p>
<h2 id="事件路由logstash-获胜">5. 事件路由：Logstash 获胜</h2>
<p>事件路由是一个过程，其中日志事件根据条件或每个日志事件中的内容定向到特定目标。这意味着您可以设置规则，根据每个日志包含的数据确定应将每个日志发送到何处。例如，您可以将日志收集器配置为将
HTTP 状态代码为 200 的所有日志事件发送到远程位置，而将状态代码为 400
的日志事件写入特定文件。</p>
<p>Filebeat
虽然在日志收集方面很高效，但并非设计为事件路由。它通常会将所有收集的日志转发到单个端点（通常是
Logstash），这与其原始设计目的一致。因此，在需要将日志从多个来源分发到不同目标的场景中，Filebeat
的功能会受到限制。</p>
<p>另一方面，Logstash
在事件路由方面表现出卓越的熟练程度。它支持使用条件语句（如
<code>if-then-else</code> ）将日志事件路由到多个目标。这些条件允许
Logstash 根据特定条件评估日志事件并相应地指导它们。</p>
<p>鉴于事件路由在根据特定需求定制日志分发方面的重要性，Logstash
在这方面的表现优于 Filebeat。</p>
<h2 id="传输">6. 传输</h2>
<p>在传输数据方面，Filebeat 和 Logstash
不相上下，它们都提供有效的输出插件，用于从各种来源收集日志并将其传送到多个目的地，包括云存储、Kafka、AWS
和本地文件。</p>
<p>这两种工具的一个关键特性是它们使用内存中队列来缓冲日志事件。此功能对于管理日志数据中的峰值和临时存储日志以防止数据输出过载至关重要。内存中队列在重新发送可能由于输出目标问题而无法传输的日志事件方面也发挥着作用。</p>
<p>在意外中断或过早退出时，存在丢失存储在这些内存中队列中的日志事件的风险。但是，Filebeat
和 Logstash
通过提供为持久性数据存储配置磁盘队列的选项来降低这种风险。这种额外的弹性层确保了工具可以无缝地恢复其操作，在突然关闭时从中断的地方继续运行。</p>
<p>需要注意的是，尽管 Logstash 和 Filebeat
具有持久队列，但偶尔会发生故障，尤其是在处理大量数据时。为了缓解这种情况，建议使用专用工具（如
Kafka）从日志收集器中卸载负载。该工具充当临时数据持久层，为日志管理基础结构增加了额外的弹性和稳定性。</p>
<p>考虑到它们在数据传输方面的能力，Filebeat 和 Logstash
都比对方具有明显的优势。两者都可以可靠地传输和持久化数据。</p>
<h2 id="什么时候应该使用-filebeat-或-logstash">什么时候应该使用 Filebeat
或 Logstash ？</h2>
<p>在 Filebeat 和 Logstash 之间做出决定取决于您的特定日志管理需求。</p>
<p>当您的主要需求是从各种来源收集日志并将其定向到 Elasticsearch
或云存储等单一目标时，Filebeat
是一个理想的选择。其他理想的情况是，您的日志需要基本解析，例如处理 Nginx
日志或管理不需要复杂处理的 syslog 输入。</p>
<p><img src="/images/log/3.png" /></p>
<p>另一方面，如果您正在处理需要复杂操作、扩充或过滤的半结构化或非结构化日志，那么
Logstash
更合适。当您的目标是将日志事件路由到多个目标时，它也是首选工具。</p>
<p><img src="/images/log/4.png" /></p>
<p>更有效的策略是结合使用 Filebeat 和
Logstash，特别是用于管理来自不同来源的日志。通常，由于 Filebeat
的效率，您可以使用 Filebeat 来收集日志。然后，收集的日志将转发到
Logstash 进行更复杂的处理。Logstash
可以配置为将日志分发到不同的目的地，或者将它们转发到 Elasticsearch
进行索引，然后转发到 Kibana 进行可视化。这种组合方法有效地利用了
Filebeat 和 Logstash 的优势。</p>
<p><img src="/images/log/5.png" /></p>
<p>有关更具可伸缩性的设置，请参阅下图：</p>
<p><img src="/images/log/6.png" /></p>
<h3 id="实例">实例</h3>
<p>让我们看一个使用 Elastic Stack 的实际示例，并考虑 Filebeat 和
Logstash 如何协同工作来管理和处理日志。</p>
<p>假设您有以下格式的 Nginx 日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">203.0.113.1 - - [14/Jan/2022:08:30:45 +0000] &quot;GET /example-page HTTP/1.1&quot; 200 1024 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&quot;</span><br></pre></td></tr></table></figure>
<p>以下是使用 Filebeat 和 Logstash 处理这些日志的方法：</p>
<ol type="1">
<li>使用 Filebeat：首先，使用 Filebeat 从 Nginx 收集日志。Filebeat
可以配置 Nginx 模块，该模块旨在解析 Nginx 日志。</li>
<li>转发到 Logstash：收集和初始解析后，配置 Filebeat 将这些日志发送到
Logstash。</li>
<li>在 Logstash 中处理：在 Logstash
中，您可以对日志进行高级操作。这包括提取特定字段、设置日期格式、编辑 IP
地址、重命名字段和其他所需的转换。</li>
<li>发送到 Elasticsearch 和 Kibana：处理完成后，Logstash 会将日志转发到
Elasticsearch 进行索引。索引后，可以在 Kibana
中对数据进行可视化和分析。</li>
</ol>
<p>此工作流程演示了 Filebeat 和 Logstash
如何无缝协作。此设置对于处理需要简单和复杂处理和可视化过程的日志非常方便。</p>
<h2 id="结论">结论</h2>
<p>在本文中，我们比较了 Filebeat 和
Logstash，展示了每种工具如何满足不同的需求。</p>
<p>Filebeat
是一个轻量级选项，非常适合资源有限且需要基本日志解析的环境。相反，Logstash
是为需要高级日志处理的场景量身定制的。</p>
<p>同时使用这两种工具也可以具有战略意义，以获得两全其美的优势。使用
Filebeat 收集日志并将其转发到 Logstash
进行高级转换提供了一种平衡的方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://eleven26.github.io/2024/02/20/golang/Golang%20%E4%BD%BF%E7%94%A8%20Zookeeper%20%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="eleven26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="eleven26">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | eleven26">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/20/golang/Golang%20%E4%BD%BF%E7%94%A8%20Zookeeper%20%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">Golang 使用 Zookeeper 实现分布式锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-20 20:28:30" itemprop="dateCreated datePublished" datetime="2024-02-20T20:28:30+08:00">2024-02-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是分布式锁">什么是分布式锁？</h2>
<p>分布式锁是一种在分布式系统中用于控制并发访问的机制。在分布式系统中，多个客户端可能会同时对同一个资源进行访问，这可能导致数据不一致的问题。分布式锁的作用是确保同一时刻只有一个客户端能够对某个资源进行访问，从而避免数据不一致的问题。</p>
<p>分布式锁的实现通常依赖于一些具有分布式特性的技术，如
<code>ZooKeeper</code>、<code>Redis</code>、数据库等。这些技术提供了在分布式环境中实现互斥访问的机制，使得多个客户端在竞争同一个资源时能够有序地进行访问。</p>
<p>通过使用分布式锁，可以确保分布式系统中的数据一致性和并发访问的有序性，从而提高系统的可靠性和稳定性。</p>
<h2 id="zookeeper-与-redis-的分布式锁对比">Zookeeper 与 Redis
的分布式锁对比</h2>
<p><code>ZooKeeper</code> 和 <code>Redis</code>
都是常用的实现分布式锁的工具，但它们在实现方式、特性、适用场景等方面有一些区别。以下是
<code>ZooKeeper</code> 分布式锁与 <code>Redis</code>
分布式锁的比较：</p>
<h3 id="实现方式">实现方式</h3>
<ul>
<li><code>ZooKeeper</code>
分布式锁主要依赖于其临时节点和顺序节点的特性。客户端在
<code>ZooKeeper</code>
中创建临时顺序节点，并通过监听机制来实现锁的获取和释放。</li>
<li><code>Redis</code> 分布式锁通常使用
<code>SETNX（set if not exists)</code> 命令来尝试设置一个
<code>key</code>，如果设置成功则获取到锁。也可以通过设置过期时间和轮询机制来防止死锁和提高锁的可靠性。</li>
</ul>
<h3 id="特性">特性</h3>
<ul>
<li><code>ZooKeeper</code>
分布式锁具有严格的顺序性和公平性，保证了锁的获取顺序与请求顺序一致，避免了饥饿问题。</li>
<li><code>Redis</code>
分布式锁的性能通常更高，因为它是一个内存数据库，读写速度非常快。然而，它可能存在不公平性和死锁的风险，需要额外的机制来避免这些问题。</li>
</ul>
<h3 id="适用场景">适用场景</h3>
<ul>
<li><code>ZooKeeper</code>
分布式锁适用于对顺序性和公平性要求较高的场景，如分布式调度系统、分布式事务等。</li>
<li><code>Redis</code>
分布式锁适用于对性能要求较高的场景，如缓存系统、高并发访问的系统等。<code>Redis</code>
的高性能使得它在处理大量并发请求时具有优势。</li>
</ul>
<h3 id="可靠性">可靠性</h3>
<ul>
<li><code>ZooKeeper</code> 分布式锁具有较高的可靠性，因为它依赖于
<code>ZooKeeper</code>
的高可用性和强一致性保证。即使部分节点宕机，<code>ZooKeeper</code>
也能保证锁的正确性和一致性。</li>
<li><code>Redis</code>
分布式锁的可靠性取决于其实现方式和配置。在某些情况下，如
<code>Redis</code>
节点宕机或网络故障，可能会导致锁失效或死锁。因此，需要合理配置
<code>Redis</code> 和采取额外的措施来提高锁的可靠性。</li>
</ul>
<p>综上所述，<code>ZooKeeper</code> 分布式锁和 <code>Redis</code>
分布式锁各有优缺点，具体选择哪种方式取决于实际业务场景和需求。在需要保证顺序性和公平性的场景下，<code>ZooKeeper</code>
分布式锁可能更适合；而在需要高性能和快速响应的场景下，<code>Redis</code>
分布式锁可能更合适。</p>
<h2 id="为什么-zookeeper-可以实现分布式锁">为什么 Zookeeper
可以实现分布式锁</h2>
<p><code>ZooKeeper</code>
可以实现分布式锁，主要得益于其以下几个特性：</p>
<ol type="1">
<li>临时节点：<code>ZooKeeper</code>
支持创建临时节点，这些节点在创建它们的客户端会话结束时会被自动删除。这种特性使得
<code>ZooKeeper</code>
的节点具有生命周期，可以随着客户端的存活而存在，客户端断开连接后自动消失，非常适合作为锁的标识。</li>
<li>顺序节点：<code>ZooKeeper</code>
的另一个重要特性是支持创建顺序节点。在创建节点时，<code>ZooKeeper</code>
会在节点名称后自动添加一个自增的数字，确保节点在 <code>ZNode</code>
中的顺序性。这个特性使得 <code>ZooKeeper</code>
可以实现分布式锁中的公平锁，按照请求的顺序分配锁。</li>
<li><code>Watcher</code> 机制：<code>ZooKeeper</code> 还提供了
<code>Watcher</code>
机制，允许客户端在指定的节点上注册监听事件。当这些事件触发时，<code>ZooKeeper</code>
服务端会将事件通知到感兴趣的客户端，从而允许客户端做出相应的措施。这种机制使得
<code>ZooKeeper</code>
的分布式锁可以实现阻塞锁，即当客户端尝试获取已经被其他客户端持有的锁时，它可以等待锁被释放。</li>
</ol>
<p>基于以上特性，<code>ZooKeeper</code>
可以实现分布式锁。具体实现流程如下：</p>
<ol type="1">
<li>客户端需要获取锁时，在 <code>ZooKeeper</code>
中创建一个临时顺序节点作为锁标识。</li>
<li>客户端判断自己创建的节点是否是所有临时顺序节点中序号最小的。如果是，则客户端获得锁；如果不是，则客户端监听序号比它小的那个节点。</li>
<li>当被监听的节点被删除时（即持有锁的客户端释放锁），监听者会收到通知，然后重新判断自己是否获得锁。</li>
<li>当客户端释放锁时，只需要将会话关闭，临时节点就会被自动删除，从而释放了锁。</li>
</ol>
<p>因此，<code>ZooKeeper</code> 通过其临时节点、顺序节点和
<code>Watcher</code> 机制等特性，实现了分布式锁的功能。</p>
<h2 id="使用-golang-实现-zookeeper-分布式锁">使用 Golang 实现 Zookeeper
分布式锁</h2>
<p>下面我们通过一个简单的例子来演示如何使用 <code>Golang</code> 实现
<code>ZooKeeper</code> 分布式锁。</p>
<h3 id="创建-zookeeper-客户端连接">创建 zookeeper 客户端连接</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/go-zookeeper/zk&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">client</span><span class="params">()</span></span> *zk.Conn &#123;</span><br><span class="line">    <span class="comment">// 默认端口 2181</span></span><br><span class="line">	c, _, err := zk.Connect([]<span class="type">string</span>&#123;<span class="string">&quot;192.168.2.168&quot;</span>&#125;, time.Second)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建父节点---lock">创建父节点 - /lock</h3>
<p>我们可以在获取锁之前，先创建一个父节点，用于存放锁节点。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Lock <span class="keyword">struct</span> &#123;</span><br><span class="line">	c *zk.Conn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父节点 /lock 不存在的时候进行创建</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLock</span><span class="params">()</span></span> *Lock &#123;</span><br><span class="line">	c := client()</span><br><span class="line">	e, _, err := c.Exists(<span class="string">&quot;/lock&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !e &#123;</span><br><span class="line">		_, err := c.Create(<span class="string">&quot;/lock&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;&quot;</span>), <span class="number">0</span>, zk.WorldACL(zk.PermAll))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Lock&#123;c: c&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取锁">获取锁</h3>
<p>在 Zookeeper
分布式锁实现中，获取锁的过程实际上就是创建一个临时顺序节点，并判断自己是否是所有临时顺序节点中序号最小的。</p>
<p>获取锁的关键是：</p>
<ol type="1">
<li>创建的需要是临时节点</li>
<li>创建的需要是顺序节点</li>
</ol>
<p>具体创建代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p, err := l.c.Create(<span class="string">&quot;/lock/lock&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;&quot;</span>), zk.FlagEphemeral|zk.FlagSequence, zk.WorldACL(zk.PermAll))</span><br></pre></td></tr></table></figure>
<p>其中 <code>zk.FlagEphemeral</code>
表示创建的是临时节点，<code>zk.FlagSequence</code>
表示创建的是顺序节点。</p>
<h3
id="判断当前创建的节点是否是最小节点">判断当前创建的节点是否是最小节点</h3>
<p>具体步骤如下：</p>
<ol type="1">
<li>通过 <code>l.c.Children("/lock")</code> 获取 <code>/lock</code>
下的所有子节点</li>
<li>对所有子节点进行排序</li>
<li>判断当前创建的节点是否是最小节点</li>
<li>如果是最小节点，则获取到锁，函数调用返回；如果不是，则监听前一个节点（这会导致函数调用阻塞）</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">childs, _, err := l.c.Children(<span class="string">&quot;/lock&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// childs 是无序的，所以需要排序，以便找到当前节点的前一个节点，然后监听前一个节点</span></span><br><span class="line">sort.Strings(childs)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成功获取到锁</span></span><br><span class="line">p1 := strings.Replace(p, <span class="string">&quot;/lock/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> childs[<span class="number">0</span>] == p1 &#123;</span><br><span class="line">    <span class="keyword">return</span> p, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="不是最小节点监听前一个节点">不是最小节点，监听前一个节点</h4>
<p>具体步骤如下：</p>
<ol type="1">
<li>通过 <code>sort.SearchStrings</code>
找到当前节点在所有子节点中的位置</li>
<li>调用 <code>l.c.ExistsW</code>
判断前一个节点是否依然存在（锁有可能在调用 <code>ExistsW</code>
之前已经被释放了），如果不存在则获取到锁</li>
<li>如果前一个节点依然存在，则阻塞等待前一个节点被删除</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听锁，等待锁释放</span></span><br><span class="line"><span class="comment">// 也就是说，如果当前节点不是最小的节点，那么就监听前一个节点</span></span><br><span class="line"><span class="comment">// 一旦前一个节点被删除，那么就可以获取到锁</span></span><br><span class="line">index := sort.SearchStrings(childs, p1)</span><br><span class="line">b, _, ev, err := l.c.ExistsW(<span class="string">&quot;/lock/&quot;</span> + childs[index<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在调用 ExistsW 之后，前一个节点已经被删除</span></span><br><span class="line"><span class="keyword">if</span> !b &#123;</span><br><span class="line">    <span class="keyword">return</span> p, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待前一个节点被删除</span></span><br><span class="line">&lt;-ev</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> p, <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<p>在调用 <code>ExistsW</code> 的时候，如果前一个节点已经被删除，那么
<code>ExistsW</code> 会立即返回 <code>false</code>，否则我们可以通过
<code>ExistsW</code> 返回的第三个参数 <code>ev</code>
来等待前一个节点被删除。</p>
<p>在 <code>&lt;-ev</code> 处，我们通过 <code>&lt;-ev</code>
来等待前一个节点被删除，一旦前一个节点被删除，<code>ev</code>
会收到一个事件，这个时候我们就可以获取到锁了。</p>
<h3 id="释放锁">释放锁</h3>
<p>如果调用 <code>Lock</code>
可以成功获取到锁，我们会返回当前创建的节点的路径，我们可以通过这个路径来释放锁。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Lock)</span></span> Unlock(p <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> l.c.Delete(p, <span class="number">-1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="完整代码">完整代码</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/go-zookeeper/zk&quot;</span></span><br><span class="line">	<span class="string">&quot;sort&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">client</span><span class="params">()</span></span> *zk.Conn &#123;</span><br><span class="line">	c, _, err := zk.Connect([]<span class="type">string</span>&#123;<span class="string">&quot;192.168.2.168&quot;</span>&#125;, time.Second) <span class="comment">//*10)</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Lock <span class="keyword">struct</span> &#123;</span><br><span class="line">	c *zk.Conn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLock</span><span class="params">()</span></span> *Lock &#123;</span><br><span class="line">	c := client()</span><br><span class="line">	e, _, err := c.Exists(<span class="string">&quot;/lock&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !e &#123;</span><br><span class="line">		_, err := c.Create(<span class="string">&quot;/lock&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;&quot;</span>), <span class="number">0</span>, zk.WorldACL(zk.PermAll))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Lock&#123;c: c&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Lock)</span></span> Lock() (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	p, err := l.c.Create(<span class="string">&quot;/lock/lock&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;&quot;</span>), zk.FlagEphemeral|zk.FlagSequence, zk.WorldACL(zk.PermAll))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	childs, _, err := l.c.Children(<span class="string">&quot;/lock&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// childs 是无序的，所以需要排序，以便找到当前节点的前一个节点，然后监听前一个节点</span></span><br><span class="line">	sort.Strings(childs)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 成功获取到锁</span></span><br><span class="line">	p1 := strings.Replace(p, <span class="string">&quot;/lock/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> childs[<span class="number">0</span>] == p1 &#123;</span><br><span class="line">		<span class="keyword">return</span> p, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 监听锁，等待锁释放</span></span><br><span class="line">	<span class="comment">// 也就是说，如果当前节点不是最小的节点，那么就监听前一个节点</span></span><br><span class="line">	<span class="comment">// 一旦前一个节点被删除，那么就可以获取到锁</span></span><br><span class="line">	index := sort.SearchStrings(childs, p1)</span><br><span class="line">	b, _, ev, err := l.c.ExistsW(<span class="string">&quot;/lock/&quot;</span> + childs[index<span class="number">-1</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在调用 ExistsW 之后，前一个节点已经被删除</span></span><br><span class="line">	<span class="keyword">if</span> !b &#123;</span><br><span class="line">		<span class="keyword">return</span> p, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等待前一个节点被删除</span></span><br><span class="line">	&lt;-ev</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> p, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Lock)</span></span> Unlock(p <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> l.c.Delete(p, <span class="number">-1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试代码">测试代码</h2>
<p>下面这个例子模拟了分布式的 <code>counter</code> 操作，我们通过
<code>ZooKeeper</code> 分布式锁来保证 <code>counter</code>
的原子性。</p>
<blockquote>
<p>当然这个例子只是为了说明 <code>ZooKeeper</code>
分布式锁的使用，实际上下面的功能通过 <code>redis</code> 自身提供的
<code>incr</code> 就可以实现，不需要这么复杂。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/redis/go-redis/v9&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> count = <span class="number">1000</span></span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(count)</span><br><span class="line"></span><br><span class="line">	l := NewLock()</span><br><span class="line">    <span class="comment">// 创建 redis 客户端连接</span></span><br><span class="line">	redisClient = redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">		Addr:     <span class="string">&quot;192.168.2.168:6379&quot;</span>,</span><br><span class="line">		Password: <span class="string">&quot;&quot;</span>, <span class="comment">// no password set</span></span><br><span class="line">		DB:       <span class="number">0</span>,  <span class="comment">// use default DB</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i1 <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line"> 			<span class="comment">// 获取 Zookeeper 分布式锁</span></span><br><span class="line">			p, err := l.Lock()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 成功获取到了分布式锁：</span></span><br><span class="line">			<span class="comment">// 1. 从 redis 获取 zk_counter 的值</span></span><br><span class="line">			<span class="comment">// 2. 然后对 zk_counter 进行 +1 操作</span></span><br><span class="line">			<span class="comment">// 3. 最后将 zk_counter 的值写回 redis</span></span><br><span class="line">			cmd := redisClient.Get(context.Background(), <span class="string">&quot;zk_counter&quot;</span>)</span><br><span class="line">			i2, _ := cmd.Int()</span><br><span class="line">			i2++</span><br><span class="line">			redisClient.Set(context.Background(), <span class="string">&quot;zk_counter&quot;</span>, i2, <span class="number">0</span>)</span><br><span class="line">			<span class="comment">// 释放分布式锁</span></span><br><span class="line">			err = l.Unlock(p)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="built_in">println</span>(fmt.Errorf(<span class="string">&quot;unlock error: %v&quot;</span>, err))</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line"></span><br><span class="line">	l.c.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要将测试程序放到不同的机器上运行，这样才能模拟分布式环境。</p>
<h2 id="总结">总结</h2>
<p>最后，再来回顾一下本文内容：</p>
<ol type="1">
<li><code>sync.Mutex</code>
这种锁只能保证单进程内的并发安全，无法保证分布式环境下的并发安全。</li>
<li>使用 <code>Zookeeper</code> 和 <code>Redis</code>
都能实现分布式锁，但是 <code>Zookeeper</code> 可以保证顺序性和公平性，而
<code>Redis</code> 可以保证高性能。</li>
<li><code>Zookeeper</code> 通过其临时节点、顺序节点和
<code>Watcher</code> 机制等特性，实现了分布式锁的功能。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/70/">70</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">eleven26</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/eleven26" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
